<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NIC Islamabad | Room Booking</title>

    <!-- Cache Control Meta Tags -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <!-- App Version for Cache Busting -->
    <meta name="app-version" content="2.0.0">
    <meta name="build-timestamp" content="BUILD_TIMESTAMP_PLACEHOLDER">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: #f7f8fa;
        }

        /* Mobile Responsiveness Styles */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: -100%;
                top: 0;
                height: 100vh;
                z-index: 1000;
                transition: left 0.3s ease-in-out;
                width: 280px;
                box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            }

            .sidebar.mobile-open {
                left: 0;
            }

            .main-content {
                margin-left: 0 !important;
                width: 100% !important;
            }

            .mobile-header {
                display: flex !important;
                align-items: center;
                justify-content: space-between;
                padding: 1rem;
                background: white;
                border-bottom: 1px solid #e5e7eb;
                position: sticky;
                top: 0;
                z-index: 999;
            }

            .sidebar-overlay {
                position: fixed;
                inset: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 999;
                opacity: 0;
                animation: fadeIn 0.3s ease-in-out forwards;
            }

            @keyframes fadeIn {
                to { opacity: 1; }
            }

            /* Mobile-friendly form elements */
            .form-input-mobile {
                min-height: 44px;
                font-size: 16px; /* Prevents zoom on iOS */
            }

            /* Mobile modal adjustments */
            .modal-mobile {
                margin: 1rem;
                max-height: calc(100vh - 2rem);
                width: calc(100vw - 2rem);
            }

            /* Mobile table responsiveness */
            .table-mobile {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }

            /* Mobile card adjustments */
            .card-mobile {
                margin: 0.5rem;
                padding: 1rem;
            }

            /* Touch-friendly buttons */
            .btn-mobile {
                min-height: 44px;
                padding: 0.75rem 1rem;
                font-size: 1rem;
            }
        }

        @media (min-width: 769px) {
            .mobile-header {
                display: none !important;
            }

            .sidebar {
                position: relative !important;
                left: 0 !important;
                width: 16rem !important;
            }
        }

        /* Tablet responsiveness */
        @media (min-width: 768px) and (max-width: 1024px) {
            .sidebar {
                width: 14rem;
            }

            .main-content {
                margin-left: 14rem;
            }

            /* Tablet-specific adjustments */
            .grid-tablet-2 {
                grid-template-columns: repeat(2, 1fr);
            }

            .grid-tablet-1 {
                grid-template-columns: 1fr;
            }
        }
        :root {
            --brand-olive-dark: #3E4A39;
            --brand-olive-mid: #6A7B63;
            --brand-olive-light: #A8B8A0;
            --brand-gold: #D4AF37;
            --background-light: #F7F8FA;
            --card-bg: #FFFFFF;
            --text-dark: #1a202c;
            --text-light: #4a5568;
            --border-color: #e2e8f0;
        }
        .nav-link.active {
            background-color: rgba(62, 74, 57, 0.08);
            color: var(--brand-olive-dark);
            font-weight: 700;
            border-left: 4px solid var(--brand-olive-dark);
        }
        .page {
            animation: pageEnter 0.7s cubic-bezier(0.25, 1, 0.5, 1);
        }
        @keyframes pageEnter {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .auth-view {
            animation: authEnter 0.5s ease-out;
        }
        @keyframes authEnter {
            from { opacity: 0; transform: scale(0.98) translateY(10px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        .btn-primary {
            background-color: var(--brand-olive-dark);
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1);
        }
        .btn-primary:hover {
            background-color: var(--brand-olive-mid);
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -4px rgba(0,0,0,0.1);
        }
        .btn-primary:active {
            transform: translateY(0px);
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1);
        }
        .input-focus:focus {
            --tw-ring-color: var(--brand-olive-light);
        }

        /* Fun Animations & Effects */
        .stat-card {
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        .stat-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 8px 10px -6px rgba(0,0,0,0.1);
        }
        .calendar-day:hover {
            transform: scale(1.1);
            background-color: rgba(62, 74, 57, 0.1);
        }
        #confetti-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
            overflow: hidden;
        }
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: var(--brand-gold);
            opacity: 0;
            animation: fall 3s linear infinite;
        }
        .confetti.triangle {
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-bottom: 10px solid var(--brand-olive-light);
            background-color: transparent;
        }
        @keyframes fall {
            0% { transform: translateY(-10vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(110vh) rotate(720deg); opacity: 0; }
        }

        /* Tablet Display Styles */
        #tablet-view-container .content-wrapper {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        #password-modal > div {
             animation: modalEnter 0.3s cubic-bezier(0.25, 1, 0.5, 1);
        }
        @keyframes modalEnter {
            from { opacity: 0; transform: translateY(20px) scale(0.98); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .hidden {
            display: none !important;
        }
        .loading {
            opacity: 0.6;
        }
    </style>
</head>
<body class="text-gray-800 antialiased">
    <div id="confetti-container"></div>

    <!-- Authentication Container -->
    <div id="auth-container" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-green-50 to-blue-50">
        <!-- Login View -->
        <div id="login-view" class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-800 mb-2">NIC Islamabad</h1>
                <p class="text-gray-600">Room Booking System</p>
            </div>

            <form id="login-form" class="space-y-6">
                <div>
                    <label for="login-email" class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                    <input type="email" id="login-email" required
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 input-focus">
                </div>

                <div>
                    <label for="login-password" class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                    <input type="password" id="login-password" required
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 input-focus">
                </div>

                <div id="login-error" class="hidden text-red-600 text-sm bg-red-50 p-3 rounded-lg"></div>

                <button type="submit" class="w-full btn-primary py-3 rounded-lg font-semibold">
                    Sign In
                </button>
            </form>

            <div class="mt-6 text-center">
                <p class="text-gray-600">Don't have an account?
                    <a href="#" id="show-signup" class="text-green-600 hover:text-green-700 font-semibold">Create an Account</a>
                </p>
            </div>
        </div>

        <!-- Signup View -->
        <div id="signup-view" class="hidden bg-white p-8 rounded-2xl shadow-xl w-full max-w-md">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-800 mb-2">Create Account</h1>
                <p class="text-gray-600">Join NIC Islamabad</p>
            </div>

            <form id="signup-form" class="space-y-4">
                <div>
                    <label for="signup-startup-name" class="block text-sm font-medium text-gray-700 mb-2">Startup Name *</label>
                    <input type="text" id="signup-startup-name" required
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                </div>

                <div>
                    <label for="signup-contact-person" class="block text-sm font-medium text-gray-700 mb-2">Contact Person *</label>
                    <input type="text" id="signup-contact-person" required
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                </div>

                <div>
                    <label for="signup-phone" class="block text-sm font-medium text-gray-700 mb-2">Phone Number *</label>
                    <input type="tel" id="signup-phone" required
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                </div>

                <div>
                    <label for="signup-email" class="block text-sm font-medium text-gray-700 mb-2">Email *</label>
                    <input type="email" id="signup-email" required
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                </div>

                <div>
                    <label for="signup-password" class="block text-sm font-medium text-gray-700 mb-2">Password *</label>
                    <input type="password" id="signup-password" required minlength="6"
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                    <p class="text-xs text-gray-500 mt-1">Minimum 6 characters</p>
                </div>

                <div id="signup-error" class="hidden text-red-600 text-sm bg-red-50 p-3 rounded-lg"></div>
                <div id="signup-success" class="hidden text-green-600 text-sm bg-green-50 p-3 rounded-lg"></div>

                <button type="submit" id="signup-submit-btn" class="w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition duration-200">
                    <span id="signup-btn-text">Create Account</span>
                    <span id="signup-btn-loading" class="hidden">Creating Account...</span>
                </button>
            </form>

            <div class="mt-6 text-center">
                <p class="text-gray-600">Already have an account?
                    <a href="#" id="show-login" class="text-green-600 hover:text-green-700 font-semibold">Sign In</a>
                </p>
            </div>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="app" class="flex h-screen bg-white hidden">
        <!-- Mobile Header (controlled by CSS media queries, not hidden class) -->
        <div class="mobile-header">
            <button id="sidebar-toggle" class="p-2 rounded-lg hover:bg-gray-100 transition duration-200">
                <svg class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                </svg>
            </button>
            <div class="flex items-center">
                <h1 class="text-lg font-bold text-gray-800">NIC Booking</h1>
            </div>
            <div class="w-8"></div> <!-- Spacer for centering -->
        </div>
            <!-- Mobile FAB Sidebar Toggle -->
            <button id="sidebar-fab" class="fixed bottom-5 left-5 z-[1001] md:hidden p-3 rounded-full bg-green-600 text-white shadow-lg">
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                </svg>
            </button>

        <!-- Sidebar Navigation -->
        <aside id="sidebar" class="sidebar w-64 bg-white text-gray-700 flex flex-col shadow-lg border-r flex-shrink-0">
            <div class="h-20 flex items-center justify-center border-b border-gray-200 px-4">
                <!-- Logo will be added here -->
            </div>
            <nav class="flex-1 px-4 py-4 space-y-2">
                <a href="#dashboard" class="nav-link flex items-center px-4 py-3 rounded-lg hover:bg-green-50 hover:text-green-700 transition duration-200">
                    <svg class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
                    Dashboard
                </a>
                <a href="#startups" class="nav-link flex items-center px-4 py-3 rounded-lg hover:bg-green-50 hover:text-green-700 transition duration-200" data-admin-only>
                     <svg class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M15 21a6 6 0 00-9-5.197M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                    Startups
                </a>
                <a href="#booking" class="nav-link flex items-center px-4 py-3 rounded-lg hover:bg-green-50 hover:text-green-700 transition duration-200">
                    <svg class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                    Book a Room
                </a>
                <a href="#my-bookings" class="nav-link flex items-center px-4 py-3 rounded-lg hover:bg-green-50 hover:text-green-700 transition duration-200">
                   <svg class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                   My Bookings
                </a>
                <a href="#schedule" class="nav-link flex items-center px-4 py-3 rounded-lg hover:bg-green-50 hover:text-green-700 transition duration-200">
                     <svg class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                    Schedule
                </a>
                 <a href="#room-displays" class="nav-link flex items-center px-4 py-3 rounded-lg hover:bg-green-50 hover:text-green-700 transition duration-200" data-admin-only>
                    <svg class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" /></svg>
                    Room Displays
                </a>
                <a href="#reports" class="nav-link flex items-center px-4 py-3 rounded-lg hover:bg-green-50 hover:text-green-700 transition duration-200" data-admin-only>
                    <svg class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
                    Reports
                </a>
                <a href="#policies" class="nav-link flex items-center px-4 py-3 rounded-lg hover:bg-green-50 hover:text-green-700 transition duration-200">
                    <svg class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                    Policies
                </a>
                <a href="#contact" class="nav-link flex items-center px-4 py-3 rounded-lg hover:bg-green-50 hover:text-green-700 transition duration-200">
                    <svg class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
                    Contact Us
                </a>
                <a href="#settings" class="nav-link flex items-center px-4 py-3 rounded-lg hover:bg-green-50 hover:text-green-700 transition duration-200">
                    <svg class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                    Settings
                </a>
            </nav>
            <div class="p-4 border-t border-gray-200">
                <div class="flex items-center">
                    <div class="flex-1">
                        <p class="text-sm font-medium text-gray-900" id="user-name">User</p>
                        <p class="text-xs text-gray-500" id="user-role">Role</p>
                    </div>
                    <button id="logout-btn" class="text-gray-400 hover:text-gray-600">
                        <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>
                    </button>
                </div>
            </div>
        </aside>

        <!-- Main Content Area -->
        <div class="main-content flex-1 flex flex-col overflow-hidden">
            <!-- Top Header -->
            <header class="bg-white border-b border-gray-200 px-4 py-3 md:px-6 md:py-4">
                <div class="flex items-center justify-between">
                    <h1 class="text-xl md:text-2xl font-bold text-gray-900" id="page-title">Dashboard</h1>
                    <div class="flex items-center space-x-4">
                        <span class="text-sm text-gray-600">Welcome, <span id="header-user-name">User</span></span>
                    </div>
                </div>
            </header>

            <!-- Page Content -->
            <main class="flex-1 overflow-y-auto bg-gray-50 p-4 md:p-6">
            <!-- Dashboard Page -->
            <div id="dashboard" class="page">
                <div class="mb-8">
                    <h2 class="text-3xl font-bold text-gray-900 mb-2">Dashboard</h2>
                    <p class="text-gray-600">Overview of your booking activities</p>
                </div>

                <!-- Stats Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div id="stat-card-startups" class="stat-card bg-white p-6 rounded-xl shadow-lg transition-all duration-200 hover:shadow-xl hover:scale-105 cursor-pointer" data-admin-only>
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                                </svg>
                            </div>
                            <div class="ml-4">
                                <h3 class="text-2xl font-bold text-gray-900">0</h3>
                                <p class="text-gray-600">Total Startups</p>
                            </div>
                        </div>
                    </div>

                    <div id="stat-card-upcoming" class="stat-card bg-white p-6 rounded-xl shadow-lg transition-all duration-200 hover:shadow-xl hover:scale-105 cursor-pointer" data-admin-only>
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-green-100 text-green-600">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                </svg>
                            </div>
                            <div class="ml-4">
                                <h3 class="text-2xl font-bold text-gray-900">0</h3>
                                <p class="text-gray-600">Upcoming Bookings</p>
                            </div>
                        </div>
                    </div>

                    <div id="stat-card-today" class="stat-card bg-white p-6 rounded-xl shadow-lg transition-all duration-200 hover:shadow-xl hover:scale-105 cursor-pointer" data-admin-only>
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-yellow-100 text-yellow-600">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <div class="ml-4">
                                <h3 class="text-2xl font-bold text-gray-900">0</h3>
                                <p class="text-gray-600">Today's Bookings</p>
                            </div>
                        </div>
                    </div>

                    <div id="stat-card-rooms" class="stat-card bg-white p-6 rounded-xl shadow-lg transition-all duration-200 hover:shadow-xl hover:scale-105 cursor-pointer" data-admin-only>
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-purple-100 text-purple-600">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                </svg>
                            </div>
                            <div class="ml-4">
                                <h3 class="text-2xl font-bold text-gray-900" id="available-rooms-count">8</h3>
                                <p class="text-gray-600">Available Rooms</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Today's Schedule -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-xl font-bold text-gray-900 mb-4">Today's Schedule</h3>
                    <div id="today-schedule" class="space-y-3">
                        <p class="text-gray-500 text-center py-8">Loading today's schedule...</p>
                    </div>
                </div>
            </div>

            <!-- Startups Page -->
            <div id="startups" class="page hidden" data-admin-only>
                <div class="mb-8">
                    <h2 class="text-3xl font-bold text-gray-900 mb-2">Startups Management</h2>
                    <p class="text-gray-600">Manage all registered startups and users</p>
                </div>

                <!-- User Management Section -->
                <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-gray-900">User Management</h3>
                        <button id="create-admin-btn" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition duration-200">
                            Create Admin Account
                        </button>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Startup</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="users-table-body" class="bg-white divide-y divide-gray-200">
                                <tr>
                                    <td colspan="5" class="px-6 py-4 text-center text-gray-500">Loading users...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Startups List -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-xl font-bold text-gray-900 mb-6">Registered Startups</h3>
                    <div id="startups-list" class="space-y-4">
                        <p class="text-gray-500 text-center py-8">Loading startups...</p>
                    </div>
                </div>
            </div>

            <!-- Book a Room Page -->
            <div id="booking" class="page hidden">
                <div class="mb-8">
                    <h2 class="text-3xl font-bold text-gray-900 mb-2">Book a Room</h2>
                    <p class="text-gray-600">Reserve a room for your startup activities</p>
                </div>

                <div class="bg-white rounded-xl shadow-lg p-8">
                    <form id="booking-form" class="space-y-6">
                        <!-- Room Preview Section -->
                        <div id="room-preview-section" class="hidden bg-gradient-to-r from-green-50 to-blue-50 rounded-xl p-6 border border-green-200">
                            <div class="flex items-start space-x-4">
                                <div class="flex-shrink-0">
                                    <div class="w-16 h-16 bg-green-100 rounded-lg flex items-center justify-center">
                                        <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-4m-5 0H3m2 0h3M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                                        </svg>
                                    </div>
                                </div>
                                <div class="flex-1">
                                    <h3 id="room-preview-name" class="text-lg font-semibold text-gray-900 mb-2"></h3>
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                                        <div>
                                            <span class="font-medium text-gray-700">Capacity:</span>
                                            <span id="room-preview-capacity" class="text-gray-600 ml-1"></span>
                                        </div>
                                        <div>
                                            <span class="font-medium text-gray-700">Type:</span>
                                            <span id="room-preview-type" class="text-gray-600 ml-1"></span>
                                        </div>
                                        <div>
                                            <span class="font-medium text-gray-700">Max Duration:</span>
                                            <span id="room-preview-duration" class="text-gray-600 ml-1"></span>
                                        </div>
                                    </div>
                                    <div class="mt-3">
                                        <span class="font-medium text-gray-700">Equipment:</span>
                                        <div id="room-preview-equipment" class="flex flex-wrap gap-1 mt-1"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="room-select" class="block text-sm font-medium text-gray-700 mb-2">Room *</label>
                                <select id="room-select" required class="form-input-mobile w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    <option value="">Select a room</option>
                                </select>
                            </div>

                            <div>
                                <label for="booking-date" class="block text-sm font-medium text-gray-700 mb-2">Date *</label>
                                <input type="date" id="booking-date" required
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                            </div>

                            <div>
                                <label for="time-select" class="block text-sm font-medium text-gray-700 mb-2">Start Time *</label>
                                <select id="time-select" required class="form-input-mobile w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    <option value="09:00">09:00 AM</option>
                                    <option value="10:00">10:00 AM</option>
                                    <option value="11:00">11:00 AM</option>
                                    <option value="12:00">12:00 PM</option>
                                    <option value="13:00">01:00 PM</option>
                                    <option value="14:00">02:00 PM</option>
                                    <option value="15:00">03:00 PM</option>
                                    <option value="16:00">04:00 PM</option>
                                    <option value="17:00">05:00 PM</option>
                                </select>
                                <p id="time-help-text" class="text-xs text-gray-500 mt-1">Available hours vary by room</p>
                            </div>

                            <div>
                                <label for="duration-select" class="block text-sm font-medium text-gray-700 mb-2">Duration *</label>
                                <select id="duration-select" required class="form-input-mobile w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    <option value="1">1 Hour</option>
                                    <option value="2">2 Hours</option>
                                    <option value="3">3 Hours</option>
                                </select>
                                <p id="duration-help-text" class="text-xs text-gray-500 mt-1">Maximum booking duration varies by room</p>
                            </div>
                        </div>

                        <div id="podcast-equipment-section" class="hidden">
                            <label for="podcast-equipment" class="block text-sm font-medium text-gray-700 mb-2">
                                Special Equipment Requirements *
                                <span class="text-xs text-gray-500">(Required for this room)</span>
                            </label>
                            <textarea id="podcast-equipment" rows="3" required
                                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                      placeholder="Describe your specific equipment needs for this room..."></textarea>
                        </div>

                        <div>
                            <label for="general-notes" class="block text-sm font-medium text-gray-700 mb-2">Additional Notes</label>
                            <textarea id="general-notes" rows="2"
                                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                      placeholder="Any additional requirements or notes..."></textarea>
                        </div>

                        <div class="flex items-center">
                            <input type="checkbox" id="is-confidential" class="h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300 rounded">
                            <label for="is-confidential" class="ml-2 block text-sm text-gray-700">This is a confidential meeting</label>
                        </div>

                        <div id="booking-message" class="hidden"></div>

                        <button type="submit" class="w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition duration-200">
                            Book Room
                        </button>
                    </form>
                </div>
            </div>

            <!-- My Bookings Page -->
            <div id="my-bookings" class="page hidden">
                <div class="mb-8">
                    <h2 class="text-3xl font-bold text-gray-900 mb-2">My Bookings</h2>
                    <p class="text-gray-600">View and manage your room reservations</p>
                </div>

                <!-- Booking Tabs -->
                <div class="bg-white rounded-xl shadow-lg">
                    <div class="border-b border-gray-200">
                        <nav class="-mb-px flex space-x-8 px-6">
                            <button class="booking-tab-btn py-4 px-1 border-b-2 border-green-500 font-medium text-sm text-green-600" data-tab="future">
                                Upcoming Bookings
                            </button>
                            <button class="booking-tab-btn py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700" data-tab="present">
                                Today's Bookings
                            </button>
                            <button class="booking-tab-btn py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700" data-tab="past">
                                Past Bookings
                            </button>
                        </nav>
                    </div>

                    <div class="p-6">
                        <div id="future-bookings" class="booking-tab-content">
                            <div id="future-bookings-list" class="space-y-4">
                                <p class="text-center text-gray-500 py-8">Loading upcoming bookings...</p>
                            </div>
                        </div>

                        <div id="present-bookings" class="booking-tab-content hidden">
                            <div id="present-bookings-list" class="space-y-4">
                                <p class="text-center text-gray-500 py-8">Loading today's bookings...</p>
                            </div>
                        </div>

                        <div id="past-bookings" class="booking-tab-content hidden">
                            <div id="past-bookings-list" class="space-y-4">
                                <p class="text-center text-gray-500 py-8">Loading past bookings...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Admin Booking Management -->
                    <div id="admin-bookings-panel" class="mt-8 hidden" data-admin-only>
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-xl font-bold text-gray-900">Admin Booking Management</h3>
                            <span class="px-2 py-1 text-xs rounded bg-blue-100 text-blue-700 font-medium">Admin</span>
                        </div>
                        <div class="bg-white rounded-lg border border-gray-200">
                            <!-- Search and Filter Section -->
                            <div class="p-4 border-b border-gray-200 bg-gray-50">
                                <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                                    <input type="text" id="admin-search-startup" placeholder="Search by startup..." class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-green-500">
                                    <select id="admin-filter-room" class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-green-500">
                                        <option value="">All Rooms</option>
                                        <option value="Hub">Hub</option>
                                        <option value="Hingol">Hingol</option>
                                        <option value="Telenor Velocity">Telenor Velocity</option>
                                        <option value="Sutlej">Sutlej</option>
                                        <option value="Chenab">Chenab</option>
                                        <option value="Jhelum">Jhelum</option>
                                        <option value="Indus Board">Indus Board</option>
                                        <option value="Nexus Session Hall">Nexus Session Hall</option>
                                        <option value="Podcast Room">Podcast Room</option>
                                    </select>
                                    <select id="admin-filter-status" class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-green-500">
                                        <option value="">All Statuses</option>
                                        <option value="confirmed">Confirmed</option>
                                        <option value="cancelled">Cancelled</option>
                                        <option value="completed">Completed</option>
                                    </select>
                                    <button id="refresh-admin-bookings" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition duration-200">
                                        <svg class="h-4 w-4 inline mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                                        </svg>
                                        Refresh
                                    </button>
                                </div>
                            </div>

                            <div class="p-4 border-b border-gray-200 flex items-center justify-between">
                                <div class="text-sm text-gray-600">
                                    <span id="admin-bookings-count">0</span> bookings found â€¢ Full CRUD access
                                </div>
                                <div class="text-xs text-gray-500">
                                    <span class="inline-block w-3 h-3 bg-green-100 rounded mr-1"></span> Confirmed
                                    <span class="inline-block w-3 h-3 bg-red-100 rounded ml-3 mr-1"></span> Cancelled
                                    <span class="inline-block w-3 h-3 bg-gray-100 rounded ml-3 mr-1"></span> Completed
                                </div>
                            </div>

                            <div id="admin-bookings-list" class="divide-y divide-gray-100">
                                <div class="text-center text-gray-500 py-8">Loading all bookings...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Schedule Page -->
            <div id="schedule" class="page hidden">
                <div class="mb-8">
                    <h2 class="text-3xl font-bold text-gray-900 mb-2">Booking Schedule</h2>
                    <p class="text-gray-600">View all room bookings and availability</p>
                </div>

                <div class="bg-white rounded-xl shadow-lg p-8">
                    <!-- Calendar Header with Navigation -->
                    <div class="flex justify-between items-center mb-8">
                        <button id="prev-month" class="p-2 hover:bg-gray-100 rounded-lg transition duration-200">
                            <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                            </svg>
                        </button>
                        <h3 id="month-year" class="text-2xl font-semibold text-gray-900"></h3>
                        <button id="next-month" class="p-2 hover:bg-gray-100 rounded-lg transition duration-200">
                            <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                            </svg>
                        </button>
                    </div>

                    <!-- Calendar Grid -->
                    <div id="calendar-container" class="mb-8">
                        <!-- Day Headers -->
                        <div id="calendar-header" class="grid grid-cols-7 gap-0 mb-4">
                            <div class="p-3 text-center text-sm font-medium text-gray-600">Sun</div>
                            <div class="p-3 text-center text-sm font-medium text-gray-600">Mon</div>
                            <div class="p-3 text-center text-sm font-medium text-gray-600">Tue</div>
                            <div class="p-3 text-center text-sm font-medium text-gray-600">Wed</div>
                            <div class="p-3 text-center text-sm font-medium text-gray-600">Thu</div>
                            <div class="p-3 text-center text-sm font-medium text-gray-600">Fri</div>
                            <div class="p-3 text-center text-sm font-medium text-gray-600">Sat</div>
                        </div>
                        <!-- Calendar Days Grid -->
                        <div id="calendar-grid" class="grid grid-cols-7 gap-0 border border-gray-200 rounded-lg overflow-hidden">
                            <!-- Calendar days will be populated by JavaScript -->
                        </div>
                    </div>

                    <!-- Schedule Details Section -->
                    <div id="schedule-details" class="border-t border-gray-200 pt-6">
                        <h4 class="text-lg font-semibold text-gray-900 mb-4">Select a date to view bookings</h4>
                    </div>
                </div>
            </div>

            <!-- Room Displays Page -->
            <div id="room-displays" class="page hidden" data-admin-only>
                <div class="mb-8">
                    <div class="flex justify-between items-center">
                        <div>
                            <h2 class="text-3xl font-bold text-gray-900 mb-2">Room Displays Management</h2>
                            <p class="text-gray-600">Manage digital displays and content for each room</p>
                        </div>
                        <div class="flex space-x-3" id="room-displays-admin-controls" data-admin-only>
                            <button id="upload-content-btn" class="btn-primary px-4 py-2 rounded-lg text-white font-medium hover:bg-opacity-90 transition duration-200">
                                <svg class="h-5 w-5 inline mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                                </svg>
                                Upload Content
                            </button>
                            <button id="manage-layouts-btn" class="bg-gray-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-gray-700 transition duration-200">
                                <svg class="h-5 w-5 inline mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"/>
                                </svg>
                                Manage Layouts
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Display Management Tabs -->
                <div class="mb-6">
                    <div class="border-b border-gray-200">
                        <nav class="-mb-px flex space-x-8">
                            <button class="room-display-tab-btn border-b-2 border-green-500 text-green-600 py-2 px-1 text-sm font-medium" data-tab="room-status">
                                Room Status
                            </button>
                            <button class="room-display-tab-btn border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 py-2 px-1 text-sm font-medium" data-tab="content-library" data-admin-only>
                                Content Library
                            </button>
                            <button class="room-display-tab-btn border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 py-2 px-1 text-sm font-medium" data-tab="display-settings" data-admin-only>
                                Display Settings
                            </button>
                            <button class="room-display-tab-btn border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 py-2 px-1 text-sm font-medium" data-tab="content-schedule" data-admin-only>
                                Content Schedule
                            </button>
                        </nav>
                    </div>
                </div>

                <!-- Room Status Tab -->
                <div id="room-status-tab" class="room-display-tab-content">
                    <!-- UPDATED: Fixed 3x3 grid layout for 9 rooms - clean modern UI -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 max-w-7xl mx-auto" id="room-status-grid">
                        <div class="text-center text-gray-500 py-8 col-span-full">Loading room displays...</div>
                    </div>
                </div>

                <!-- Content Library Tab -->
                <div id="content-library-tab" class="room-display-tab-content hidden" data-admin-only>
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-semibold text-gray-900">Content Library</h3>
                            <div class="flex space-x-3">
                                <select id="content-type-filter" class="border border-gray-300 rounded-lg px-3 py-2 text-sm">
                                    <option value="">All Content Types</option>
                                    <option value="image">Images</option>
                                    <option value="video">Videos</option>
                                    <option value="text">Text Content</option>
                                    <option value="announcement">Announcements</option>
                                </select>
                                <button id="refresh-content-btn" class="bg-gray-100 text-gray-700 px-3 py-2 rounded-lg text-sm hover:bg-gray-200 transition duration-200">
                                    <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div id="content-library-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                            <div class="text-center text-gray-500 py-8 col-span-full">Loading content library...</div>
                        </div>
                    </div>
                </div>

                <!-- Display Settings Tab -->
                <div id="display-settings-tab" class="room-display-tab-content hidden" data-admin-only>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Room Display Configuration -->
                        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Room Display Configuration</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Select Room</label>
                                    <select id="room-select" class="w-full border border-gray-300 rounded-lg px-3 py-2">
                                        <option value="">Choose a room...</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Display Layout</label>
                                    <select id="layout-select" class="w-full border border-gray-300 rounded-lg px-3 py-2">
                                        <option value="">Choose a layout...</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Display Status</label>
                                    <select id="display-status-select" class="w-full border border-gray-300 rounded-lg px-3 py-2">
                                        <option value="available">Available</option>
                                        <option value="occupied">Occupied</option>
                                        <option value="maintenance">Maintenance</option>
                                        <option value="reserved">Reserved</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Status Message</label>
                                    <input type="text" id="status-message-input" class="w-full border border-gray-300 rounded-lg px-3 py-2" placeholder="Optional status message...">
                                </div>
                                <button id="update-display-btn" class="w-full btn-primary py-2 rounded-lg text-white font-medium hover:bg-opacity-90 transition duration-200">
                                    Update Display Settings
                                </button>
                            </div>
                        </div>

                        <!-- Layout Preview -->
                        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Layout Preview</h3>
                            <div id="layout-preview" class="border-2 border-dashed border-gray-300 rounded-lg h-64 flex items-center justify-center text-gray-500">
                                Select a room and layout to preview
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Content Schedule Tab -->
                <div id="content-schedule-tab" class="room-display-tab-content hidden" data-admin-only>
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-semibold text-gray-900">Content Schedule</h3>
                            <button id="add-schedule-btn" class="btn-primary px-4 py-2 rounded-lg text-white font-medium hover:bg-opacity-90 transition duration-200">
                                <svg class="h-5 w-5 inline mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                                </svg>
                                Add Schedule
                            </button>
                        </div>
                        <div id="content-schedule-list" class="space-y-4">
                            <div class="text-center text-gray-500 py-8">Loading content schedules...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reports Page -->
            <div id="reports" class="page hidden" data-admin-only>
                <div class="mb-8">
                    <h2 class="text-3xl font-bold text-gray-900 mb-2">Reports & Analytics</h2>
                    <p class="text-gray-600">Comprehensive booking analytics and usage reports</p>
                </div>

                <!-- Report Filters -->
                <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                    <h3 class="text-xl font-bold text-gray-900 mb-4">Report Filters</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <!-- Time Period Filter -->
                        <div>
                            <label for="report-period" class="block text-sm font-medium text-gray-700 mb-2">Time Period</label>
                            <select id="report-period" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                <option value="daily">Daily</option>
                                <option value="weekly" selected>Weekly (Last 7 days)</option>
                                <option value="15days">Last 15 days</option>
                                <option value="monthly">Monthly (Last 30 days)</option>
                                <option value="custom">Custom Date Range</option>
                            </select>
                        </div>

                        <!-- Custom Date Range (hidden by default) -->
                        <div id="custom-date-range" class="hidden">
                            <label for="report-start-date" class="block text-sm font-medium text-gray-700 mb-2">Start Date</label>
                            <input type="date" id="report-start-date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        </div>
                        <div id="custom-date-range-end" class="hidden">
                            <label for="report-end-date" class="block text-sm font-medium text-gray-700 mb-2">End Date</label>
                            <input type="date" id="report-end-date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        </div>

                        <!-- Specific Date for Daily Reports -->
                        <div id="specific-date-filter" class="hidden">
                            <label for="report-specific-date" class="block text-sm font-medium text-gray-700 mb-2">Specific Date</label>
                            <input type="date" id="report-specific-date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        </div>

                        <!-- Report Type Filter -->
                        <div>
                            <label for="report-type" class="block text-sm font-medium text-gray-700 mb-2">Report Type</label>
                            <select id="report-type" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                <option value="overall" selected>Overall Activity</option>
                                <option value="startup-specific">Startup-Specific</option>
                            </select>
                        </div>

                        <!-- Startup Filter (for startup-specific reports) -->
                        <div id="startup-filter" class="hidden">
                            <label for="report-startup" class="block text-sm font-medium text-gray-700 mb-2">Select Startup</label>
                            <select id="report-startup" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                <option value="">Loading startups...</option>
                            </select>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex flex-wrap gap-3 mt-6">
                        <button id="generate-report-btn" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition duration-200">
                            Generate Report
                        </button>
                        <button id="export-csv-btn" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition duration-200" disabled>
                            Export CSV
                        </button>
                        <button id="export-pdf-btn" class="bg-red-600 text-white px-6 py-2 rounded-lg hover:bg-red-700 transition duration-200" disabled>
                            Export PDF
                        </button>
                    </div>
                </div>

                <!-- Report Results -->
                <div id="report-results" class="hidden">
                    <!-- Overall Statistics -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <div class="flex items-center">
                                <div class="p-3 rounded-full bg-green-100">
                                    <svg class="h-8 w-8 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                    </svg>
                                </div>
                                <div class="ml-4">
                                    <h3 id="total-bookings-stat" class="text-2xl font-bold text-gray-900">0</h3>
                                    <p class="text-gray-600">Total Bookings</p>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <div class="flex items-center">
                                <div class="p-3 rounded-full bg-blue-100">
                                    <svg class="h-8 w-8 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                </div>
                                <div class="ml-4">
                                    <h3 id="total-hours-stat" class="text-2xl font-bold text-gray-900">0</h3>
                                    <p class="text-gray-600">Total Hours</p>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <div class="flex items-center">
                                <div class="p-3 rounded-full bg-purple-100">
                                    <svg class="h-8 w-8 text-purple-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                                    </svg>
                                </div>
                                <div class="ml-4">
                                    <h3 id="unique-startups-stat" class="text-2xl font-bold text-gray-900">0</h3>
                                    <p class="text-gray-600">Active Startups</p>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <div class="flex items-center">
                                <div class="p-3 rounded-full bg-yellow-100">
                                    <svg class="h-8 w-8 text-yellow-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                                    </svg>
                                </div>
                                <div class="ml-4">
                                    <h3 id="utilization-rate-stat" class="text-2xl font-bold text-gray-900">0%</h3>
                                    <p class="text-gray-600">Utilization Rate</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Charts and Detailed Reports -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                        <!-- Room Usage Chart -->
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <h3 class="text-xl font-bold text-gray-900 mb-4">Room Usage Distribution</h3>
                            <div id="room-usage-chart" class="h-64">
                                <canvas id="room-chart-canvas"></canvas>
                            </div>
                        </div>

                        <!-- Booking Trends Chart -->
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <h3 class="text-xl font-bold text-gray-900 mb-4">Booking Trends</h3>
                            <div id="booking-trends-chart" class="h-64">
                                <canvas id="trends-chart-canvas"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Detailed Tables -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <!-- Most Popular Rooms -->
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <h3 class="text-xl font-bold text-gray-900 mb-4">Most Popular Rooms</h3>
                            <div id="popular-rooms-table" class="overflow-x-auto">
                                <!-- Table content will be populated by JavaScript -->
                            </div>
                        </div>

                        <!-- Peak Usage Times -->
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <h3 class="text-xl font-bold text-gray-900 mb-4">Peak Usage Times</h3>
                            <div id="peak-times-table" class="overflow-x-auto">
                                <!-- Table content will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>

                    <!-- Detailed Booking List -->
                    <div class="bg-white rounded-xl shadow-lg p-6 mt-8">
                        <h3 class="text-xl font-bold text-gray-900 mb-4">Detailed Booking List</h3>
                        <div id="detailed-bookings-table" class="overflow-x-auto">
                            <!-- Table content will be populated by JavaScript -->
                        </div>
                    </div>
                </div>

                <!-- Loading State -->
                <div id="report-loading" class="hidden text-center py-12">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-green-600"></div>
                    <p class="mt-4 text-gray-600">Generating report...</p>
                </div>
            </div>

            <!-- Policies Page -->
            <div id="policies" class="page hidden">
                <div class="mb-8">
                    <h2 class="text-3xl font-bold text-gray-900 mb-2">Booking Policies</h2>
                    <p class="text-gray-600">Guidelines and rules for room bookings</p>
                </div>

                <div class="bg-white rounded-xl shadow-lg p-8">
                    <div class="prose max-w-none">
                        <h3 class="text-xl font-bold text-gray-900 mb-4">1. Property and Equipment Care</h3>
                        <p class="text-gray-700 mb-6">
                            All startups are expected to treat NIC Islamabad property, including furniture, electronics, and the rooms themselves, with the utmost care. Please leave the rooms in the same condition you found them. Report any pre-existing damage to the administration immediately upon discovery.
                        </p>
                        <p class="text-gray-700 mb-6">
                            Any damages caused to NIC property during your booked session will result in fines corresponding to the repair or replacement cost of the damaged item(s).
                        </p>

                        <h3 class="text-xl font-bold text-gray-900 mb-4">2. Punctuality and Room Usage</h3>
                        <p class="text-gray-700 mb-6">
                            Your booking time includes setup and cleanup. Please ensure you vacate the room promptly at the end of your scheduled time to respect the schedule of the next startup.
                        </p>
                        <p class="text-gray-700 mb-4">
                            Overusing a booked room beyond the scheduled time is strictly prohibited and will result in official warnings:
                        </p>
                        <ul class="space-y-2 text-gray-700 mb-6 ml-6">
                            <li>â€¢ <strong>First Offense:</strong> A formal warning will be issued.</li>
                            <li>â€¢ <strong>Second Offense:</strong> A second and final warning will be issued.</li>
                            <li>â€¢ <strong>Third Offense:</strong> A fine will be imposed, and booking privileges may be temporarily suspended.</li>
                        </ul>

                        <h3 class="text-xl font-bold text-gray-900 mb-4">3. Booking Fairness and Restrictions</h3>
                        <p class="text-gray-700 mb-4">
                            To ensure fair access for all startups, monthly booking limits are in place. These policies are strictly enforced to maintain an equitable environment for everyone. Please see the specific limits below:
                        </p>
                        <ul class="space-y-2 text-gray-700 ml-6">
                            <li>â€¢ <strong>All Focus Rooms:</strong> 5 bookings per month (cumulative).</li>
                            <li>â€¢ <strong>Indus-Board Room:</strong> 1 booking per month.</li>
                            <li>â€¢ <strong>Nexus-Session Hall:</strong> 1 booking per month.</li>
                            <li>â€¢ <strong>Podcast Room:</strong> 1 booking per month.</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Contact Us Page -->
            <div id="contact" class="page hidden">
                <div class="mb-8">
                    <h2 class="text-3xl font-bold text-gray-900 mb-2">Contact Us</h2>
                    <p class="text-gray-600">Get in touch with the NIC Islamabad team</p>
                </div>

                <div class="bg-white rounded-xl shadow-lg p-8">
                    <div class="mb-6">
                        <h3 class="text-2xl font-bold text-gray-900">Our Team</h3>
                        <p class="text-gray-600 mt-1">Connect with our administrators for assistance</p>
                    </div>

                    <!-- Admin Cards Grid - Fixed Two Profiles -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Profile 1: Jawad Ahmad -->
                        <div class="bg-white rounded-xl shadow-md hover:shadow-xl transition-all duration-300 overflow-hidden border border-gray-100 transform hover:-translate-y-1">
                            <!-- Card Header with Avatar -->
                            <div class="bg-gradient-to-br from-green-500 to-green-600 p-6 text-center">
                                <div class="w-24 h-24 bg-white rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg">
                                    <span class="text-3xl font-bold text-green-600">JA</span>
                                </div>
                                <h4 class="text-xl font-bold text-white mb-1">Jawad Ahmad</h4>
                                <p class="text-green-100 text-sm font-medium">Community Associate, NIC Islamabad</p>
                            </div>

                            <!-- Card Body with Contact Info -->
                            <div class="p-6 space-y-4">
                                <div class="flex items-start space-x-3">
                                    <div class="flex-shrink-0 w-10 h-10 bg-green-50 rounded-lg flex items-center justify-center">
                                        <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                                        </svg>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <p class="text-xs text-gray-500 font-medium mb-1">Email</p>
                                        <a href="mailto:jawad.ahmad@changemechanics.pk" class="text-sm text-gray-900 hover:text-green-600 transition-colors break-words">
                                            jawad.ahmad@changemechanics.pk
                                        </a>
                                    </div>
                                </div>

                                <div class="flex items-start space-x-3">
                                    <div class="flex-shrink-0 w-10 h-10 bg-blue-50 rounded-lg flex items-center justify-center">
                                        <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                                        </svg>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <p class="text-xs text-gray-500 font-medium mb-1">Phone</p>
                                        <a href="tel:03328020445" class="text-sm text-gray-900 hover:text-blue-600 transition-colors">
                                            03328020445
                                        </a>
                                    </div>
                                </div>
                            </div>

                            <!-- Card Footer with Action Buttons -->
                            <div class="px-6 pb-6 flex gap-2">
                                <a href="mailto:jawad.ahmad@changemechanics.pk" class="flex-1 bg-green-600 text-white px-4 py-2.5 rounded-lg text-sm font-medium hover:bg-green-700 transition-all duration-200 text-center shadow-sm hover:shadow-md">
                                    <svg class="w-4 h-4 inline mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                                    </svg>
                                    Email
                                </a>
                                <a href="tel:03328020445" class="flex-1 bg-blue-600 text-white px-4 py-2.5 rounded-lg text-sm font-medium hover:bg-blue-700 transition-all duration-200 text-center shadow-sm hover:shadow-md">
                                    <svg class="w-4 h-4 inline mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                                    </svg>
                                    Call
                                </a>
                            </div>
                        </div>

                        <!-- Profile 2: Ashraf Khan -->
                        <div class="bg-white rounded-xl shadow-md hover:shadow-xl transition-all duration-300 overflow-hidden border border-gray-100 transform hover:-translate-y-1">
                            <!-- Card Header with Avatar -->
                            <div class="bg-gradient-to-br from-green-500 to-green-600 p-6 text-center">
                                <div class="w-24 h-24 bg-white rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg">
                                    <span class="text-3xl font-bold text-green-600">AK</span>
                                </div>
                                <h4 class="text-xl font-bold text-white mb-1">Ashraf Khan</h4>
                                <p class="text-green-100 text-sm font-medium">Admin and HR manager, NIC Islamabad</p>
                            </div>

                            <!-- Card Body with Contact Info -->
                            <div class="p-6 space-y-4">
                                <div class="flex items-start space-x-3">
                                    <div class="flex-shrink-0 w-10 h-10 bg-green-50 rounded-lg flex items-center justify-center">
                                        <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                                        </svg>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <p class="text-xs text-gray-500 font-medium mb-1">Email</p>
                                        <a href="mailto:Ashraf.khan@changemechanics.pk" class="text-sm text-gray-900 hover:text-green-600 transition-colors break-words">
                                            Ashraf.khan@changemechanics.pk
                                        </a>
                                    </div>
                                </div>

                                <div class="flex items-start space-x-3">
                                    <div class="flex-shrink-0 w-10 h-10 bg-blue-50 rounded-lg flex items-center justify-center">
                                        <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                                        </svg>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <p class="text-xs text-gray-500 font-medium mb-1">Phone</p>
                                        <a href="tel:03359177115" class="text-sm text-gray-900 hover:text-blue-600 transition-colors">
                                            03359177115
                                        </a>
                                    </div>
                                </div>
                            </div>

                            <!-- Card Footer with Action Buttons -->
                            <div class="px-6 pb-6 flex gap-2">
                                <a href="mailto:Ashraf.khan@changemechanics.pk" class="flex-1 bg-green-600 text-white px-4 py-2.5 rounded-lg text-sm font-medium hover:bg-green-700 transition-all duration-200 text-center shadow-sm hover:shadow-md">
                                    <svg class="w-4 h-4 inline mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                                    </svg>
                                    Email
                                </a>
                                <a href="tel:03359177115" class="flex-1 bg-blue-600 text-white px-4 py-2.5 rounded-lg text-sm font-medium hover:bg-blue-700 transition-all duration-200 text-center shadow-sm hover:shadow-md">
                                    <svg class="w-4 h-4 inline mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                                    </svg>
                                    Call
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Page -->
            <div id="settings" class="page hidden">
                <div class="mb-8">
                    <h2 class="text-3xl font-bold text-gray-900 mb-2">Settings</h2>
                    <p class="text-gray-600">Manage your account and preferences</p>
                </div>

                <!-- Profile Debug Information (Hidden by default) -->
                <div id="profile-debug-section" class="bg-blue-50 border border-blue-200 rounded-lg p-6 mb-6 hidden">
                    <h3 class="text-lg font-semibold text-blue-900 mb-3">Profile Debug Information</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <h4 class="font-medium text-blue-800 mb-2">Current User Profile</h4>
                            <div id="debug-user-profile" class="bg-white p-3 rounded border text-sm font-mono"></div>
                        </div>
                        <div>
                            <h4 class="font-medium text-blue-800 mb-2">Current Startup Profile</h4>
                            <div id="debug-startup-profile" class="bg-white p-3 rounded border text-sm font-mono"></div>
                        </div>
                    </div>
                    <button id="refresh-profiles-btn" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                        Refresh Profile Data
                    </button>
                </div>

                <!-- Toggle Debug Information Button -->
                <div class="mb-6">
                    <button id="toggle-debug-btn" class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700 text-sm">
                        Show Debug Information
                    </button>
                </div>

                <!-- User Profile Settings -->
                <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                    <h3 class="text-xl font-bold text-gray-900 mb-4">User Profile</h3>
                    <form id="user-profile-form" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="settings-name" class="block text-sm font-medium text-gray-700 mb-2">Full Name</label>
                                <input type="text" id="settings-name" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                            </div>
                            <div>
                                <label for="settings-email" class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                                <input type="email" id="settings-email" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50" readonly>
                            </div>
                            <div>
                                <label for="settings-phone" class="block text-sm font-medium text-gray-700 mb-2">Phone</label>
                                <input type="tel" id="settings-phone" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                            </div>
                            <div>
                                <label for="settings-role" class="block text-sm font-medium text-gray-700 mb-2">Role</label>
                                <input type="text" id="settings-role" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50" readonly>
                            </div>
                        </div>
                        <button type="submit" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700">
                            Update User Profile
                        </button>
                    </form>
                </div>

                <!-- Startup Profile Settings -->
                <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                    <h3 class="text-xl font-bold text-gray-900 mb-4">Startup Profile</h3>
                    <div id="startup-profile-content">
                        <!-- Content will be loaded dynamically -->
                    </div>
                </div>

                <!-- Profile Actions -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-xl font-bold text-gray-900 mb-4">Profile Actions</h3>
                    <div class="space-y-3">
                        <button id="create-startup-profile-btn" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 hidden">
                            Create Missing Startup Profile
                        </button>
                        <button id="reload-profile-data-btn" class="bg-gray-600 text-white px-6 py-2 rounded-lg hover:bg-gray-700">
                            Reload Profile Data
                        </button>
                        <div id="profile-actions-status" class="text-sm"></div>
                    </div>
                </div>

                <div class="space-y-8">
                    <!-- Profile Settings -->
                    <div class="bg-white rounded-xl shadow-lg p-8">
                        <h3 class="text-xl font-bold text-gray-900 mb-6">Profile Information</h3>

                        <form id="profile-form" class="space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label for="profile-name" class="block text-sm font-medium text-gray-700 mb-2">Full Name</label>
                                    <input type="text" id="profile-name"
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                </div>

                                <div>
                                    <label for="profile-email" class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                                    <input type="email" id="profile-email" readonly
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-50">
                                </div>

                                <div>
                                    <label for="profile-phone" class="block text-sm font-medium text-gray-700 mb-2">Phone Number</label>
                                    <input type="tel" id="profile-phone"
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                </div>

                                <div>
                                    <label for="profile-role" class="block text-sm font-medium text-gray-700 mb-2">Role</label>
                                    <input type="text" id="profile-role" readonly
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-50">
                                </div>
                            </div>

                            <div id="profile-message" class="hidden"></div>

                            <button type="submit" class="bg-green-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-green-700 transition duration-200">
                                Update Profile
                            </button>
                        </form>
                    </div>

                    <!-- Password Change -->
                    <div class="bg-white rounded-xl shadow-lg p-8">
                        <h3 class="text-xl font-bold text-gray-900 mb-6">Change Password</h3>

                        <form id="password-form" class="space-y-6">
                            <div>
                                <label for="current-password" class="block text-sm font-medium text-gray-700 mb-2">Current Password</label>
                                <input type="password" id="current-password" required
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                            </div>

                            <div>
                                <label for="new-password" class="block text-sm font-medium text-gray-700 mb-2">New Password</label>
                                <input type="password" id="new-password" required minlength="6"
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                            </div>

                            <div>
                                <label for="confirm-password" class="block text-sm font-medium text-gray-700 mb-2">Confirm New Password</label>
                                <input type="password" id="confirm-password" required minlength="6"
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                            </div>

                            <div id="password-message" class="hidden"></div>

                            <button type="submit" class="bg-green-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-green-700 transition duration-200">
                                Change Password
                            </button>
                        </form>
                    </div>

                    <!-- Admin Settings -->
                    <div id="admin-settings" class="bg-white rounded-xl shadow-lg p-8 hidden" data-admin-only>
                        <h3 class="text-xl font-bold text-gray-900 mb-6">Admin Settings</h3>

                        <div class="space-y-6">
                            <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                                <div>
                                    <h4 class="font-semibold text-gray-900">User Management</h4>
                                    <p class="text-sm text-gray-600">Manage user accounts and permissions</p>
                                </div>
                                <button onclick="showPage('#startups')" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-200">
                                    Manage Users
                                </button>
                            </div>

                            <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                                <div>
                                    <h4 class="font-semibold text-gray-900">System Reports</h4>
                                    <p class="text-sm text-gray-600">View detailed analytics and reports</p>
                                </div>
                                <button onclick="showPage('#reports')" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-200">
                                    View Reports
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Cache & Version Management -->
                    <div class="bg-white rounded-xl shadow-lg p-8">
                        <h3 class="text-xl font-bold text-gray-900 mb-6">Cache & Version Management</h3>

                        <div class="space-y-6">
                            <!-- Version Information -->
                            <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg">
                                <div class="flex items-start">
                                    <div class="flex-shrink-0">
                                        <svg class="h-6 w-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                        </svg>
                                    </div>
                                    <div class="ml-3 flex-1">
                                        <h4 class="text-sm font-semibold text-blue-900">Current Version</h4>
                                        <p class="mt-1 text-sm text-blue-700">
                                            Version: <span id="current-version-display" class="font-mono font-bold">2.0.0</span>
                                        </p>
                                        <p class="mt-1 text-xs text-blue-600">
                                            Build: <span id="build-timestamp-display" class="font-mono">Loading...</span>
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <!-- Clear Cache Button -->
                            <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                                <div>
                                    <h4 class="font-semibold text-gray-900">Clear Browser Cache</h4>
                                    <p class="text-sm text-gray-600">Force reload the application and clear all cached data</p>
                                    <p class="text-xs text-gray-500 mt-1">Use this if you're seeing outdated content or experiencing issues</p>
                                </div>
                                <button id="force-reload-btn" class="bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700 transition duration-200 font-medium">
                                    ðŸ”„ Clear & Reload
                                </button>
                            </div>

                            <!-- Hard Refresh Instructions -->
                            <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                                <div class="flex items-start">
                                    <div class="flex-shrink-0">
                                        <svg class="h-6 w-6 text-yellow-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                                        </svg>
                                    </div>
                                    <div class="ml-3">
                                        <h4 class="text-sm font-semibold text-yellow-900">Manual Hard Refresh</h4>
                                        <p class="mt-1 text-sm text-yellow-700">
                                            If the button above doesn't work, try a manual hard refresh:
                                        </p>
                                        <ul class="mt-2 text-sm text-yellow-700 list-disc list-inside space-y-1">
                                            <li><strong>Windows/Linux:</strong> Press <kbd class="px-2 py-1 bg-yellow-100 rounded font-mono text-xs">Ctrl + Shift + R</kbd></li>
                                            <li><strong>Mac:</strong> Press <kbd class="px-2 py-1 bg-yellow-100 rounded font-mono text-xs">Cmd + Shift + R</kbd></li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


            </main>
        </div>
    </div>

    <!-- Password Modal -->
    <div id="password-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Enter Password</h2>
            <p class="text-gray-600 mb-6">Please enter the password to access Room Displays.</p>
            <input type="password" id="room-display-password" class="w-full border rounded-lg p-3 mb-4 focus:ring-2 input-focus" placeholder="Password">
            <div class="flex space-x-4">
                <button id="password-submit" class="flex-1 btn-primary py-3 rounded-lg font-medium">Submit</button>
                <button id="password-cancel" class="flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg font-medium hover:bg-gray-400 transition duration-200">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Upload Content Modal -->
    <div id="upload-content-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Upload Display Content</h2>
                <button id="upload-modal-close" class="text-gray-400 hover:text-gray-600">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>

            <form id="upload-content-form" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Content Type</label>
                    <select id="upload-content-type" class="w-full border border-gray-300 rounded-lg px-3 py-2" required>
                        <option value="">Select content type...</option>
                        <option value="image">Image</option>
                        <option value="video">Video</option>
                        <option value="text">Text Content</option>
                        <option value="announcement">Announcement</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Content Name</label>
                    <input type="text" id="upload-content-name" class="w-full border border-gray-300 rounded-lg px-3 py-2" placeholder="Enter content name..." required>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                    <textarea id="upload-content-description" class="w-full border border-gray-300 rounded-lg px-3 py-2" rows="3" placeholder="Enter content description..."></textarea>
                </div>

                <!-- File Upload Section -->
                <div id="file-upload-section" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Upload File</label>
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                        <input type="file" id="upload-file-input" class="hidden" accept="image/*,video/*">
                        <div id="upload-drop-zone" class="cursor-pointer">
                            <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                                <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <p class="mt-2 text-sm text-gray-600">
                                <span class="font-medium text-blue-600 hover:text-blue-500">Click to upload</span> or drag and drop
                            </p>
                            <p class="text-xs text-gray-500">PNG, JPG, GIF up to 10MB for images, MP4 up to 50MB for videos</p>
                        </div>
                        <div id="upload-preview" class="hidden mt-4">
                            <div class="flex items-center justify-center space-x-2">
                                <div class="text-sm text-gray-600" id="upload-file-name"></div>
                                <button type="button" id="upload-remove-file" class="text-red-500 hover:text-red-700">
                                    <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Text Content Section -->
                <div id="text-content-section" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Text Content</label>
                    <textarea id="upload-text-content" class="w-full border border-gray-300 rounded-lg px-3 py-2" rows="6" placeholder="Enter your text content here..."></textarea>
                </div>

                <div class="flex justify-end space-x-4">
                    <button type="button" id="upload-cancel-btn" class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition duration-200">
                        Cancel
                    </button>
                    <button type="submit" id="upload-submit-btn" class="px-6 py-2 btn-primary rounded-lg text-white hover:bg-opacity-90 transition duration-200">
                        <span id="upload-btn-text">Upload Content</span>
                        <svg id="upload-spinner" class="hidden animate-spin h-4 w-4 ml-2 inline" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Configure Display Modal -->
    <div id="configure-display-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-2xl">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Configure Room Display</h2>
                <button id="configure-modal-close" class="text-gray-400 hover:text-gray-600">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>

            <form id="configure-display-form" class="space-y-6">
                <input type="hidden" id="configure-display-id">

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Display Name</label>
                    <input type="text" id="configure-display-name" class="w-full border border-gray-300 rounded-lg px-3 py-2" required>
                    <p class="text-xs text-gray-500 mt-1">The name shown on the display screen</p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Status Message</label>
                    <textarea id="configure-status-message" class="w-full border border-gray-300 rounded-lg px-3 py-2" rows="3" placeholder="Enter a custom message to display..."></textarea>
                    <p class="text-xs text-gray-500 mt-1">Optional message to show on the display</p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Current Status</label>
                    <select id="configure-current-status" class="w-full border border-gray-300 rounded-lg px-3 py-2">
                        <option value="available">Available</option>
                        <option value="occupied">Occupied</option>
                        <option value="maintenance">Maintenance</option>
                        <option value="reserved">Reserved</option>
                    </select>
                </div>

                <div class="flex items-center">
                    <input type="checkbox" id="configure-is-enabled" class="h-4 w-4 text-green-600 rounded border-gray-300 focus:ring-green-500">
                    <label for="configure-is-enabled" class="ml-2 text-sm text-gray-700">Display Enabled</label>
                    <p class="ml-2 text-xs text-gray-500">(Uncheck to temporarily disable this display)</p>
                </div>

                <div class="flex justify-end space-x-4 pt-4 border-t border-gray-200">
                    <button type="button" id="configure-cancel-btn" class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition duration-200">
                        Cancel
                    </button>
                    <button type="submit" class="px-6 py-2 btn-primary rounded-lg text-white hover:bg-opacity-90 transition duration-200">
                        Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Schedule Content Modal -->
    <div id="schedule-content-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-lg">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Schedule Content</h2>
                <button id="schedule-modal-close" class="text-gray-400 hover:text-gray-600">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>

            <form id="schedule-content-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Select Content</label>
                    <select id="schedule-content-select" class="w-full border border-gray-300 rounded-lg px-3 py-2" required>
                        <option value="">Choose content...</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Select Rooms</label>
                    <div id="schedule-rooms-checkboxes" class="space-y-2 max-h-32 overflow-y-auto border border-gray-200 rounded-lg p-3">
                        <!-- Room checkboxes will be populated here -->
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Start Time</label>
                        <input type="time" id="schedule-start-time" class="w-full border border-gray-300 rounded-lg px-3 py-2" value="09:00">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">End Time</label>
                        <input type="time" id="schedule-end-time" class="w-full border border-gray-300 rounded-lg px-3 py-2" value="17:00">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Start Date</label>
                        <input type="date" id="schedule-start-date" class="w-full border border-gray-300 rounded-lg px-3 py-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">End Date</label>
                        <input type="date" id="schedule-end-date" class="w-full border border-gray-300 rounded-lg px-3 py-2">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Days of Week</label>
                    <div class="flex flex-wrap gap-2">
                        <label class="flex items-center">
                            <input type="checkbox" value="monday" class="schedule-day-checkbox mr-2"> Mon
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" value="tuesday" class="schedule-day-checkbox mr-2"> Tue
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" value="wednesday" class="schedule-day-checkbox mr-2"> Wed
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" value="thursday" class="schedule-day-checkbox mr-2"> Thu
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" value="friday" class="schedule-day-checkbox mr-2"> Fri
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" value="saturday" class="schedule-day-checkbox mr-2"> Sat
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" value="sunday" class="schedule-day-checkbox mr-2"> Sun
                        </label>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Display Duration (seconds)</label>
                    <input type="number" id="schedule-duration" class="w-full border border-gray-300 rounded-lg px-3 py-2" value="30" min="5" max="300">
                </div>

                <div class="flex justify-end space-x-4 pt-4">
                    <button type="button" id="schedule-cancel-btn" class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition duration-200">
                        Cancel
                    </button>
                    <button type="submit" class="px-6 py-2 btn-primary rounded-lg text-white hover:bg-opacity-90 transition duration-200">
                        Schedule Content
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit User Profile Modal -->
    <div id="edit-user-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md m-4">
            <div class="flex justify-between items-center p-6 border-b border-gray-200">
                <h2 class="text-2xl font-bold text-gray-800">Edit User Profile</h2>
                <button id="edit-user-modal-close" class="text-gray-400 hover:text-gray-600">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <form id="edit-user-form" class="p-6 space-y-4">
                <input type="hidden" id="edit-user-id">

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Name</label>
                    <input type="text" id="edit-user-name" required
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                    <input type="email" id="edit-user-email" required
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Phone</label>
                    <input type="tel" id="edit-user-phone"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">New Password (leave blank to keep current)</label>
                    <input type="password" id="edit-user-password" minlength="6"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                           placeholder="Enter new password or leave blank">
                </div>

                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" id="edit-user-cancel" class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition duration-200">
                        Cancel
                    </button>
                    <button type="submit" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition duration-200">
                        Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Startup User Modal (FIX 3) -->
    <div id="edit-startup-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md m-4">
            <div class="flex justify-between items-center p-6 border-b border-gray-200">
                <h2 class="text-2xl font-bold text-gray-800">Edit Startup User</h2>
                <button id="edit-startup-modal-close" class="text-gray-400 hover:text-gray-600">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <form id="edit-startup-form" class="p-6 space-y-4">
                <input type="hidden" id="edit-startup-id">

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Startup Name</label>
                    <input type="text" id="edit-startup-name" required
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Contact Person</label>
                    <input type="text" id="edit-startup-contact" required
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                    <input type="email" id="edit-startup-email" required
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Phone</label>
                    <input type="tel" id="edit-startup-phone"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                </div>

                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" id="edit-startup-cancel" class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition duration-200">
                        Cancel
                    </button>
                    <button type="submit" class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition duration-200">
                        Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Booking Modal (Admin) -->
    <div id="edit-booking-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl m-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center p-6 border-b border-gray-200">
                <h2 class="text-2xl font-bold text-gray-800">Edit Booking</h2>
                <button id="edit-booking-modal-close" class="text-gray-400 hover:text-gray-600">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>

            <form id="edit-booking-form" class="p-6 space-y-6">
                <input type="hidden" id="edit-booking-id">

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Room *</label>
                        <select id="edit-booking-room" class="w-full border border-gray-300 rounded-lg px-3 py-2" required>
                            <option value="">Select a room</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Status *</label>
                        <select id="edit-booking-status" class="w-full border border-gray-300 rounded-lg px-3 py-2" required>
                            <option value="confirmed">Confirmed</option>
                            <option value="cancelled">Cancelled</option>
                            <option value="completed">Completed</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Date *</label>
                        <input type="date" id="edit-booking-date" class="w-full border border-gray-300 rounded-lg px-3 py-2" required>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Start Time *</label>
                        <input type="time" id="edit-booking-time" class="w-full border border-gray-300 rounded-lg px-3 py-2" required>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Duration (hours) *</label>
                        <input type="number" id="edit-booking-duration" min="1" max="8" class="w-full border border-gray-300 rounded-lg px-3 py-2" required>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Startup</label>
                        <input type="text" id="edit-booking-startup" class="w-full border border-gray-300 rounded-lg px-3 py-2 bg-gray-50" readonly>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Equipment Notes</label>
                    <textarea id="edit-booking-equipment" class="w-full border border-gray-300 rounded-lg px-3 py-2" rows="3" placeholder="Equipment requirements or notes..."></textarea>
                </div>

                <div class="flex items-center">
                    <input type="checkbox" id="edit-booking-confidential" class="h-4 w-4 text-green-600 rounded border-gray-300 focus:ring-green-500">
                    <label for="edit-booking-confidential" class="ml-2 text-sm text-gray-700">Confidential Meeting</label>
                </div>

                <div class="flex justify-end space-x-4 pt-4 border-t border-gray-200">
                    <button type="button" id="edit-booking-cancel-btn" class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition duration-200">
                        Cancel
                    </button>
                    <button type="submit" class="px-6 py-2 btn-primary rounded-lg text-white hover:bg-opacity-90 transition duration-200">
                        Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Cancel Booking Modal (Admin - Schedule Tab) -->
    <div id="cancel-booking-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md m-4">
            <div class="flex justify-between items-center p-6 border-b border-gray-200">
                <h2 class="text-2xl font-bold text-gray-800">Cancel Booking</h2>
                <button id="cancel-booking-modal-close" class="text-gray-400 hover:text-gray-600">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <form id="cancel-booking-form" class="p-6 space-y-4">
                <input type="hidden" id="cancel-booking-id">

                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
                    <div class="flex items-start">
                        <svg class="w-5 h-5 text-yellow-600 mt-0.5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-1.964-1.333-2.732 0L3.732 16c-.77 1.333.192 3 1.732 3z"></path>
                        </svg>
                        <div>
                            <h3 class="text-sm font-medium text-yellow-800 mb-1">Warning</h3>
                            <p class="text-sm text-yellow-700">This action will cancel the booking and notify the startup. Please provide a reason for cancellation.</p>
                        </div>
                    </div>
                </div>

                <div id="cancel-booking-details" class="bg-gray-50 rounded-lg p-4 mb-4">
                    <!-- Booking details will be populated here -->
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Cancellation Reason <span class="text-red-500">*</span></label>
                    <textarea id="cancel-booking-reason" required class="w-full border border-gray-300 rounded-lg px-3 py-2" rows="4" placeholder="Please provide a reason for cancelling this booking..."></textarea>
                    <p class="text-xs text-gray-500 mt-1">This reason will be visible to the startup.</p>
                </div>

                <div class="flex justify-end space-x-4 pt-4 border-t border-gray-200">
                    <button type="button" id="cancel-booking-cancel-btn" class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition duration-200">
                        Keep Booking
                    </button>
                    <button type="submit" class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition duration-200">
                        Cancel Booking
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Booking Confirmation Modal (Admin Only) -->
    <div id="delete-booking-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md m-4">
            <div class="flex justify-between items-center p-6 border-b border-gray-200">
                <h2 class="text-2xl font-bold text-red-600">Delete Booking</h2>
                <button id="delete-booking-modal-close" class="text-gray-400 hover:text-gray-600">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>

            <div class="p-6">
                <div class="mb-6">
                    <div class="flex items-center justify-center w-16 h-16 mx-auto bg-red-100 rounded-full mb-4">
                        <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                        </svg>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900 text-center mb-2">
                        Are you sure you want to delete this booking?
                    </h3>
                    <p class="text-gray-600 text-center mb-4">
                        <strong id="delete-booking-room" class="text-gray-900"></strong><br>
                        <span id="delete-booking-startup" class="text-sm text-gray-500"></span>
                    </p>
                </div>

                <div class="bg-red-50 border-l-4 border-red-400 p-4 mb-6">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <svg class="h-5 w-5 text-red-400" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-red-700">
                                <strong>Warning:</strong> This action will:
                            </p>
                            <ul class="list-disc list-inside text-sm text-red-700 mt-2 space-y-1">
                                <li>Permanently delete this booking from the database</li>
                                <li>This action cannot be undone</li>
                                <li>Consider using "Cancel Booking" instead to keep a record</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="flex space-x-3">
                    <button id="delete-booking-cancel" class="flex-1 px-6 py-3 border border-gray-300 rounded-lg text-gray-700 font-semibold hover:bg-gray-50 transition duration-200">
                        Keep Booking
                    </button>
                    <button id="delete-booking-confirm" class="flex-1 px-6 py-3 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 transition duration-200">
                        Delete Permanently
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Startup Confirmation Modal (Admin Only) -->
    <div id="delete-startup-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md m-4">
            <div class="flex justify-between items-center p-6 border-b border-gray-200">
                <h2 class="text-2xl font-bold text-red-600">Delete Startup</h2>
                <button id="delete-startup-modal-close" class="text-gray-400 hover:text-gray-600">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>

            <div class="p-6">
                <div class="mb-6">
                    <div class="flex items-center justify-center w-16 h-16 mx-auto mb-4 bg-red-100 rounded-full">
                        <svg class="w-8 h-8 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                        </svg>
                    </div>
                    <p class="text-center text-gray-700 mb-4">
                        Are you sure you want to delete <strong id="delete-startup-name" class="text-red-600"></strong>?
                    </p>
                    <p class="text-center text-sm text-gray-600 mb-4">
                        This action will:
                    </p>
                    <ul class="text-sm text-gray-600 space-y-2 mb-4">
                        <li class="flex items-start">
                            <svg class="w-5 h-5 text-red-500 mr-2 flex-shrink-0 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                            Delete the startup record from the database
                        </li>
                        <li class="flex items-start">
                            <svg class="w-5 h-5 text-red-500 mr-2 flex-shrink-0 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                            Delete the associated user account (if exists)
                        </li>
                        <li class="flex items-start">
                            <svg class="w-5 h-5 text-red-500 mr-2 flex-shrink-0 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                            Cancel all future bookings for this startup
                        </li>
                    </ul>
                    <p class="text-center text-sm font-semibold text-red-600">
                        This action cannot be undone!
                    </p>
                </div>

                <div class="flex space-x-3">
                    <button id="delete-startup-cancel" class="flex-1 px-6 py-3 border border-gray-300 rounded-lg text-gray-700 font-semibold hover:bg-gray-50 transition duration-200">
                        Keep Startup
                    </button>
                    <button id="delete-startup-confirm" class="flex-1 px-6 py-3 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 transition duration-200">
                        Delete Startup
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete User Confirmation Modal (Admin Only) -->
    <div id="delete-user-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md m-4">
            <div class="flex justify-between items-center p-6 border-b border-gray-200">
                <h2 class="text-2xl font-bold text-red-600">Delete User</h2>
                <button id="delete-user-modal-close" class="text-gray-400 hover:text-gray-600">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>

            <div class="p-6">
                <div class="mb-6">
                    <div class="flex items-center justify-center w-16 h-16 mx-auto bg-red-100 rounded-full mb-4">
                        <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                        </svg>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900 text-center mb-2">
                        Are you sure you want to delete this user?
                    </h3>
                    <p class="text-gray-600 text-center mb-4">
                        <strong id="delete-user-name" class="text-gray-900"></strong><br>
                        <span id="delete-user-email" class="text-sm text-gray-500"></span>
                    </p>
                </div>

                <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <svg class="h-5 w-5 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-yellow-700">
                                <strong>Warning:</strong> This action will:
                            </p>
                            <ul class="list-disc list-inside text-sm text-yellow-700 mt-2 space-y-1">
                                <li>Permanently delete the user account</li>
                                <li>Cancel all future bookings made by this user</li>
                                <li>This action cannot be undone</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="flex space-x-3">
                    <button id="delete-user-cancel" class="flex-1 px-6 py-3 border border-gray-300 rounded-lg text-gray-700 font-semibold hover:bg-gray-50 transition duration-200">
                        Cancel
                    </button>
                    <button id="delete-user-confirm" class="flex-1 px-6 py-3 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 transition duration-200">
                        Delete User
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Room Display Preview Modal -->
    <div id="room-preview-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-6xl max-h-[95vh] overflow-y-auto m-4">
            <div class="flex justify-between items-center p-6 border-b border-gray-200">
                <div>
                    <h2 class="text-2xl font-bold text-gray-800" id="preview-room-title">Room Display Preview</h2>
                    <p class="text-gray-600" id="preview-room-subtitle">Live preview of room display</p>
                </div>
                <button id="preview-modal-close" class="text-gray-400 hover:text-gray-600">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>

            <!-- ISSUE 2 FIX: Vertical stacked layout (NO side-by-side) to prevent overlapping -->
            <div class="p-4 md:p-6">
                <div class="flex flex-col gap-6">
                    <!-- Live Preview Display - FIXED: Full width, always on top -->
                    <div class="w-full">
                        <div class="bg-gray-900 rounded-lg p-4 md:p-6 text-white min-h-[300px] md:min-h-[400px]" id="room-display-preview">
                            <!-- Room display content will be rendered here -->
                            <div class="text-center text-gray-400 py-20">
                                Loading room display preview...
                            </div>
                        </div>

                        <!-- Display Mode Controls -->
                        <div class="mt-4 flex flex-wrap justify-center gap-2 md:gap-4" data-admin-only>
                            <button class="preview-mode-btn active px-3 md:px-4 py-2 rounded-lg bg-blue-600 text-white text-xs md:text-sm font-medium" data-mode="live">
                                Live Status
                            </button>
                            <button class="preview-mode-btn px-3 md:px-4 py-2 rounded-lg bg-gray-200 text-gray-700 text-xs md:text-sm font-medium hover:bg-gray-300" data-mode="text">
                                Text Only
                            </button>
                            <button class="preview-mode-btn px-3 md:px-4 py-2 rounded-lg bg-gray-200 text-gray-700 text-xs md:text-sm font-medium hover:bg-gray-300" data-mode="image">
                                Image Mode
                            </button>
                        </div>
                    </div>

                    <!-- Control Panel - FIXED: Full width, always below preview -->
                    <div class="w-full space-y-4 md:space-y-6">
                        <!-- Room Status Control -->
                        <div class="bg-gray-50 rounded-lg p-4" data-admin-only>
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Room Status Control</h3>
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Current Status</label>
                                    <select id="preview-status-select" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm">
                                        <option value="available">Available</option>
                                        <option value="occupied">Occupied</option>
                                        <option value="maintenance">Maintenance</option>
                                        <option value="reserved">Reserved</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Status Message</label>
                                    <input type="text" id="preview-status-message" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm" placeholder="Optional message...">
                                </div>
                                <button id="update-preview-status" class="w-full btn-primary py-2 rounded-lg text-white text-sm font-medium hover:bg-opacity-90 transition duration-200">
                                    Update Status
                                </button>
                            </div>
                        </div>

                        <!-- Current Booking Info -->
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Current Booking</h3>
                            <div id="current-booking-info">
                                <div class="text-center text-gray-500 py-4">Loading booking information...</div>
                            </div>
                        </div>

                        <!-- Next Booking Info -->
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Next Booking</h3>
                            <div id="next-booking-info">
                                <div class="text-center text-gray-500 py-4">Loading next booking...</div>
                            </div>
                        </div>

                        <!-- Content Preview Controls -->
                        <div class="bg-gray-50 rounded-lg p-4" data-admin-only>
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Content Preview</h3>
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Select Content</label>
                                    <select id="preview-content-select" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm">
                                        <option value="">Default display</option>
                                    </select>
                                </div>
                                <button id="preview-content-btn" class="w-full bg-gray-600 text-white py-2 rounded-lg text-sm font-medium hover:bg-gray-700 transition duration-200">
                                    Preview Content
                                </button>
                            </div>
                        </div>

                        <!-- Refresh Controls -->
                        <div class="flex space-x-2">
                            <button id="refresh-preview-btn" class="flex-1 bg-gray-100 text-gray-700 py-2 rounded-lg text-sm font-medium hover:bg-gray-200 transition duration-200">
                                <svg class="h-4 w-4 inline mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                                </svg>
                                Refresh
                            </button>
                            <button id="fullscreen-preview-btn" class="flex-1 bg-green-600 text-white py-2 rounded-lg text-sm font-medium hover:bg-green-700 transition duration-200">
                                <svg class="h-4 w-4 inline mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"/>
                                </svg>
                                Fullscreen
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tablet View Container -->
    <div id="tablet-view-container" class="fixed inset-0 bg-gray-900 text-white p-8 flex-col justify-center items-center hidden z-50">
        <!-- Tablet content will be inserted here -->
    </div>

    <!-- JavaScript -->
    <script>
        // ===== SUPABASE CONFIGURATION =====
        const SUPABASE_URL = 'https://ylmitcrmtdjbomkvryzh.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlsbWl0Y3JtdGRqYm9ta3ZyeXpoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg2OTU0MTgsImV4cCI6MjA3NDI3MTQxOH0.gBUdTLqCOVJxKWdQSelTK_axjkyUYzYEXmsnbJCX9WA';

        // Create Supabase client with automatic session refresh enabled
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
            auth: {
                autoRefreshToken: true,  // Automatically refresh expired tokens
                persistSession: true,     // Persist session in localStorage
                detectSessionInUrl: true  // Detect session from URL (for OAuth)
            }
        });

        console.log('âœ… Supabase client initialized with auto-refresh enabled');

        // ===== AGGRESSIVE CACHE BUSTING ON STARTUP =====
        /**
         * Runs IMMEDIATELY on page load and ties the cached state to the build timestamp.
         * If the stored build ID doesn't match the current one, clear storage and reload.
         */
        (function aggressiveCacheBusting() {
            const VERSION_KEY = 'nic_app_build_id';

            try {
                const metaVersion = document.querySelector('meta[name="app-version"]');
                const metaTimestamp = document.querySelector('meta[name="build-timestamp"]');

                const appVersion = metaVersion ? metaVersion.content : '2.0.0';
                const buildTimestamp = metaTimestamp ? metaTimestamp.content : 'dev';

                const currentBuildId = `${appVersion}::${buildTimestamp}`;
                const storedBuildId = localStorage.getItem(VERSION_KEY);

                console.log('ðŸ” [Cache Check] Stored build ID:', storedBuildId);
                console.log('ðŸ” [Cache Check] Current build ID:', currentBuildId);

                if (storedBuildId && storedBuildId !== currentBuildId) {
                    console.log('ðŸ”„ [Cache Check] Build mismatch detected! Clearing cache and reloading...');

                    // Clear localStorage and sessionStorage
                    localStorage.clear();
                    sessionStorage.clear();

                    // Persist new build ID so we don't loop
                    localStorage.setItem(VERSION_KEY, currentBuildId);

                    // Force hard reload (bypass cache)
                    window.location.reload(true);
                    return;
                }

                if (!storedBuildId) {
                    console.log('âœ… [Cache Check] First load, storing build ID:', currentBuildId);
                    localStorage.setItem(VERSION_KEY, currentBuildId);
                }

                console.log('âœ… [Cache Check] Build ID match, continuing...');

            } catch (error) {
                console.error('âŒ [Cache Check] Error during cache check:', error);
            }
        })();

        // ===== GLOBAL VARIABLES =====
        let currentUser = null;
        let currentStartup = null;
        let allRooms = [];
        let allBookings = [];
        let allStartups = [];

        // Real-time subscription channels
        let usersChannel = null;
        let startupsChannel = null;
        let bookingsChannel = null;
        let roomsChannel = null;

        // Subscription reconnection tracking
        let subscriptionReconnectAttempts = {
            users: 0,
            startups: 0,
            bookings: 0,
            rooms: 0
        };
        const MAX_RECONNECT_ATTEMPTS = 5;
        const RECONNECT_BASE_DELAY = 2000; // 2 seconds

        // Periodic data refresh interval
        let dashboardRefreshInterval = null;

        // ===== SESSION VALIDATION WRAPPER =====

        /**
         * Validates session before executing a database query
         * Returns null if session is invalid, otherwise returns the session
         */
        async function validateSession() {
            try {
                const { data: { session }, error } = await supabaseClient.auth.getSession();

                if (error) {
                    console.error('âŒ [Session] Error getting session:', error);
                    return null;
                }

                if (!session) {
                    console.warn('âš ï¸ [Session] No active session found');
                    return null;
                }

                // Check if token is about to expire (within 5 minutes)
                const expiresAt = session.expires_at;
                const now = Math.floor(Date.now() / 1000);
                const timeUntilExpiry = expiresAt - now;

                if (timeUntilExpiry < 300) { // Less than 5 minutes
                    console.log('âš ï¸ [Session] Token expiring soon, refreshing...');
                    const { data: { session: newSession }, error: refreshError } = await supabaseClient.auth.refreshSession();

                    if (refreshError) {
                        console.error('âŒ [Session] Failed to refresh session:', refreshError);
                        return null;
                    }

                    console.log('âœ… [Session] Session refreshed successfully');
                    return newSession;
                }

                return session;
            } catch (error) {
                console.error('âŒ [Session] Unexpected error during validation:', error);
                return null;
            }
        }

        // ===== REAL-TIME DATABASE SYNCHRONIZATION =====

        /**
         * Set up real-time subscriptions for database changes with automatic reconnection
         * This enables automatic UI updates when data changes in Supabase
         */
        function setupRealtimeSubscriptions() {
            console.log('ðŸ”„ [Realtime] Setting up real-time subscriptions...');

            // Unsubscribe from existing channels if any
            if (usersChannel) {
                supabaseClient.removeChannel(usersChannel);
                usersChannel = null;
            }
            if (startupsChannel) {
                supabaseClient.removeChannel(startupsChannel);
                startupsChannel = null;
            }
            if (bookingsChannel) {
                supabaseClient.removeChannel(bookingsChannel);
                bookingsChannel = null;
            }
            if (roomsChannel) {
                supabaseClient.removeChannel(roomsChannel);
                roomsChannel = null;
            }

            // Subscribe to users table changes with enhanced error handling
            usersChannel = supabaseClient
                .channel('users-changes')
                .on(
                    'postgres_changes',
                    {
                        event: '*', // Listen to all events (INSERT, UPDATE, DELETE)
                        schema: 'public',
                        table: 'users'
                    },
                    (payload) => {
                        console.log('ðŸ”” [Realtime] Users table changed:', payload);
                        handleUsersTableChange(payload);
                    }
                )
                .subscribe((status) => {
                    handleSubscriptionStatus('users', status, usersChannel);
                });

            // Subscribe to startups table changes with enhanced error handling
            startupsChannel = supabaseClient
                .channel('startups-changes')
                .on(
                    'postgres_changes',
                    {
                        event: '*', // Listen to all events (INSERT, UPDATE, DELETE)
                        schema: 'public',
                        table: 'startups'
                    },
                    (payload) => {
                        console.log('ðŸ”” [Realtime] Startups table changed:', payload);
                        handleStartupsTableChange(payload);
                    }
                )
                .subscribe((status) => {
                    handleSubscriptionStatus('startups', status, startupsChannel);
                });

            // Subscribe to bookings table changes with enhanced error handling
            bookingsChannel = supabaseClient
                .channel('bookings-changes')
                .on(
                    'postgres_changes',
                    {
                        event: '*', // Listen to all events (INSERT, UPDATE, DELETE)
                        schema: 'public',
                        table: 'bookings'
                    },
                    (payload) => {
                        console.log('ðŸ”” [Realtime] Bookings table changed:', payload);
                        handleBookingsTableChange(payload);
                    }
                )
                .subscribe((status) => {
                    handleSubscriptionStatus('bookings', status, bookingsChannel);
                });

            // Subscribe to rooms table changes with enhanced error handling
            roomsChannel = supabaseClient
                .channel('rooms-changes')
                .on(
                    'postgres_changes',
                    {
                        event: '*', // Listen to all events (INSERT, UPDATE, DELETE)
                        schema: 'public',
                        table: 'rooms'
                    },
                    (payload) => {
                        console.log('ðŸ”” [Realtime] Rooms table changed:', payload);
                        handleRoomsTableChange(payload);
                    }
                )
                .subscribe((status) => {
                    handleSubscriptionStatus('rooms', status, roomsChannel);
                });
        }

        /**
         * Handle subscription status changes with automatic reconnection
         * Handles all subscription states: SUBSCRIBED, CHANNEL_ERROR, TIMED_OUT, CLOSED
         */
        function handleSubscriptionStatus(tableName, status, channel) {
            console.log(`ðŸ“¡ [Realtime] ${tableName} subscription status:`, status);

            if (status === 'SUBSCRIBED') {
                console.log(`âœ… [Realtime] Successfully subscribed to ${tableName} table changes`);
                // Reset reconnection attempts on successful subscription
                subscriptionReconnectAttempts[tableName] = 0;

            } else if (status === 'CHANNEL_ERROR' || status === 'TIMED_OUT' || status === 'CLOSED') {
                console.error(`âŒ [Realtime] ${tableName} subscription ${status}`);

                // Attempt to reconnect with exponential backoff
                const attempts = subscriptionReconnectAttempts[tableName];

                if (attempts < MAX_RECONNECT_ATTEMPTS) {
                    const delay = RECONNECT_BASE_DELAY * Math.pow(2, attempts);
                    subscriptionReconnectAttempts[tableName]++;

                    console.log(`ðŸ”„ [Realtime] Attempting to reconnect ${tableName} in ${delay}ms (attempt ${attempts + 1}/${MAX_RECONNECT_ATTEMPTS})`);

                    setTimeout(() => {
                        console.log(`ðŸ”„ [Realtime] Reconnecting ${tableName} subscription...`);
                        setupRealtimeSubscriptions();
                    }, delay);
                } else {
                    console.error(`âŒ [Realtime] Max reconnection attempts reached for ${tableName}. Manual refresh required.`);
                    // Show user-friendly error message
                    showNotification(`Real-time updates for ${tableName} are temporarily unavailable. Please refresh the page.`, 'warning');
                }
            }
        }

        /**
         * Start periodic dashboard data refresh
         * Refreshes dashboard statistics every 5 minutes as a fallback
         * Only refreshes if user is on the dashboard page
         */
        function startDashboardAutoRefresh() {
            // Clear existing interval if any
            if (dashboardRefreshInterval) {
                clearInterval(dashboardRefreshInterval);
            }

            console.log('â° [Dashboard] Starting auto-refresh (every 5 minutes)');

            // Refresh every 5 minutes
            dashboardRefreshInterval = setInterval(async () => {
                const currentPage = window.location.hash;

                // Only refresh if on dashboard page
                if (currentPage === '#dashboard' || currentPage === '' || currentPage === '#') {
                    console.log('ðŸ”„ [Auto-Refresh] Refreshing dashboard data...');

                    // Validate session before refresh
                    const session = await validateSession();
                    if (!session) {
                        console.warn('âš ï¸ [Auto-Refresh] Invalid session, stopping auto-refresh');
                        clearInterval(dashboardRefreshInterval);
                        showAuth('login');
                        return;
                    }

                    // Refresh dashboard data
                    try {
                        await loadDashboardData();
                        console.log('âœ… [Auto-Refresh] Dashboard data refreshed successfully');
                    } catch (error) {
                        console.error('âŒ [Auto-Refresh] Error refreshing dashboard:', error);
                    }
                }
            }, 5 * 60 * 1000); // 5 minutes
        }

        /**
         * Stop periodic dashboard refresh
         */
        function stopDashboardAutoRefresh() {
            if (dashboardRefreshInterval) {
                clearInterval(dashboardRefreshInterval);
                dashboardRefreshInterval = null;
                console.log('â¹ï¸ [Dashboard] Auto-refresh stopped');
            }
        }

        /**
         * Health check for real-time subscriptions
         * Verifies all subscriptions are active and reconnects if needed
         */
        async function checkRealtimeHealth() {
            console.log('ðŸ¥ [Health Check] Checking real-time subscription health...');

            const channels = [
                { name: 'users', channel: usersChannel },
                { name: 'startups', channel: startupsChannel },
                { name: 'bookings', channel: bookingsChannel },
                { name: 'rooms', channel: roomsChannel }
            ];

            let allHealthy = true;

            for (const { name, channel } of channels) {
                if (!channel) {
                    console.warn(`âš ï¸ [Health Check] ${name} channel is null`);
                    allHealthy = false;
                } else {
                    const state = channel.state;
                    console.log(`ðŸ“¡ [Health Check] ${name} channel state:`, state);

                    if (state !== 'joined') {
                        console.warn(`âš ï¸ [Health Check] ${name} channel not joined (state: ${state})`);
                        allHealthy = false;
                    }
                }
            }

            if (!allHealthy) {
                console.log('ðŸ”„ [Health Check] Some subscriptions unhealthy, reconnecting...');
                setupRealtimeSubscriptions();
            } else {
                console.log('âœ… [Health Check] All subscriptions healthy');
            }

            return allHealthy;
        }

        /**
         * Start periodic health checks for real-time subscriptions
         * Checks every 2 minutes and reconnects if needed
         */
        let healthCheckInterval = null;
        function startRealtimeHealthChecks() {
            if (healthCheckInterval) {
                clearInterval(healthCheckInterval);
            }

            console.log('ðŸ¥ [Health Check] Starting periodic health checks (every 2 minutes)');

            // Check every 2 minutes
            healthCheckInterval = setInterval(async () => {
                await checkRealtimeHealth();
            }, 2 * 60 * 1000);
        }

        /**
         * Handle changes to the users table
         * Refreshes Contact Us tab (for admin users) and Startups tab (User Management section)
         */
        async function handleUsersTableChange(payload) {
            const { eventType, old: oldRecord, new: newRecord } = payload;

            console.log('ðŸ”„ [Realtime] Users table event:', eventType);

            if (eventType === 'INSERT') {
                console.log('ðŸ”„ [Realtime] User created:', newRecord);
            } else if (eventType === 'UPDATE') {
                console.log('ðŸ”„ [Realtime] User updated:', newRecord);
            } else if (eventType === 'DELETE') {
                console.log('ðŸ”„ [Realtime] User deleted:', oldRecord);
            }

            // Refresh Contact Us tab if it's currently visible
            const contactPage = document.getElementById('contact');
            if (contactPage && !contactPage.classList.contains('hidden')) {
                console.log('ðŸ”„ [Contact Us] Refreshing admin contacts...');
                await loadContactData();
                console.log('âœ… [Contact Us] Admin contacts updated');
            }

            // Refresh Startups tab if it's currently visible and user is admin
            const startupsPage = document.getElementById('startups');
            if (startupsPage && !startupsPage.classList.contains('hidden') && currentUser?.role === 'admin') {
                console.log('ðŸ”„ [Startups] Refreshing user management...');
                await loadStartupsData();
                console.log('âœ… [Startups] User management updated');
            }
        }

        /**
         * Handle changes to the startups table
         * Refreshes Startups tab (Registered Startups section) and Contact Us tab (for admin view)
         */
        async function handleStartupsTableChange(payload) {
            const { eventType, old: oldRecord, new: newRecord } = payload;

            console.log('ðŸ”„ [Realtime] Startups table event:', eventType);

            if (eventType === 'INSERT') {
                console.log('ðŸ”„ [Realtime] Startup created:', newRecord);
            } else if (eventType === 'UPDATE') {
                console.log('ðŸ”„ [Realtime] Startup updated:', newRecord);
            } else if (eventType === 'DELETE') {
                console.log('ðŸ”„ [Realtime] Startup deleted:', oldRecord);
            }

            // Refresh Startups tab if it's currently visible and user is admin
            const startupsPage = document.getElementById('startups');
            if (startupsPage && !startupsPage.classList.contains('hidden') && currentUser?.role === 'admin') {
                console.log('ðŸ”„ [Startups] Refreshing registered startups...');
                await loadStartupsData();
                console.log('âœ… [Startups] Registered startups updated');
            }

            // Refresh Contact Us tab if it's currently visible (admin view shows startups list)
            const contactPage = document.getElementById('contact');
            if (contactPage && !contactPage.classList.contains('hidden') && currentUser?.role === 'admin') {
                console.log('ðŸ”„ [Contact Us] Refreshing startups list...');
                await loadContactData();
                console.log('âœ… [Contact Us] Startups list updated');
            }
        }

        /**
         * Handle changes to the bookings table
         * Refreshes Dashboard, My Bookings, and Schedule tabs
         */
        async function handleBookingsTableChange(payload) {
            const { eventType, old: oldRecord, new: newRecord } = payload;

            console.log('ðŸ”„ [Realtime] Bookings table event:', eventType);

            if (eventType === 'INSERT') {
                console.log('ðŸ”„ [Realtime] Booking created:', newRecord);
            } else if (eventType === 'UPDATE') {
                console.log('ðŸ”„ [Realtime] Booking updated:', newRecord);
            } else if (eventType === 'DELETE') {
                console.log('ðŸ”„ [Realtime] Booking deleted:', oldRecord);
            }

            // Refresh Dashboard if it's currently visible
            const dashboardPage = document.getElementById('dashboard');
            if (dashboardPage && !dashboardPage.classList.contains('hidden')) {
                console.log('ðŸ”„ [Dashboard] Refreshing statistics and schedule...');
                await loadDashboardData();
                console.log('âœ… [Dashboard] Statistics and schedule updated');
            }

            // Refresh My Bookings tab if it's currently visible
            const bookingsPage = document.getElementById('my-bookings');
            if (bookingsPage && !bookingsPage.classList.contains('hidden')) {
                console.log('ðŸ”„ [My Bookings] Refreshing bookings list...');
                await loadMyBookingsData();
                console.log('âœ… [My Bookings] Bookings list updated');
            }

            // Refresh Schedule tab if it's currently visible
            const schedulePage = document.getElementById('schedule');
            if (schedulePage && !schedulePage.classList.contains('hidden')) {
                console.log('ðŸ”„ [Schedule] Refreshing calendar...');
                await loadScheduleData();
                console.log('âœ… [Schedule] Calendar updated');
            }
        }

        /**
         * Handle changes to the rooms table
         * Refreshes Room Displays tab and Book a Room tab
         */
        async function handleRoomsTableChange(payload) {
            const { eventType, old: oldRecord, new: newRecord } = payload;

            console.log('ðŸ”„ [Realtime] Rooms table event:', eventType);

            if (eventType === 'INSERT') {
                console.log('ðŸ”„ [Realtime] Room created:', newRecord);
            } else if (eventType === 'UPDATE') {
                console.log('ðŸ”„ [Realtime] Room updated:', newRecord);
            } else if (eventType === 'DELETE') {
                console.log('ðŸ”„ [Realtime] Room deleted:', oldRecord);
            }

            // Refresh Room Displays tab if it's currently visible
            const roomDisplaysPage = document.getElementById('room-displays');
            if (roomDisplaysPage && !roomDisplaysPage.classList.contains('hidden')) {
                console.log('ðŸ”„ [Room Displays] Refreshing rooms list...');
                await loadRoomDisplaysData();
                console.log('âœ… [Room Displays] Rooms list updated');
            }

            // Refresh Book a Room tab if it's currently visible
            const bookRoomPage = document.getElementById('book-room');
            if (bookRoomPage && !bookRoomPage.classList.contains('hidden')) {
                console.log('ðŸ”„ [Book a Room] Refreshing rooms list...');
                await loadBookRoomData();
                console.log('âœ… [Book a Room] Rooms list updated');
            }
        }

        /**
         * Clean up real-time subscriptions when user logs out
         */
        function cleanupRealtimeSubscriptions() {
            console.log('ðŸ”„ [Realtime] Cleaning up subscriptions...');

            if (usersChannel) {
                supabaseClient.removeChannel(usersChannel);
                usersChannel = null;
                console.log('âœ… [Realtime] Users channel unsubscribed');
            }

            if (startupsChannel) {
                supabaseClient.removeChannel(startupsChannel);
                startupsChannel = null;
                console.log('âœ… [Realtime] Startups channel unsubscribed');
            }

            if (bookingsChannel) {
                supabaseClient.removeChannel(bookingsChannel);
                bookingsChannel = null;
                console.log('âœ… [Realtime] Bookings channel unsubscribed');
            }

            if (roomsChannel) {
                supabaseClient.removeChannel(roomsChannel);
                roomsChannel = null;
                console.log('âœ… [Realtime] Rooms channel unsubscribed');
            }
        }

        // ===== UI ENHANCEMENT FUNCTIONS =====
        const triggerConfetti = () => {
            const container = document.getElementById('confetti-container');
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                if (Math.random() > 0.5) confetti.classList.add('triangle');
                confetti.style.left = `${Math.random() * 100}vw`;
                confetti.style.animationDelay = `${Math.random() * 2}s`;
                confetti.style.backgroundColor = `hsl(${Math.random() * 360}, 70%, 60%)`;
                container.appendChild(confetti);
                setTimeout(() => confetti.remove(), 3000);
            }
        };

        const getTodayDateString = () => {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        // ===== DOM ELEMENTS =====
        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app');
        const loginView = document.getElementById('login-view');
        const signupView = document.getElementById('signup-view');
        const showSignupLink = document.getElementById('show-signup');
        const showLoginLink = document.getElementById('show-login');
        const loginFormEl = document.getElementById('login-form');
        const signupFormEl = document.getElementById('signup-form');
        const loginErrorEl = document.getElementById('login-error');
        const signupErrorEl = document.getElementById('signup-error');
        const signupSuccessEl = document.getElementById('signup-success');

        // ===== UTILITY FUNCTIONS =====
        function showAuth(which = 'login') {
            authContainer?.classList.remove('hidden');
            appContainer?.classList.add('hidden');
            if (which === 'signup') {
                loginView?.classList.add('hidden');
                signupView?.classList.remove('hidden');
            } else {
                loginView?.classList.remove('hidden');
                signupView?.classList.add('hidden');
            }
        }

        function showApp() {
            authContainer?.classList.add('hidden');
            appContainer?.classList.remove('hidden');
        }

        function showPage(hash) {
            // Remove # from hash
            const pageId = hash.replace('#', '') || 'dashboard';

            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.add('hidden');
            });

            // Show selected page
            let targetPage = document.getElementById(pageId);
            if (!targetPage) {
                return showPage('#dashboard');
            }
            targetPage.classList.remove('hidden');

            // Update navigation active state
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });

            const activeLink = document.querySelector(`a[href="#${pageId}"]`);
            if (activeLink) {
                activeLink.classList.add('active');
            }

            // Update page title
            const pageTitles = {
                'dashboard': 'Dashboard',
                'startups': 'Startups',
                'booking': 'Book a Room',
                'my-bookings': 'My Bookings',
                'schedule': 'Schedule',
                'room-displays': 'Room Displays',
                'reports': 'Reports',
                'policies': 'Policies',
                'contact': 'Contact Us',
                'settings': 'Settings'
            };

            const pageTitle = document.getElementById('page-title');
            if (pageTitle) {
                pageTitle.textContent = pageTitles[pageId] || 'Dashboard';
            }

            // Load page-specific data
            loadPageData(pageId);
        }

        async function loadPageData(pageId) {
            try {
                switch(pageId) {
                    case 'dashboard':
                        await loadDashboardData();
                        break;
                    case 'startups':
                        await loadStartupsData();
                        break;
                    case 'booking':
                        await loadBookingFormData();
                        break;
                    case 'my-bookings':
                        await loadMyBookingsData();
                        break;
                    case 'schedule':
                        await loadScheduleData();
                        break;
                    case 'room-displays':
                        await loadRoomDisplaysData();
                        break;
                    case 'reports':
                        await loadReportsData();
                        break;
                    case 'contact':
                        await loadContactData();
                        break;
                    case 'settings':
                        await loadSettingsData();
                        break;
                }
            } catch (error) {
                console.error(`Error loading ${pageId} data:`, error);
            }
        }

        // ===== DASHBOARD DATA LOADING =====
        async function loadDashboardData() {
            try {
                console.log('ðŸ”„ [loadDashboardData] Loading dashboard statistics...');
                console.log('ðŸ” [DEBUG] currentUser at dashboard load:', currentUser);
                console.log('ðŸ” [DEBUG] currentUser.role at dashboard load:', currentUser?.role);

                // Validate session before loading data using the wrapper
                const session = await validateSession();
                if (!session) {
                    console.error('âŒ [loadDashboardData] No valid session, redirecting to login');
                    showAuth('login');
                    return;
                }
                console.log('âœ… [loadDashboardData] Session valid');

                // Wait for currentUser to be loaded if not yet available
                if (!currentUser) {
                    console.log('â³ [loadDashboardData] Waiting for currentUser to be loaded...');
                    // Wait up to 5 seconds for currentUser to be set
                    let waitCount = 0;
                    while (!currentUser && waitCount < 50) {
                        await new Promise(resolve => setTimeout(resolve, 100));
                        waitCount++;
                    }
                    if (!currentUser) {
                        console.error('âŒ [loadDashboardData] currentUser not loaded after 5 seconds');
                        // Show error message to user
                        const scheduleContainer = document.getElementById('today-schedule-container');
                        if (scheduleContainer) {
                            scheduleContainer.innerHTML = `
                                <div class="text-center py-8">
                                    <p class="text-red-600 font-semibold">Failed to load user data</p>
                                    <p class="text-gray-600 mt-2">Please refresh the page or try logging out and back in.</p>
                                    <button onclick="location.reload()" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                                        Refresh Page
                                    </button>
                                </div>
                            `;
                        }
                        return;
                    }
                    console.log('âœ… [loadDashboardData] currentUser loaded:', currentUser);
                }

                // ISSUE 3 FIX: Load UNIQUE startups count (not individual users)
                // Count distinct startup organizations, not individual users
                const { data: startupsData, error: startupsError } = await supabaseClient
                    .from('startups')
                    .select('id, name');

                if (startupsError) {
                    console.error('âŒ [loadDashboardData] Error loading startups:', startupsError);
                    console.error('âŒ [loadDashboardData] Error details:', startupsError.message, startupsError.code);
                    // Show error to user
                    showMessage('Failed to load startups data. Please refresh the page.', 'error');
                }

                // Count unique startups by name (e.g., "NIC ADMIN" counts as 1 even if 6 users)
                const uniqueStartups = new Set();
                if (startupsData) {
                    startupsData.forEach(startup => {
                        uniqueStartups.add(startup.name);
                    });
                }
                const startupsCount = uniqueStartups.size;

                console.log('ðŸ“Š [loadDashboardData] Total startup entries in database:', startupsData?.length || 0);
                console.log('ðŸ“Š [loadDashboardData] Unique startups (by name):', startupsCount);
                console.log('ðŸ“Š [loadDashboardData] Unique startup names:', Array.from(uniqueStartups));

                // Load upcoming bookings count (future bookings)
                const { count: upcomingCount, error: upcomingError } = await supabaseClient
                    .from('bookings')
                    .select('*', { count: 'exact', head: true })
                    .gte('booking_date', new Date().toISOString().split('T')[0]);

                if (upcomingError) {
                    console.error('âŒ [loadDashboardData] Error loading upcoming bookings count:', upcomingError);
                    console.error('âŒ [loadDashboardData] Error details:', upcomingError.message, upcomingError.code);
                }

                // Load today's bookings count
                const { count: todayCount, error: todayError } = await supabaseClient
                    .from('bookings')
                    .select('*', { count: 'exact', head: true })
                    .eq('booking_date', new Date().toISOString().split('T')[0]);

                if (todayError) {
                    console.error('âŒ [loadDashboardData] Error loading today bookings count:', todayError);
                    console.error('âŒ [loadDashboardData] Error details:', todayError.message, todayError.code);
                }

                // Load today's bookings data for schedule display
                const { data: todayBookings, error: todayBookingsError } = await supabaseClient
                    .from('bookings')
                    .select('*, startups(name)')
                    .eq('booking_date', new Date().toISOString().split('T')[0])
                    .order('start_time');

                if (todayBookingsError) {
                    console.error('âŒ [loadDashboardData] Error loading today bookings:', todayBookingsError);
                    console.error('âŒ [loadDashboardData] Error details:', todayBookingsError.message, todayBookingsError.code);
                }

                console.log('ðŸ“Š [loadDashboardData] Dashboard stats:', {
                    startups: startupsCount,
                    upcoming: upcomingCount,
                    today: todayCount,
                    todayBookingsCount: todayBookings?.length || 0
                });

                // Update dashboard stats with real-time counts
                console.log('ðŸ“Š [loadDashboardData] Updating dashboard stats...');
                updateDashboardStats(startupsCount || 0, upcomingCount || 0, todayCount || 0);

                console.log('ðŸ“Š [loadDashboardData] Updating today\'s schedule with', todayBookings?.length || 0, 'bookings');
                updateTodaySchedule(todayBookings || []);

                // Setup clickable dashboard cards for admin users
                console.log('ðŸ“Š [loadDashboardData] Setting up dashboard card click handlers...');
                setupDashboardCardClickHandlers();

                console.log('âœ… [loadDashboardData] Dashboard data loaded successfully');

            } catch (error) {
                console.error('âŒâŒâŒ [loadDashboardData] Critical error loading dashboard data:', error);
                console.error('âŒâŒâŒ [loadDashboardData] Error stack:', error.stack);

                // Show error to user
                const scheduleContainer = document.getElementById('today-schedule');
                if (scheduleContainer) {
                    scheduleContainer.innerHTML = `
                        <div class="text-center py-8">
                            <p class="text-red-600 font-semibold">Failed to load dashboard data</p>
                            <p class="text-gray-600 mt-2">${error.message}</p>
                            <button onclick="loadDashboardData()" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                                Retry
                            </button>
                        </div>
                    `;
                }
            }
        }

        function updateDashboardStats(startupsCount, upcomingBookings, todayBookings) {
            // Update stat cards
            const statsElements = document.querySelectorAll('.stat-card h3');
            if (statsElements[0]) statsElements[0].textContent = startupsCount;
            if (statsElements[1]) statsElements[1].textContent = upcomingBookings;
            if (statsElements[2]) statsElements[2].textContent = todayBookings;

            // Update available rooms count dynamically
            const availableRoomsEl = document.getElementById('available-rooms-count');
            if (availableRoomsEl) {
                availableRoomsEl.textContent = availableRooms.length;
            }
        }

        // ===== DASHBOARD STATISTICS CARDS CLICK HANDLERS (ADMIN ONLY) =====
        function setupDashboardCardClickHandlers() {
            console.log('ðŸ” [DEBUG] setupDashboardCardClickHandlers called');
            console.log('ðŸ” [DEBUG] currentUser:', currentUser);
            console.log('ðŸ” [DEBUG] currentUser.role:', currentUser?.role);
            console.log('ðŸ” [DEBUG] Is admin?', currentUser?.role === 'admin');

            // Only enable for admin users
            if (currentUser?.role !== 'admin') {
                console.log('âš ï¸ [DEBUG] User is NOT admin, removing hover effects');
                // Remove hover effects and cursor for non-admin users
                const statCards = document.querySelectorAll('.stat-card[data-admin-only]');
                statCards.forEach(card => {
                    card.classList.remove('hover:shadow-xl', 'hover:scale-105', 'cursor-pointer');
                });
                return;
            }

            console.log('âœ… [DEBUG] User IS admin, setting up click handlers');

            // Card 1: Total Startups -> Navigate to Startups tab
            const startupsCard = document.getElementById('stat-card-startups');
            startupsCard?.addEventListener('click', () => {
                console.log('ðŸ“Š Navigating to Startups tab from dashboard card');
                window.location.hash = '#startups';
            });

            // Card 2: Upcoming Bookings -> Navigate to Schedule tab
            const upcomingCard = document.getElementById('stat-card-upcoming');
            upcomingCard?.addEventListener('click', () => {
                console.log('ðŸ“Š Navigating to Schedule tab from dashboard card (Upcoming Bookings)');
                window.location.hash = '#schedule';
            });

            // Card 3: Today's Bookings -> Navigate to Schedule tab
            const todayCard = document.getElementById('stat-card-today');
            todayCard?.addEventListener('click', () => {
                console.log('ðŸ“Š Navigating to Schedule tab from dashboard card (Today\'s Bookings)');
                window.location.hash = '#schedule';
            });

            // Card 4: Available Rooms -> Navigate to Room Displays tab
            const roomsCard = document.getElementById('stat-card-rooms');
            roomsCard?.addEventListener('click', () => {
                console.log('ðŸ“Š Navigating to Room Displays tab from dashboard card');
                window.location.hash = '#room-displays';
            });

            console.log('âœ… Dashboard card click handlers enabled for admin user');
        }

        function updateTodaySchedule(bookings) {
            console.log('ðŸ“… [updateTodaySchedule] Called with', bookings?.length || 0, 'bookings');
            console.log('ðŸ“… [updateTodaySchedule] Bookings data:', bookings);

            const container = document.getElementById('today-schedule');
            if (!container) {
                console.error('âŒ [updateTodaySchedule] Container element not found!');
                return;
            }

            console.log('âœ… [updateTodaySchedule] Container element found');

            if (!bookings || bookings.length === 0) {
                console.log('ðŸ“… [updateTodaySchedule] No bookings, showing empty message');
                container.innerHTML = '<p class="text-gray-500 text-center py-8">No bookings scheduled for today.</p>';
                return;
            }

            console.log('ðŸ“… [updateTodaySchedule] Rendering', bookings.length, 'bookings');
            container.innerHTML = bookings.map(booking => `
                <div class="flex justify-between items-center p-4 bg-gray-50 rounded-lg">
                    <div>
                        <h4 class="font-semibold text-gray-800">${booking.room_name}</h4>
                        <p class="text-sm text-gray-600">${booking.start_time} - ${booking.duration}h</p>
                        ${booking.startups?.name ? `<p class="text-xs text-gray-500">${booking.startups.name}</p>` : ''}
                    </div>
                    <span class="px-3 py-1 rounded-full text-xs font-medium ${
                        booking.status === 'confirmed' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'
                    }">
                        ${booking.status}
                    </span>
                </div>
            `).join('');
            console.log('âœ… [updateTodaySchedule] Schedule updated successfully');
        }

        // ===== STARTUPS DATA LOADING =====
        async function loadStartupsData() {
            // Wait for currentUser to be loaded if not yet available
            if (!currentUser) {
                console.log('â³ [loadStartupsData] Waiting for currentUser to be loaded...');
                let waitCount = 0;
                while (!currentUser && waitCount < 50) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    waitCount++;
                }
                if (!currentUser) {
                    console.error('âŒ [loadStartupsData] currentUser not loaded after 5 seconds');
                    return;
                }
            }

            if (currentUser?.role !== 'admin') return;

            try {
                console.log('Loading startups data...');

                // Load all users with their startups
                const { data: users, error } = await supabaseClient
                    .from('users')
                    .select(`
                        *,
                        startups (
                            id,
                            name,
                            contact_person,
                            email,
                            phone
                        )
                    `)
                    .order('created_at', { ascending: false });

                if (error) {
                    console.error('Error loading users:', error);
                    throw error;
                }

                console.log('Users loaded:', users);
                console.log('Users count:', users?.length);

                displayUsersTable(users || []);

                // Load startups list
                const { data: startups, error: startupsError } = await supabaseClient
                    .from('startups')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (!startupsError) {
                    displayStartupsList(startups || []);
                }

            } catch (error) {
                console.error('Error loading startups data:', error);
            }
        }

        function displayUsersTable(users) {
            const tbody = document.getElementById('users-table-body');
            if (!tbody) return;

            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">No users found.</td></tr>';
                return;
            }

            tbody.innerHTML = users.map(user => `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div>
                            <div class="text-sm font-medium text-gray-900">${user.name || 'N/A'}</div>
                            <div class="text-sm text-gray-500">${user.email}</div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">${user.startups?.name || 'No startup'}</div>
                        <div class="text-sm text-gray-500">${user.startups?.phone || ''}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${
                            user.role === 'admin' ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'
                        }">
                            ${user.role}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">
                            Active
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="editUserProfile('${user.id}', '${user.name}', '${user.email}', '${user.phone || ''}')"
                                class="text-blue-600 hover:text-blue-900 mr-3">
                            Edit
                        </button>
                        <button onclick="toggleUserRole('${user.id}', '${user.role}')"
                                class="text-indigo-600 hover:text-indigo-900 mr-3">
                            ${user.role === 'admin' ? 'Make Startup' : 'Make Admin'}
                        </button>
                        ${currentUser?.role === 'admin' && user.id !== currentUser.id ? `
                            <button onclick="showDeleteUserModal('${user.id}', '${user.name.replace(/'/g, "\\'")}', '${user.email}')"
                                    class="text-red-600 hover:text-red-900">
                                Delete
                            </button>
                        ` : ''}
                    </td>
                </tr>
            `).join('');
        }

        function displayStartupsList(startups) {
            const container = document.getElementById('startups-list');
            if (!container) return;

            if (startups.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 py-8">No startups found.</p>';
                return;
            }

            container.innerHTML = startups.map(startup => `
                <div class="bg-gray-50 p-6 rounded-xl border">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h3 class="text-xl font-bold text-gray-800">${startup.name}</h3>
                            <p class="text-gray-600">${startup.contact_person}</p>
                            <p class="text-sm text-gray-500">${startup.email}</p>
                            <p class="text-sm text-gray-500">${startup.phone}</p>
                        </div>
                        <div class="text-right flex flex-col items-end space-y-2">
                            <p class="text-xs text-gray-500">
                                Joined: ${new Date(startup.created_at).toLocaleDateString()}
                            </p>
                            ${currentUser?.role === 'admin' ? `
                                <button
                                    onclick="showDeleteStartupModal('${startup.id}', '${startup.name.replace(/'/g, "\\'")}', '${startup.user_id || ''}')"
                                    class="px-4 py-2 bg-red-600 text-white text-sm font-medium rounded-lg hover:bg-red-700 transition duration-200">
                                    Delete Startup
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // ===== DELETE STARTUP FUNCTIONS =====
        let startupToDelete = null;

        function showDeleteStartupModal(startupId, startupName, userId) {
            if (currentUser?.role !== 'admin') {
                alert('Only administrators can delete startups.');
                return;
            }

            startupToDelete = { id: startupId, name: startupName, userId: userId };

            const modal = document.getElementById('delete-startup-modal');
            const nameElement = document.getElementById('delete-startup-name');

            if (nameElement) {
                nameElement.textContent = startupName;
            }

            if (modal) {
                modal.classList.remove('hidden');
            }
        }

        async function handleDeleteStartup() {
            if (!startupToDelete || currentUser?.role !== 'admin') {
                return;
            }

            try {
                console.log('ðŸ—‘ï¸ Deleting startup:', startupToDelete);

                // Step 1: Cancel all future bookings for this startup
                const today = new Date().toISOString().split('T')[0];
                const { data: futureBookings, error: fetchError } = await supabaseClient
                    .from('bookings')
                    .select('id')
                    .eq('startup_id', startupToDelete.id)
                    .gte('booking_date', today)
                    .neq('status', 'Cancelled');

                if (fetchError) {
                    console.error('Error fetching future bookings:', fetchError);
                } else if (futureBookings && futureBookings.length > 0) {
                    const bookingIds = futureBookings.map(b => b.id);
                    const { error: cancelError } = await supabaseClient
                        .from('bookings')
                        .update({
                            status: 'Cancelled',
                            equipment_notes: (equipment_notes) =>
                                equipment_notes ? `${equipment_notes}\n\n[AUTO-CANCELLED] Startup deleted by admin on ${new Date().toLocaleString()}`
                                : `[AUTO-CANCELLED] Startup deleted by admin on ${new Date().toLocaleString()}`
                        })
                        .in('id', bookingIds);

                    if (cancelError) {
                        console.error('Error cancelling bookings:', cancelError);
                    } else {
                        console.log(`âœ… Cancelled ${futureBookings.length} future booking(s)`);
                    }
                }

                // Step 2: Delete the startup record
                const { error: startupError } = await supabaseClient
                    .from('startups')
                    .delete()
                    .eq('id', startupToDelete.id);

                if (startupError) throw startupError;
                console.log('âœ… Startup record deleted');

                // Step 3: Delete the associated user account (if exists)
                if (startupToDelete.userId) {
                    const { error: userError } = await supabaseClient
                        .from('users')
                        .delete()
                        .eq('id', startupToDelete.userId);

                    if (userError) {
                        console.warn('Warning: Could not delete user account:', userError);
                        showMessage(`Startup "${startupToDelete.name}" deleted, but user account could not be removed.`, 'warning');
                    } else {
                        console.log('âœ… User account deleted');
                        showMessage(`Startup "${startupToDelete.name}" and associated user account have been deleted successfully!`, 'success');
                    }
                } else {
                    showMessage(`Startup "${startupToDelete.name}" has been deleted successfully!`, 'success');
                }

                // Close modal and refresh data
                closeDeleteStartupModal();
                await loadStartupsData();

            } catch (error) {
                console.error('Error deleting startup:', error);
                showMessage(`Failed to delete startup: ${error.message}`, 'error');
            }
        }

        function closeDeleteStartupModal() {
            const modal = document.getElementById('delete-startup-modal');
            if (modal) {
                modal.classList.add('hidden');
            }
            startupToDelete = null;
        }

        // Setup delete startup modal event listeners
        document.addEventListener('DOMContentLoaded', () => {
            const deleteModal = document.getElementById('delete-startup-modal');
            const closeBtn = document.getElementById('delete-startup-modal-close');
            const cancelBtn = document.getElementById('delete-startup-cancel');
            const confirmBtn = document.getElementById('delete-startup-confirm');

            if (closeBtn) {
                closeBtn.addEventListener('click', closeDeleteStartupModal);
            }

            if (cancelBtn) {
                cancelBtn.addEventListener('click', closeDeleteStartupModal);
            }

            if (confirmBtn) {
                confirmBtn.addEventListener('click', handleDeleteStartup);
            }

            // Close modal when clicking outside
            if (deleteModal) {
                deleteModal.addEventListener('click', (e) => {
                    if (e.target === deleteModal) {
                        closeDeleteStartupModal();
                    }
                });
            }
        });

        // ===== USER MANAGEMENT FUNCTIONS =====
        async function toggleUserRole(userId, currentRole) {
            const newRole = currentRole === 'admin' ? 'startup' : 'admin';

            try {
                const { error } = await supabaseClient
                    .from('users')
                    .update({ role: newRole })
                    .eq('id', userId);

                if (error) throw error;

                showMessage('User role updated successfully!', 'success');
                await loadStartupsData(); // Refresh the data

            } catch (error) {
                console.error('Error updating user role:', error);
                showMessage('Failed to update user role.', 'error');
            }
        }

        // ===== DELETE USER FUNCTIONS =====
        let userToDelete = null;

        function showDeleteUserModal(userId, userName, userEmail) {
            if (currentUser?.role !== 'admin') {
                alert('Only administrators can delete users.');
                return;
            }

            // Prevent admin from deleting themselves
            if (userId === currentUser.id) {
                showMessage('You cannot delete your own account.', 'error');
                return;
            }

            userToDelete = { id: userId, name: userName, email: userEmail };

            // Update modal content
            document.getElementById('delete-user-name').textContent = userName;
            document.getElementById('delete-user-email').textContent = userEmail;

            // Show modal
            const modal = document.getElementById('delete-user-modal');
            if (modal) {
                modal.classList.remove('hidden');
            }
        }

        async function handleDeleteUser() {
            if (!userToDelete || currentUser?.role !== 'admin') {
                return;
            }

            // Double-check not deleting self
            if (userToDelete.id === currentUser.id) {
                showMessage('You cannot delete your own account.', 'error');
                closeDeleteUserModal();
                return;
            }

            try {
                console.log('ðŸ—‘ï¸ Deleting user:', userToDelete);

                // Step 1: Cancel all future bookings for this user
                const today = new Date().toISOString().split('T')[0];
                const { data: futureBookings, error: fetchError } = await supabaseClient
                    .from('bookings')
                    .select('id')
                    .eq('user_id', userToDelete.id)
                    .gte('booking_date', today)
                    .neq('status', 'Cancelled');

                if (fetchError) {
                    console.error('Error fetching future bookings:', fetchError);
                } else if (futureBookings && futureBookings.length > 0) {
                    const bookingIds = futureBookings.map(b => b.id);
                    const { error: cancelError } = await supabaseClient
                        .from('bookings')
                        .update({
                            status: 'Cancelled',
                            equipment_notes: (equipment_notes) =>
                                equipment_notes ? `${equipment_notes}\n\n[AUTO-CANCELLED] User deleted by admin on ${new Date().toLocaleString()}`
                                : `[AUTO-CANCELLED] User deleted by admin on ${new Date().toLocaleString()}`
                        })
                        .in('id', bookingIds);

                    if (cancelError) {
                        console.error('Error cancelling bookings:', cancelError);
                    } else {
                        console.log(`âœ… Cancelled ${futureBookings.length} future booking(s)`);
                    }
                }

                // Step 2: Delete the user record
                const { error: userError } = await supabaseClient
                    .from('users')
                    .delete()
                    .eq('id', userToDelete.id);

                if (userError) throw userError;
                console.log('âœ… User record deleted');

                showMessage(`User "${userToDelete.name}" has been deleted successfully!`, 'success');

                // Close modal and refresh data
                closeDeleteUserModal();
                await loadStartupsData();

            } catch (error) {
                console.error('Error deleting user:', error);
                showMessage(`Failed to delete user: ${error.message}`, 'error');
            }
        }

        function closeDeleteUserModal() {
            const modal = document.getElementById('delete-user-modal');
            if (modal) {
                modal.classList.add('hidden');
            }
            userToDelete = null;
        }

        // Setup delete user modal event listeners
        document.addEventListener('DOMContentLoaded', () => {
            const deleteUserModal = document.getElementById('delete-user-modal');
            const closeBtn = document.getElementById('delete-user-modal-close');
            const cancelBtn = document.getElementById('delete-user-cancel');
            const confirmBtn = document.getElementById('delete-user-confirm');

            if (closeBtn) {
                closeBtn.addEventListener('click', closeDeleteUserModal);
            }

            if (cancelBtn) {
                cancelBtn.addEventListener('click', closeDeleteUserModal);
            }

            if (confirmBtn) {
                confirmBtn.addEventListener('click', handleDeleteUser);
            }

            // Close modal when clicking outside
            if (deleteUserModal) {
                deleteUserModal.addEventListener('click', (e) => {
                    if (e.target === deleteUserModal) {
                        closeDeleteUserModal();
                    }
                });
            }
        });

        async function createAdminAccount() {
            // Show helpful message first
            alert(
                'CREATE NEW ADMIN ACCOUNT\n\n' +
                'You are about to create a new admin account.\n\n' +
                'Requirements:\n' +
                'â€¢ Use a NEW email address (not already registered)\n' +
                'â€¢ Password must be at least 6 characters\n' +
                'â€¢ Provide a full name for the admin\n\n' +
                'If the email already exists, you will be offered to convert that user to admin instead.'
            );

            const email = prompt('Enter NEW admin email address:');
            if (!email) return;

            // Validate email format
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showMessage('Please enter a valid email address.', 'error');
                return;
            }

            const password = prompt('Enter admin password (min 6 characters):');
            if (!password) return;

            if (password.length < 6) {
                showMessage('Password must be at least 6 characters long.', 'error');
                return;
            }

            const name = prompt('Enter admin full name:');
            if (!name) return;

            if (name.trim().length < 2) {
                showMessage('Please enter a valid name (at least 2 characters).', 'error');
                return;
            }

            const phone = prompt('Enter admin phone number (optional, press Cancel to skip):');
            // Phone is optional, so we don't validate if empty

            try {
                // First, check if user with this email already exists
                const { data: existingUsers, error: checkError } = await supabaseClient
                    .from('users')
                    .select('id, email, role, name')
                    .eq('email', email);

                if (checkError) {
                    console.error('Error checking existing users:', checkError);
                }

                if (existingUsers && existingUsers.length > 0) {
                    const existingUser = existingUsers[0];

                    if (existingUser.role === 'admin') {
                        showMessage(
                            `An admin account with email "${email}" already exists.\n\n` +
                            `Name: ${existingUser.name}\n` +
                            `Email: ${existingUser.email}\n\n` +
                            `Please use a different email address to create a new admin account.`,
                            'error'
                        );
                        return;
                    } else {
                        // User exists but is not an admin - offer to convert
                        const shouldConvert = confirm(
                            `A user account with email "${email}" already exists.\n\n` +
                            `Current Name: ${existingUser.name}\n` +
                            `Current Role: ${existingUser.role}\n\n` +
                            `Would you like to convert this user to an admin?\n\n` +
                            `Note: This will change their role to "admin" but keep their existing name and profile.`
                        );

                        if (shouldConvert) {
                            // Update existing user to admin role (keep existing name)
                            const { error: updateError } = await supabaseClient
                                .from('users')
                                .update({ role: 'admin' })
                                .eq('id', existingUser.id);

                            if (updateError) throw updateError;

                            showMessage(
                                `User "${existingUser.name}" has been successfully converted to admin!\n\n` +
                                `Email: ${existingUser.email}\n` +
                                `New Role: admin`,
                                'success'
                            );
                            await loadStartupsData();
                            return;
                        } else {
                            showMessage(
                                'Admin account creation cancelled.\n\n' +
                                'Please use a different email address to create a new admin account.',
                                'info'
                            );
                            return;
                        }
                    }
                }

                // Create new auth user
                const { data, error } = await supabaseClient.auth.signUp({
                    email,
                    password,
                    options: {
                        data: {
                            name,
                            role: 'admin'
                        }
                    }
                });

                if (error) {
                    // Handle specific error cases
                    if (error.message.includes('already registered') || error.message.includes('already exists')) {
                        showMessage(
                            `Email "${email}" is already registered in the authentication system. ` +
                            `Please use a different email or contact the system administrator.`,
                            'error'
                        );
                    } else {
                        throw error;
                    }
                    return;
                }

                // CRITICAL FIX: Create user record in database
                // Without this, the user cannot login and won't appear in Contact Us tab
                if (data?.user) {
                    const { error: userError } = await supabaseClient
                        .from('users')
                        .insert({
                            id: data.user.id,
                            email: email,
                            name: name,
                            role: 'admin',
                            phone: phone || null // Use provided phone or null
                        });

                    if (userError) {
                        console.error('Error creating user profile:', userError);
                        showMessage(
                            `Admin authentication account created, but user profile creation failed.\n\n` +
                            `Error: ${userError.message}\n\n` +
                            `The admin may not be able to login. Please contact system administrator.`,
                            'error'
                        );
                        return;
                    }
                }

                showMessage(
                    `Admin account created successfully!\n\n` +
                    `Email: ${email}\n` +
                    `Name: ${name}\n\n` +
                    `The admin can now login and will appear in the Contact Us tab.`,
                    'success'
                );

                await loadStartupsData(); // Refresh the Startups tab
                await loadContactData(); // Refresh the Contact Us tab

            } catch (error) {
                console.error('Error creating admin account:', error);
                showMessage('Failed to create admin account: ' + error.message, 'error');
            }
        }

        // Edit User Profile Functions
        function editUserProfile(userId, name, email, phone) {
            // Populate the modal with user data
            document.getElementById('edit-user-id').value = userId;
            document.getElementById('edit-user-name').value = name;
            document.getElementById('edit-user-email').value = email;
            document.getElementById('edit-user-phone').value = phone || '';
            document.getElementById('edit-user-password').value = '';

            // Show the modal
            document.getElementById('edit-user-modal').classList.remove('hidden');
        }

        function closeEditUserModal() {
            document.getElementById('edit-user-modal').classList.add('hidden');
            document.getElementById('edit-user-form').reset();
        }

        // Edit user modal event listeners
        document.getElementById('edit-user-modal-close')?.addEventListener('click', closeEditUserModal);
        document.getElementById('edit-user-cancel')?.addEventListener('click', closeEditUserModal);

        document.getElementById('edit-user-form')?.addEventListener('submit', async (e) => {
            e.preventDefault();

            const userId = document.getElementById('edit-user-id').value;
            const name = document.getElementById('edit-user-name').value;
            const email = document.getElementById('edit-user-email').value;
            const phone = document.getElementById('edit-user-phone').value;
            const password = document.getElementById('edit-user-password').value;

            try {
                // Update user profile in users table
                const updateData = { name, email, phone };
                const { error: profileError } = await supabaseClient
                    .from('users')
                    .update(updateData)
                    .eq('id', userId);

                if (profileError) throw profileError;

                // If password is provided, update it in auth
                if (password && password.length >= 6) {
                    // Note: Updating another user's password requires admin privileges
                    // This is a simplified version - in production, you'd need proper admin API access
                    const { error: passwordError } = await supabaseClient.auth.admin.updateUserById(
                        userId,
                        { password: password }
                    );

                    if (passwordError) {
                        console.warn('Password update failed:', passwordError);
                        showMessage('Profile updated, but password update requires additional permissions.', 'warning');
                    } else {
                        showMessage('User profile and password updated successfully!', 'success');
                    }
                } else {
                    showMessage('User profile updated successfully!', 'success');
                }

                closeEditUserModal();
                await loadStartupsData(); // Refresh the data

            } catch (error) {
                console.error('Error updating user profile:', error);
                showMessage('Failed to update user profile: ' + error.message, 'error');
            }
        });

        // Close modal when clicking outside
        document.getElementById('edit-user-modal')?.addEventListener('click', (e) => {
            if (e.target.id === 'edit-user-modal') {
                closeEditUserModal();
            }
        });

        // ===== ENHANCED BOOKING FORM DATA LOADING =====
        async function loadBookingFormData() {
            try {
                console.log('Loading enhanced booking form data...');

                // Initialize database if needed
                await initializeDatabase();

                // Try to load rooms from Supabase, fallback to local data
                let rooms = [];
                try {
                    const resp = await supabaseClient
                        .from('rooms')
                        .select('*')
                        .order('name');

                    if (resp.error) {
                        console.warn('Supabase rooms error, using local data:', resp.error.message);
                        rooms = availableRooms;
                    } else {
                        rooms = resp.data || availableRooms;
                    }
                } catch (error) {
                    console.warn('Database connection issue, using local room data:', error);
                    rooms = availableRooms;
                }

                console.log('Using rooms:', rooms);

                // Set minimum date to tomorrow
                const bookingDate = document.getElementById('booking-date');
                if (bookingDate) {
                    const tomorrow = new Date();
                    tomorrow.setDate(tomorrow.getDate() + 1);
                    bookingDate.min = tomorrow.toISOString().split('T')[0];
                    bookingDate.value = tomorrow.toISOString().split('T')[0];

                    // Update room availability for tomorrow
                    updateRoomAvailability(tomorrow.toISOString().split('T')[0]);
                } else {
                    // Fallback: populate rooms immediately
                    populateRoomSelect(rooms);
                }

                // Set up event listeners for dynamic updates
                setupBookingFormListeners();

            } catch (error) {
                console.error('Error loading booking form data:', error);
                // Fallback to local room data
                populateRoomSelect(availableRooms);
            }
        }

        // Enhanced room availability system
        const updateRoomAvailability = async (selectedDate) => {
            console.log('Updating room availability for:', selectedDate);

            try {
                // Get bookings for the selected date
                const { data: bookingsForDay, error } = await supabaseClient
                    .from('bookings')
                    .select('room_name, duration')
                    .eq('booking_date', selectedDate);

                if (error) {
                    console.warn('Error loading bookings, showing all rooms:', error);
                }

                const roomSelect = document.getElementById('room-select');
                if (!roomSelect) return;

                roomSelect.innerHTML = '<option value="">Select a room</option>';

                availableRooms.forEach(room => {
                    const bookingsForRoom = (bookingsForDay || []).filter(b => b.room_name === room.name);
                    const totalBookedHours = bookingsForRoom.reduce((acc, curr) => acc + (curr.duration || 0), 0);

                    const isFullyBooked = totalBookedHours >= 8;
                    const option = document.createElement('option');
                    option.value = room.name;
                    option.textContent = isFullyBooked ? `${room.name} (Fully Booked)` : room.name;
                    option.disabled = isFullyBooked;
                    option.dataset.roomType = room.type;
                    option.dataset.maxDuration = room.maxDuration;
                    option.dataset.requiresEquipment = room.requiresEquipment;
                    roomSelect.appendChild(option);
                });

                updateDurationAndEquipment();
            } catch (error) {
                console.error('Error updating room availability:', error);
                populateRoomSelect(availableRooms);
            }
        };

        // Fallback room population
        const populateRoomSelect = (rooms) => {
            const roomSelect = document.getElementById('room-select');
            if (!roomSelect) return;

            roomSelect.innerHTML = '<option value="">Select a room</option>' +
                rooms.map(room => `<option value="${room.name}" data-room-type="${room.type}" data-max-duration="${room.maxDuration}" data-requires-equipment="${room.requiresEquipment}">${room.name}</option>`).join('');
            roomSelect.disabled = rooms.length === 0;

            updateDurationAndEquipment();
        };

        // Enhanced duration and equipment management with room preview and extended hours
        const updateDurationAndEquipment = async () => {
            const roomSelect = document.getElementById('room-select');
            const durationSelect = document.getElementById('duration-select');
            const timeSelect = document.getElementById('time-select');
            const podcastEquipmentSection = document.getElementById('podcast-equipment-section');
            const roomPreviewSection = document.getElementById('room-preview-section');
            const durationHelpText = document.getElementById('duration-help-text');
            const timeHelpText = document.getElementById('time-help-text');

            if (!roomSelect || !durationSelect || !timeSelect) return;

            const selectedRoomName = roomSelect.value;

            if (!selectedRoomName) {
                // Hide room preview if no room selected
                if (roomPreviewSection) {
                    roomPreviewSection.classList.add('hidden');
                }
                if (podcastEquipmentSection) {
                    podcastEquipmentSection.classList.add('hidden');
                }
                return;
            }

            // Find room data
            const room = availableRooms.find(r => r.name === selectedRoomName);
            if (!room) return;

            // Update room preview
            updateRoomPreview(room);

            // Check if room has extended hours (FIXED: using correct room names from database)
            const extendedHoursRooms = ['Indus Board', 'Podcast Room', 'Nexus Session Hall'];
            const hasExtendedHours = extendedHoursRooms.includes(selectedRoomName);
            const maxDuration = hasExtendedHours ? 8 : 2;

            // Update duration options
            durationSelect.innerHTML = '';
            for (let i = 1; i <= maxDuration; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i === 1 ? '1 Hour' : `${i} Hours`;
                durationSelect.appendChild(option);
            }

            // Update duration help text
            if (durationHelpText) {
                if (hasExtendedHours) {
                    durationHelpText.textContent = `Maximum booking duration: ${maxDuration} hours (Extended hours room)`;
                    durationHelpText.className = 'text-xs text-blue-600 mt-1 font-medium';
                } else {
                    durationHelpText.textContent = `Maximum booking duration: ${maxDuration} hours`;
                    durationHelpText.className = 'text-xs text-gray-500 mt-1';
                }
            }

            // Update time options
            timeSelect.innerHTML = '';

            if (hasExtendedHours) {
                // 24/7 availability for extended hours rooms
                for (let hour = 0; hour < 24; hour++) {
                    const option = document.createElement('option');
                    const timeValue = hour.toString().padStart(2, '0') + ':00';
                    const displayTime = hour === 0 ? '12:00 AM' :
                                      hour < 12 ? `${hour}:00 AM` :
                                      hour === 12 ? '12:00 PM' :
                                      `${hour - 12}:00 PM`;
                    option.value = timeValue;
                    option.textContent = displayTime;
                    timeSelect.appendChild(option);
                }

                // Update time help text
                if (timeHelpText) {
                    timeHelpText.textContent = '24/7 availability (Extended hours room)';
                    timeHelpText.className = 'text-xs text-blue-600 mt-1 font-medium';
                }
            } else {
                // Standard 9 AM - 6 PM hours
                const standardHours = [
                    { value: '09:00', text: '09:00 AM' },
                    { value: '10:00', text: '10:00 AM' },
                    { value: '11:00', text: '11:00 AM' },
                    { value: '12:00', text: '12:00 PM' },
                    { value: '13:00', text: '01:00 PM' },
                    { value: '14:00', text: '02:00 PM' },
                    { value: '15:00', text: '03:00 PM' },
                    { value: '16:00', text: '04:00 PM' },
                    { value: '17:00', text: '05:00 PM' }
                ];

                standardHours.forEach(time => {
                    const option = document.createElement('option');
                    option.value = time.value;
                    option.textContent = time.text;
                    timeSelect.appendChild(option);
                });

                // Update time help text
                if (timeHelpText) {
                    timeHelpText.textContent = 'Available 9:00 AM - 6:00 PM';
                    timeHelpText.className = 'text-xs text-gray-500 mt-1';
                }
            }

            // Show/hide equipment section
            if (podcastEquipmentSection) {
                const podcastEquipmentTextarea = document.getElementById('podcast-equipment');
                if (room.requiresEquipment) {
                    podcastEquipmentSection.classList.remove('hidden');
                    if (podcastEquipmentTextarea) {
                        podcastEquipmentTextarea.required = true;
                    }
                } else {
                    podcastEquipmentSection.classList.add('hidden');
                    if (podcastEquipmentTextarea) {
                        podcastEquipmentTextarea.required = false;
                        podcastEquipmentTextarea.value = '';
                    }
                }
            }
        };

        // Update room preview display
        const updateRoomPreview = (room) => {
            const roomPreviewSection = document.getElementById('room-preview-section');
            const roomPreviewName = document.getElementById('room-preview-name');
            const roomPreviewCapacity = document.getElementById('room-preview-capacity');
            const roomPreviewType = document.getElementById('room-preview-type');
            const roomPreviewDuration = document.getElementById('room-preview-duration');
            const roomPreviewEquipment = document.getElementById('room-preview-equipment');

            if (!roomPreviewSection) return;

            // Show preview section
            roomPreviewSection.classList.remove('hidden');

            // Update room details
            if (roomPreviewName) roomPreviewName.textContent = room.name;
            if (roomPreviewCapacity) roomPreviewCapacity.textContent = `${room.capacity} people`;
            if (roomPreviewType) {
                const typeText = room.type === 'focus' ? 'Focus Room' : 'Special Room';
                roomPreviewType.textContent = typeText;
                roomPreviewType.className = `text-gray-600 ml-1 px-2 py-1 rounded text-xs ${room.type === 'focus' ? 'bg-blue-100 text-blue-800' : 'bg-purple-100 text-purple-800'}`;
            }
            // FIX 1: Show actual max duration (8 hours for Indus-Board Room, Nexus-Session Hall, Podcast Room)
            if (roomPreviewDuration) roomPreviewDuration.textContent = `${room.maxDuration} hours max`;

            // Update equipment list
            if (roomPreviewEquipment) {
                roomPreviewEquipment.innerHTML = room.equipment.map(eq =>
                    `<span class="inline-block bg-gray-100 text-gray-700 px-2 py-1 rounded text-xs">${eq}</span>`
                ).join('');
            }
        };

        // Setup booking form event listeners
        const setupBookingFormListeners = () => {
            const bookingDateInput = document.getElementById('booking-date');
            const roomSelect = document.getElementById('room-select');

            if (bookingDateInput) {
                bookingDateInput.addEventListener('change', (e) => {
                    updateRoomAvailability(e.target.value);
                });
            }

            if (roomSelect) {
                roomSelect.addEventListener('change', updateDurationAndEquipment);
            }
        };

        // ===== MY BOOKINGS DATA LOADING =====
        async function loadMyBookingsData() {
            // Show admin panel if user is admin
            const adminPanel = document.getElementById('admin-bookings-panel');
            if (adminPanel) {
                if (currentUser?.role === 'admin') {
                    adminPanel.classList.remove('hidden');
                    // Load admin bookings in parallel
                    loadAdminBookingsData?.();
                } else {
                    adminPanel.classList.add('hidden');
                }
            }
            if (!currentUser || !currentStartup) return;

            try {
                const { data: bookings, error } = await supabaseClient
                    .from('bookings')
                    .select('*')
                    .eq('startup_id', currentStartup.id)
                    .order('booking_date', { ascending: false });

                if (error) throw error;

                displayMyBookings(bookings || []);
            } catch (error) {
                console.error('Error loading my bookings data:', error);
            }
        }

        function displayMyBookings(bookings) {
            const today = new Date().toISOString().split('T')[0];

            const pastBookings = bookings.filter(b => b.booking_date < today);
            const presentBookings = bookings.filter(b => b.booking_date === today);
            const futureBookings = bookings.filter(b => b.booking_date > today);

            // Update each section
            updateBookingsSection('future-bookings-list', futureBookings, 'No upcoming bookings found.');
            updateBookingsSection('present-bookings-list', presentBookings, 'No bookings for today.');
            updateBookingsSection('past-bookings-list', pastBookings, 'No past bookings found.');
        }

        function updateBookingsSection(elementId, bookings, emptyMessage) {
            // If admin panel is visible, also refresh admin list
            if (elementId === 'future-bookings-list' && currentUser?.role === 'admin') {
                // Load admin bookings list in background
                loadAdminBookingsData?.();
            }
            const container = document.getElementById(elementId);
            if (!container) return;

            if (bookings.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-500 py-4">${emptyMessage}</p>`;
                return;
            }

            container.innerHTML = bookings.map(booking => `
                <div class="bg-white p-4 rounded-lg shadow border-l-4 border-green-500">
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-semibold text-gray-800">${booking.room_name}</h4>
                            <p class="text-sm text-gray-600">${new Date(booking.booking_date).toLocaleDateString()}</p>
                            <p class="text-sm text-gray-600">${booking.start_time} (${booking.duration}h)</p>
                            ${booking.equipment_notes ? `<p class="text-xs text-gray-500 mt-1">Equipment: ${booking.equipment_notes}</p>` : ''}
                        </div>
                        <div class="text-right">
                            <span class="inline-block px-2 py-1 rounded text-xs font-medium ${
                                booking.status === 'confirmed' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'
                            }">
                                ${booking.status}
                            </span>
                            ${booking.is_confidential ? '<p class="text-xs text-gray-500 mt-1">Confidential</p>' : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // ===== AUTHENTICATION INTEGRATION =====
        async function bootstrapData(user) {
            try {
                console.log('ðŸ”„ Bootstrap Data - Starting for user:', user.id);
                console.log('ðŸ”„ User metadata:', user.user_metadata);

                // Step 1: Load user profile with retry logic
                console.log('ðŸ“ Step 1: Loading user profile...');
                console.log('ðŸ” [DEBUG] User ID to query:', user.id);
                let userProfile = null;
                let retryCount = 0;
                const maxRetries = 3;

                while (!userProfile && retryCount < maxRetries) {
                    console.log(`ðŸ” [DEBUG] Attempt ${retryCount + 1}/${maxRetries} - Querying users table...`);

                    try {
                        // Directly query the users table using the authenticated user ID
                        const { data, error } = await supabaseClient
                            .from('users')
                            .select('*')
                            .eq('id', user.id)
                            .maybeSingle();

                        console.log('ðŸ” [DEBUG] Query completed. Data:', data);
                        console.log('ðŸ” [DEBUG] Query error:', error);

                        if (error && error.code !== 'PGRST116') {
                            console.error(`âŒ Error loading user profile (attempt ${retryCount + 1}):`, error);
                            retryCount++;
                            if (retryCount < maxRetries) {
                                console.log('â³ Retrying in 1 second...');
                                await new Promise(resolve => setTimeout(resolve, 1000));
                            }
                        } else {
                            console.log('ðŸ” [DEBUG] Setting userProfile to:', data);
                            userProfile = data;
                            break;
                        }
                    } catch (queryError) {
                        console.error('âŒ [DEBUG] Exception during query:', queryError);
                        retryCount++;
                        if (retryCount < maxRetries) {
                            console.log('â³ Retrying in 1 second...');
                            await new Promise(resolve => setTimeout(resolve, 1000));
                        }
                    }
                }

                console.log('ðŸ” [DEBUG] After retry loop. userProfile:', userProfile);

                // Check if user profile was loaded successfully
                if (!userProfile) {
                    console.error('âŒâŒâŒ CRITICAL: Failed to load user profile from database after retries');
                    console.error('âŒâŒâŒ User ID:', user.id);
                    console.error('âŒâŒâŒ User email:', user.email);

                    // DO NOT create fallback profile - this causes admin users to get role='startup'
                    // Instead, throw an error to force user to try again
                    throw new Error('Failed to load user profile from database. This may be due to Row Level Security policies blocking access. Please contact support or try logging out and back in.');
                }

                console.log('âœ… User profile loaded:', userProfile);
                console.log('ðŸ” [DEBUG] User role from database:', userProfile.role);
                console.log('ðŸ” [DEBUG] User email:', userProfile.email);

                currentUser = userProfile;
                console.log('ðŸ” [DEBUG] currentUser set to:', currentUser);
                console.log('ðŸ” [DEBUG] currentUser.role:', currentUser?.role);

                // Step 2: Load startup profile with retry logic
                console.log('ðŸ“ Step 2: Loading startup profile...');
                let startup = null;
                retryCount = 0;

                while (!startup && retryCount < maxRetries) {
                    const { data, error } = await supabaseClient
                        .from('startups')
                        .select('*')
                        .eq('user_id', user.id)
                        .maybeSingle();

                    if (error && error.code !== 'PGRST116') {
                        console.error(`âŒ Error loading startup profile (attempt ${retryCount + 1}):`, error);
                        retryCount++;
                        if (retryCount < maxRetries) {
                            console.log('â³ Retrying in 1 second...');
                            await new Promise(resolve => setTimeout(resolve, 1000));
                        }
                    } else {
                        startup = data;
                        break;
                    }
                }

                if (startup) {
                    console.log('âœ… Startup profile found:', startup);
                    currentStartup = startup;
                } else {
                    console.log('âš ï¸ No startup profile found');
                    currentStartup = null;

                    // Try to create startup profile if metadata is available (startup users)
                    if (user.user_metadata?.startup_name && currentUser.role === 'startup') {
                        console.log('ðŸ”§ Attempting to create startup profile from metadata...');
                        try {
                            const { data: newStartup, error: startupCreateError } = await supabaseClient
                                .from('startups')
                                .insert({
                                    user_id: user.id,
                                    name: user.user_metadata.startup_name,
                                    contact_person: user.user_metadata.name || user.email.split('@')[0],
                                    phone: user.user_metadata.phone || '',
                                    email: user.email,
                                    status: 'active'
                                })
                                .select()
                                .single();

                            if (startupCreateError) {
                                console.error('âŒ Could not create startup profile:', startupCreateError);
                            } else {
                                console.log('âœ… Startup profile created from metadata:', newStartup);
                                currentStartup = newStartup;
                            }
                        } catch (createError) {
                            console.error('âŒ Exception creating startup profile:', createError);
                        }
                    } else if (currentUser.role === 'admin') {
                        // Auto-provision a "NIC ADMIN" startup for admin users to enable bookings
                        console.log('ðŸ› ï¸ Auto-provisioning NIC ADMIN startup for admin user...');
                        try {
                            const { data: adminStartup, error: adminStartupError } = await supabaseClient
                                .from('startups')
                                .insert({
                                    user_id: user.id,
                                    name: 'NIC ADMIN',
                                    contact_person: currentUser.name || currentUser.email.split('@')[0],
                                    phone: currentUser.phone || '',
                                    email: currentUser.email,
                                    status: 'active'
                                })
                                .select()
                                .single();

                            if (adminStartupError) {
                                console.error('âŒ Failed to create NIC ADMIN startup:', adminStartupError);
                                // If duplicate or conflict, try to fetch again just in case it exists now
                                const { data: fallbackStartup } = await supabaseClient
                                    .from('startups')
                                    .select('*')
                                    .eq('user_id', user.id)
                                    .maybeSingle();
                                if (fallbackStartup) {
                                    console.log('âœ… Found existing startup after conflict:', fallbackStartup);
                                    currentStartup = fallbackStartup;
                                }
                            } else if (adminStartup) {
                                console.log('âœ… NIC ADMIN startup created:', adminStartup);
                                currentStartup = adminStartup;
                            }
                        } catch (adminCreateErr) {
                            console.error('âŒ Exception creating NIC ADMIN startup:', adminCreateErr);
                        }
                    }
                }

                console.log('ðŸŽ¯ Bootstrap Summary:');
                console.log('   - Current User:', currentUser);
                console.log('   - Current Startup:', currentStartup);
                console.log('   - Can Book Rooms:', !!currentStartup);

                // Update UI based on user role
                updateUIForUserRole(currentUser.role);

                // Set up real-time database synchronization
                console.log('ðŸ”„ Setting up real-time subscriptions...');
                setupRealtimeSubscriptions();

                // Start periodic dashboard refresh
                console.log('â° Starting dashboard auto-refresh...');
                startDashboardAutoRefresh();

                // Start real-time health checks
                console.log('ðŸ¥ Starting real-time health checks...');
                startRealtimeHealthChecks();

                // Load initial page data
                const currentHash = window.location.hash || '#dashboard';
                showPage(currentHash);

            } catch (error) {
                console.error('âŒâŒâŒ Bootstrap data error:', error);
                console.error('âŒâŒâŒ Error stack:', error.stack);
                console.error('âŒâŒâŒ Error message:', error.message);

                // Show error to user
                alert('Failed to load user data. Please refresh the page and try again.\n\nError: ' + error.message);
            }
        }

        function updateUIForUserRole(role) {
            console.log('ðŸŽ¨ [updateUIForUserRole] Updating UI for role:', role);
            console.log('ðŸŽ¨ [updateUIForUserRole] currentUser:', currentUser);

            // Show/hide admin-only elements
            const adminElements = document.querySelectorAll('[data-admin-only]');
            console.log('ðŸŽ¨ [updateUIForUserRole] Found', adminElements.length, 'admin-only elements');

            adminElements.forEach(el => {
                if (role === 'admin') {
                    el.classList.remove('hidden');
                } else {
                    el.classList.add('hidden');
                }
            });

            // Update user profile display
            const userNameEl = document.getElementById('user-name');
            const headerUserNameEl = document.getElementById('header-user-name');
            const userRoleEl = document.getElementById('user-role');

            console.log('ðŸŽ¨ [updateUIForUserRole] User display elements:', {
                userNameEl: !!userNameEl,
                headerUserNameEl: !!headerUserNameEl,
                userRoleEl: !!userRoleEl
            });

            if (currentUser) {
                const displayName = currentUser.name || currentUser.email?.split('@')[0] || 'User';
                const displayRole = currentUser.role || 'user';

                console.log('ðŸŽ¨ [updateUIForUserRole] Setting display name:', displayName);
                console.log('ðŸŽ¨ [updateUIForUserRole] Setting display role:', displayRole);

                if (userNameEl) {
                    userNameEl.textContent = displayName;
                    console.log('âœ… [updateUIForUserRole] Updated sidebar user name');
                }
                if (headerUserNameEl) {
                    headerUserNameEl.textContent = displayName;
                    console.log('âœ… [updateUIForUserRole] Updated header user name');
                }
                if (userRoleEl) {
                    userRoleEl.textContent = displayRole;
                    console.log('âœ… [updateUIForUserRole] Updated user role display');
                }
            } else {
                console.warn('âš ï¸ [updateUIForUserRole] currentUser is null, cannot update UI');
            }

            console.log('âœ… [updateUIForUserRole] UI update complete');
        }

        // ===== AUTHENTICATION HANDLERS =====
        // Toggle links
        showSignupLink?.addEventListener('click', (e) => {
            e.preventDefault();
            showAuth('signup');
        });

        showLoginLink?.addEventListener('click', (e) => {
            e.preventDefault();
            showAuth('login');
        });

        // Auth state handling
        async function handleAuthState() {
            if (!supabaseClient) return showAuth('login');

            // Check if we should force fresh login (uncomment next line to force re-authentication every time)
            // await supabaseClient.auth.signOut();

            const { data: { session }, error } = await supabaseClient.auth.getSession();
            if (error) console.warn('getSession error', error);

            if (session?.user) {
                // Verify the session is still valid by checking user profile
                try {
                    const { data: userProfile, error: profileError } = await supabaseClient
                        .from('users')
                        .select('id, email, role')
                        .eq('id', session.user.id)
                        .maybeSingle();

                    if (profileError && profileError.code !== 'PGRST116') {
                        console.error('Error verifying user profile:', profileError);
                        await supabaseClient.auth.signOut();
                        return showAuth('login');
                    }

                    showApp();
                    await bootstrapData(session.user);
                } catch (err) {
                    console.error('Session validation error:', err);
                    await supabaseClient.auth.signOut();
                    showAuth('login');
                }
            } else {
                showAuth('login');
            }
        }

        // Listen for auth state changes
        supabaseClient?.auth.onAuthStateChange(async (event, session) => {
            console.log('ðŸ” [Auth] State change event:', event);

            if (event === 'TOKEN_REFRESHED') {
                console.log('âœ… [Auth] Session token refreshed successfully');
                // Session was automatically refreshed, no action needed
                // The new token is already being used by the client
            } else if (event === 'SIGNED_IN') {
                console.log('âœ… [Auth] User signed in');
                if (session?.user) {
                    showApp();
                    await bootstrapData(session.user);
                }
            } else if (event === 'SIGNED_OUT') {
                console.log('ðŸ” [Auth] User signed out');
                // Clean up real-time subscriptions when user logs out
                cleanupRealtimeSubscriptions();
                showAuth('login');
            } else if (event === 'USER_UPDATED') {
                console.log('ðŸ” [Auth] User updated');
                // User data was updated, refresh if needed
            }

            // Fallback: if we have a session but no specific event handling
            if (session?.user && !currentUser) {
                console.log('ðŸ” [Auth] Session exists but no currentUser, bootstrapping...');
                showApp();
                await bootstrapData(session.user);
            } else if (!session) {
                // No session, show login
                cleanupRealtimeSubscriptions();
                showAuth('login');
            }
        });

        // Sign up
        signupFormEl?.addEventListener('submit', async (e) => {
            e.preventDefault();
            signupErrorEl?.classList.add('hidden');
            signupSuccessEl?.classList.add('hidden');

            const startupName = document.getElementById('signup-startup-name')?.value?.trim();
            const contactPerson = document.getElementById('signup-contact-person')?.value?.trim();
            const phone = document.getElementById('signup-phone')?.value?.trim();
            const email = document.getElementById('signup-email')?.value?.trim();
            const password = document.getElementById('signup-password')?.value;

            if (!startupName || !contactPerson || !phone || !email || !password || password.length < 6) {
                showSignupError('Please fill all required fields. Password must be at least 6 characters.');
                return;
            }

            setSignupLoading(true);
            try {
                console.log('ðŸš€ Starting signup process...');

                // Step 1: Create user account
                console.log('ðŸ“ Step 1: Creating auth user...');
                const { data: authData, error: authError } = await supabaseClient.auth.signUp({
                    email,
                    password,
                    options: {
                        data: {
                            name: contactPerson,
                            phone,
                            role: 'startup',
                            startup_name: startupName
                        }
                    }
                });

                if (authError) {
                    console.error('âŒ Auth user creation failed:', authError);
                    throw authError;
                }
                console.log('âœ… Auth user created successfully:', authData.user?.id);

                // If email confirmation is ON, there is no session yet. In that case,
                // let the DB trigger create profiles from auth metadata and skip client inserts.
                if (authData.session && authData.user) {
                    console.log('ðŸ“ Step 2: Creating user profile (session present)...');
                    const { error: userError } = await supabaseClient
                        .from('users')
                        .insert({
                            id: authData.user.id,
                            email: email,
                            name: contactPerson,
                            phone: phone,
                            role: 'startup'
                        });

                    if (userError) {
                        console.error('âŒ User profile creation failed:', userError);
                        // Don't fail signup; DB trigger will still create it shortly.
                    } else {
                        console.log('âœ… User profile created successfully');
                    }

                    // Step 3: Create startup profile (with schema cache fallback)
                    console.log('ðŸ“ Step 3: Creating startup profile...');
                    let startupError = null;

                    try {
                        // Try with status column first
                        const { error } = await supabaseClient
                            .from('startups')
                            .insert({
                                user_id: authData.user.id,
                                name: startupName,
                                contact_person: contactPerson,
                                phone: phone,
                                email: email,
                                status: 'active'
                            });
                        startupError = error;
                    } catch (schemaError) {
                        console.log('Schema cache issue during signup, trying without status column...');
                        const { error } = await supabaseClient
                            .from('startups')
                            .insert({
                                user_id: authData.user.id,
                                name: startupName,
                                contact_person: contactPerson,
                                phone: phone,
                                email: email
                            });
                        startupError = error;
                    }

                    if (startupError) {
                        console.error('Startup profile creation failed:', startupError);
                    } else {
                        console.log('âœ… Startup profile created successfully');
                    }

                    showSignupSuccess('Account created successfully! Please check your email to verify your account, then sign in.');
                } else {
                    console.log('No session present yet (email confirmation likely ON). Skipping client-side inserts.');
                    showSignupSuccess('Account created! Please check your email to verify your account. Your profiles will be created automatically.');
                }

                console.log('ðŸŽ‰ Signup process completed successfully');
                showAuth('login');

            } catch (err) {
                console.error('Signup error', err);
                showSignupError(err.message || 'Unable to create account.');
            } finally {
                setSignupLoading(false);
            }
        });

        // Login
        loginFormEl?.addEventListener('submit', async (e) => {
            e.preventDefault();

            // Clear previous error messages
            loginErrorEl.textContent = '';
            loginErrorEl.classList.add('hidden');

            const email = document.getElementById('login-email')?.value?.trim();
            const password = document.getElementById('login-password')?.value;

            if (!email || !password) {
                loginErrorEl.textContent = 'Enter email and password.';
                loginErrorEl.classList.remove('hidden');
                return;
            }

            try {
                const { error } = await supabaseClient.auth.signInWithPassword({ email, password });

                if (error) {
                    // Show user-friendly error message for invalid credentials
                    if (error.message.includes('Invalid login credentials') ||
                        error.message.includes('Email not confirmed') ||
                        error.message.includes('Invalid email or password')) {
                        loginErrorEl.textContent = 'Invalid email or password. Please try again.';
                    } else {
                        loginErrorEl.textContent = error.message || 'Login failed. Please try again.';
                    }
                    loginErrorEl.classList.remove('hidden');
                    throw error;
                }

                // Show success message
                loginErrorEl.classList.remove('hidden');
                loginErrorEl.classList.remove('text-red-600', 'bg-red-50');
                loginErrorEl.classList.add('text-green-600', 'bg-green-50');
                loginErrorEl.textContent = 'Login successful! Redirecting to dashboard...';

                // The auth state change listener will handle the redirect

            } catch (err) {
                console.error('Login error', err);
                // Error message already set above
            }
        });

        // Logout
        const logoutBtn = document.getElementById('logout-btn');
        logoutBtn?.addEventListener('click', async () => {
            console.log('User logging out...');

            // Clean up real-time subscriptions
            cleanupRealtimeSubscriptions();

            await supabaseClient.auth.signOut();
            currentUser = null;
            currentStartup = null;
            showAuth('login');
        });

        // Session timeout (optional - uncomment to enable 30-minute auto-logout)
        /*
        let sessionTimeout;
        function resetSessionTimeout() {
            clearTimeout(sessionTimeout);
            sessionTimeout = setTimeout(async () => {
                console.log('Session timeout - logging out user');
                await supabaseClient.auth.signOut();
                showAuth('login');
                alert('Your session has expired. Please log in again.');
            }, 30 * 60 * 1000); // 30 minutes
        }

        // Reset timeout on user activity
        ['click', 'keypress', 'scroll', 'mousemove'].forEach(event => {
            document.addEventListener(event, resetSessionTimeout, true);
        });
        */

        // Booking form
        const bookingFormEl = document.getElementById('booking-form');
        bookingFormEl?.addEventListener('submit', async (e) => {
            e.preventDefault();
            e.stopImmediatePropagation();

            // Enhanced lazy-loading with better error handling
            if (!currentStartup && currentUser) {
                console.log('ðŸ”„ Lazy-loading startup profile for booking...');
                try {
                    const { data: startup, error } = await supabaseClient
                        .from('startups')
                        .select('*')
                        .eq('user_id', currentUser.id)
                        .maybeSingle();

                    if (error && error.code !== 'PGRST116') {
                        console.error('âŒ Error lazy-loading startup:', error);
                    } else if (startup) {
                        console.log('âœ… Startup profile lazy-loaded:', startup);
                        currentStartup = startup;
                        updateProfileDebugInfo?.();
                    } else {
                        console.log('âš ï¸ No startup profile found during lazy-load');
                    }
                } catch (err) {
                    console.error('âŒ Exception during startup lazy-load:', err);
                }
            }

            if (!currentStartup) {
                if (currentUser?.role === 'admin') {
                    try {
                        console.log('\u26a0\ufe0f Admin without startup profile detected. Ensuring NIC ADMIN startup...');
                        // Try to find an existing startup for this admin
                        const { data: existingAdminStartup } = await supabaseClient
                            .from('startups')
                            .select('*')
                            .eq('user_id', currentUser.id)
                            .maybeSingle();
                        if (existingAdminStartup) {
                            currentStartup = existingAdminStartup;
                            updateProfileDebugInfo?.();
                        } else {
                            // Create a NIC ADMIN startup associated with this admin user
                            const { data: createdAdminStartup, error: createAdminErr } = await supabaseClient
                                .from('startups')
                                .insert({
                                    user_id: currentUser.id,
                                    name: 'NIC ADMIN',
                                    contact_person: currentUser.name || currentUser.email.split('@')[0],
                                    phone: currentUser.phone || '',
                                    email: currentUser.email,
                                    status: 'active'
                                })
                                .select()
                                .single();
                            if (createAdminErr) {
                                console.error('Failed to create NIC ADMIN startup:', createAdminErr);
                                showBookingBanner('Could not provision NIC ADMIN profile for booking. Please try again or contact support.', 'red');
                                return;
                            }
                            currentStartup = createdAdminStartup;
                            updateProfileDebugInfo?.();
                        }
                    } catch (ensureErr) {
                        console.error('Error ensuring NIC ADMIN startup:', ensureErr);
                        showBookingBanner('Error preparing admin booking profile. Please try again.', 'red');
                        return;
                    }
                } else {
                    showBookingBanner('No startup profile found. Go to Settings â†’ Create Missing Startup Profile to fix this issue.', 'red');
                    return;
                }
            }

            const roomName = document.getElementById('room-select')?.value;
            const bookingDate = document.getElementById('booking-date')?.value;
            const startTime = document.getElementById('time-select')?.value;
            const duration = parseInt(document.getElementById('duration-select')?.value || '1', 10);
            const equipmentNotes = document.getElementById('podcast-equipment')?.value || '';
            const generalNotes = document.getElementById('general-notes')?.value || '';
            const isConfidential = !!document.getElementById('is-confidential')?.checked;

            if (!roomName || !bookingDate || !startTime) {
                showBookingBanner('Please fill all required booking fields.', 'red');
                return;
            }

            // Enhanced room validation
            const selectedRoom = availableRooms.find(r => r.name === roomName);
            if (!selectedRoom) {
                showBookingBanner('Invalid room selected. Please choose a valid room.', 'red');
                return;
            }

            // Validate equipment requirements
            if (selectedRoom.requiresEquipment && !equipmentNotes.trim()) {
                showBookingBanner('Equipment requirements must be specified for this room.', 'red');
                return;
            }

            // Validate duration limit based on room (standard: 2h, extended rooms: up to 8h)
            // FIXED: using correct room names from database
            const extendedRooms = ['Indus Board', 'Podcast Room', 'Nexus Session Hall'];
            const maxAllowed = extendedRooms.includes(roomName) ? 8 : 2;
            if (duration > maxAllowed) {
                showBookingBanner(`Maximum booking duration is ${maxAllowed} hours for ${roomName}.`, 'red');
                return;
            }

            // Check booking limits (enhanced validation)
            const limitCheck = checkBookingLimits(currentStartup.id, roomName);
            if (!limitCheck.allowed) {
                showBookingBanner(limitCheck.message, 'red');
                return;
            }

            try {
                // Combine notes for storage
                const allNotes = [equipmentNotes, generalNotes].filter(note => note.trim()).join('\n\n');

                const { error } = await supabaseClient.from('bookings').insert({
                    startup_id: currentStartup.id,
                    room_name: roomName,
                    booking_date: bookingDate,
                    start_time: startTime,
                    duration,
                    equipment_notes: allNotes,
                    is_confidential: isConfidential,
                    status: 'confirmed',
                    room_type: selectedRoom.type
                });

                if (error) throw error;

                showBookingBanner(`Booking successful! ${roomName} is confirmed for ${duration} hour${duration > 1 ? 's' : ''}.`, 'green');
                triggerConfetti();

                // Reset form and hide preview
                bookingFormEl.reset();
                const roomPreviewSection = document.getElementById('room-preview-section');
                const podcastEquipmentSection = document.getElementById('podcast-equipment-section');
                if (roomPreviewSection) roomPreviewSection.classList.add('hidden');
                if (podcastEquipmentSection) podcastEquipmentSection.classList.add('hidden');

                // Refresh bookings data and room availability
                await loadMyBookingsData();
                if (bookingDate) {
                    updateRoomAvailability(bookingDate);
                }

            } catch (err) {
                console.error('Booking create error', err);
                showBookingBanner(err.message || 'Failed to create booking.', 'red');
            }
        });

        // ===== ADMIN BOOKINGS (ADMIN-ONLY) =====
        async function loadAdminBookingsData() {
            try {
                if (currentUser?.role !== 'admin') return;
                const list = document.getElementById('admin-bookings-list');
                if (!list) return;
                list.innerHTML = '<div class="text-center text-gray-500 py-8">Loading all bookings...</div>';

                // Try to join startups for display name
                let { data: bookings, error } = await supabaseClient
                    .from('bookings')
                    .select('id, room_name, booking_date, start_time, duration, status, is_confidential, startup_id')
                    .order('booking_date', { ascending: false })
                    .limit(200);
                if (error) throw error;

                // Load startup names in batch if needed
                const startupIds = Array.from(new Set((bookings || []).map(b => b.startup_id).filter(Boolean)));
                let startupMap = {};
                if (startupIds.length) {
                    const { data: startups } = await supabaseClient
                        .from('startups')
                        .select('id, name, contact_person')
                        .in('id', startupIds);
                    (startups || []).forEach(s => { startupMap[s.id] = s; });
                }

                renderAdminBookingsList(bookings || [], startupMap);
            } catch (e) {
                console.error('loadAdminBookingsData error', e);
                const list = document.getElementById('admin-bookings-list');
                if (list) list.innerHTML = `<div class="text-center text-red-600 py-8">Failed to load bookings: ${e.message}</div>`;
            }
        }

        function renderAdminBookingsList(bookings, startupMap) {
            const list = document.getElementById('admin-bookings-list');
            const countEl = document.getElementById('admin-bookings-count');

            if (!list) return;

            // Update count
            if (countEl) countEl.textContent = bookings.length;

            if (!bookings.length) {
                list.innerHTML = '<div class="text-center text-gray-500 py-8">No bookings found.</div>';
                return;
            }

            list.innerHTML = bookings.map(b => {
                const s = startupMap[b.startup_id];
                const startupName = s?.name || 'Unknown Startup';
                const contact = s?.contact_person || '';
                const statusColor = b.status === 'cancelled' ? 'bg-red-100 text-red-800' :
                                   (b.status === 'confirmed' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800');
                const confidentialBadge = b.is_confidential ? '<span class="ml-2 px-2 py-0.5 bg-purple-100 text-purple-700 text-xs rounded">ðŸ”’ Confidential</span>' : '';

                return `
                    <div class="p-4 hover:bg-gray-50 transition duration-150">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <div class="flex items-center mb-2">
                                    <div class="font-semibold text-gray-900 text-lg">${b.room_name}</div>
                                    ${confidentialBadge}
                                </div>
                                <div class="grid grid-cols-2 gap-2 text-sm text-gray-700 mb-2">
                                    <div>
                                        <svg class="h-4 w-4 inline mr-1 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                        </svg>
                                        ${new Date(b.booking_date).toLocaleDateString('en-US', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' })}
                                    </div>
                                    <div>
                                        <svg class="h-4 w-4 inline mr-1 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                        </svg>
                                        ${b.start_time} â€¢ ${b.duration}h duration
                                    </div>
                                </div>
                                <div class="text-xs text-gray-600">
                                    <svg class="h-4 w-4 inline mr-1 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                                    </svg>
                                    <strong>${startupName}</strong>${contact ? ' â€¢ ' + contact : ''}
                                </div>
                                <div class="text-xs text-gray-500 mt-1">
                                    Booking ID: ${b.id.substring(0, 8)}...
                                </div>
                            </div>
                            <div class="text-right ml-4">
                                <div class="mb-3">
                                    <span class="inline-block px-3 py-1 rounded-full text-xs font-semibold ${statusColor}">${b.status.toUpperCase()}</span>
                                </div>
                                <div class="flex flex-col space-y-2">
                                    <button class="px-3 py-1.5 rounded bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium transition duration-200 flex items-center justify-center" onclick="adminEditBooking('${b.id}')">
                                        <svg class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                        </svg>
                                        Edit
                                    </button>
                                    <button class="px-3 py-1.5 rounded bg-orange-600 hover:bg-orange-700 text-white text-sm font-medium transition duration-200 flex items-center justify-center" onclick="adminCancelBooking('${b.id}')" ${b.status === 'cancelled' ? 'disabled' : ''}>
                                        <svg class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"/>
                                        </svg>
                                        Cancel
                                    </button>
                                    <button class="px-3 py-1.5 rounded bg-red-600 hover:bg-red-700 text-white text-sm font-medium transition duration-200 flex items-center justify-center" onclick="adminDeleteBooking('${b.id}')">
                                        <svg class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                        </svg>
                                        Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        window.adminCancelBooking = async function(bookingId) {
            try {
                console.log('ðŸ”„ [adminCancelBooking] Starting cancellation for booking:', bookingId);

                if (currentUser?.role !== 'admin') {
                    console.error('âŒ [adminCancelBooking] User is not admin');
                    return alert('Only admins can cancel bookings.');
                }

                const reason = prompt('Enter a reason for cancellation (optional):', 'Admin cancelled');
                if (reason === null) {
                    console.log('âš ï¸ [adminCancelBooking] User cancelled the action');
                    return;
                }

                console.log('ðŸ”„ [adminCancelBooking] Deleting booking from database...');
                console.log('ðŸ”„ [adminCancelBooking] Booking ID:', bookingId);

                // ISSUE 3 FIX: Use direct DELETE instead of RPC function
                const { data, error } = await supabaseClient
                    .from('bookings')
                    .delete()
                    .eq('id', bookingId)
                    .select();

                if (error) {
                    console.error('âŒ [adminCancelBooking] Database error:', error);
                    console.error('âŒ [adminCancelBooking] Error details:', {
                        message: error.message,
                        details: error.details,
                        hint: error.hint,
                        code: error.code
                    });
                    throw error;
                }

                if (!data || data.length === 0) {
                    console.warn('âš ï¸ [adminCancelBooking] No rows deleted - booking may not exist or RLS policy blocking');
                    showNotification('Booking cancellation failed - no rows affected', 'error');
                    return;
                }

                console.log('âœ… [adminCancelBooking] Booking deleted successfully:', data);
                showNotification('Booking cancelled successfully', 'success');

                console.log('ðŸ”„ [adminCancelBooking] Reloading booking lists...');
                await loadAdminBookingsData();
                await loadMyBookingsData();

                console.log('âœ… [adminCancelBooking] Complete!');
            } catch (e) {
                console.error('âŒ [adminCancelBooking] Exception:', e);
                showNotification('Failed to cancel booking: ' + e.message, 'error');
            }
        }

        window.adminRescheduleBooking = async function(bookingId) {
            try {
                if (currentUser?.role !== 'admin') return alert('Only admins can reschedule bookings.');
                const newDate = prompt('Enter new date (YYYY-MM-DD):');
                if (!newDate) return;
                const newStart = prompt('Enter new start time (HH:MM, 24h):');
                if (!newStart) return;
                const newDurationStr = prompt('Enter new duration (hours):');
                if (!newDurationStr) return;
                const newDuration = parseInt(newDurationStr, 10);
                const { data, error } = await supabaseClient.rpc('reschedule_booking_admin', { p_booking_id: bookingId, p_new_date: newDate, p_new_start: newStart, p_new_duration: newDuration });
                if (error) throw error;
                if (data && data.ok === false) {
                    showNotification('Could not reschedule: ' + JSON.stringify(data.errors), 'error');
                    return;
                }
                showNotification('Booking rescheduled successfully', 'success');
                await loadAdminBookingsData();
                await loadMyBookingsData();
            } catch (e) {
                console.error('adminRescheduleBooking error', e);
                showNotification('Failed to reschedule: ' + e.message, 'error');
            }
        }

        // ===== ADMIN EDIT BOOKING =====
        window.adminEditBooking = async function(bookingId) {
            try {
                console.log('ðŸ”§ [adminEditBooking] Opening edit modal for booking:', bookingId);

                if (currentUser?.role !== 'admin') {
                    console.error('âŒ [adminEditBooking] User is not admin');
                    return alert('Only admins can edit bookings.');
                }

                // Fetch booking details
                const { data: booking, error } = await supabaseClient
                    .from('bookings')
                    .select(`
                        *,
                        startups (name, contact_person)
                    `)
                    .eq('id', bookingId)
                    .single();

                if (error) throw error;

                console.log('âœ… [adminEditBooking] Loaded booking:', booking);

                // Populate room dropdown
                const roomSelect = document.getElementById('edit-booking-room');
                if (roomSelect) {
                    roomSelect.innerHTML = '<option value="">Select a room</option>' +
                        availableRooms.map(r => `<option value="${r.name}" ${r.name === booking.room_name ? 'selected' : ''}>${r.name}</option>`).join('');
                }

                // Populate form fields
                document.getElementById('edit-booking-id').value = bookingId;
                document.getElementById('edit-booking-room').value = booking.room_name || '';
                document.getElementById('edit-booking-status').value = booking.status || 'confirmed';
                document.getElementById('edit-booking-date').value = booking.booking_date || '';
                document.getElementById('edit-booking-time').value = booking.start_time || '';
                document.getElementById('edit-booking-duration').value = booking.duration || 1;
                document.getElementById('edit-booking-startup').value = booking.startups?.name || 'Unknown Startup';
                document.getElementById('edit-booking-equipment').value = booking.equipment_notes || '';
                document.getElementById('edit-booking-confidential').checked = booking.is_confidential || false;

                // Show modal
                document.getElementById('edit-booking-modal').classList.remove('hidden');

            } catch (error) {
                console.error('âŒ [adminEditBooking] Error:', error);
                showNotification('Failed to load booking details: ' + error.message, 'error');
            }
        };

        // Save edited booking
        async function saveEditedBooking(e) {
            e.preventDefault();

            const bookingId = document.getElementById('edit-booking-id').value;
            const roomName = document.getElementById('edit-booking-room').value;
            const status = document.getElementById('edit-booking-status').value;
            const bookingDate = document.getElementById('edit-booking-date').value;
            const startTime = document.getElementById('edit-booking-time').value;
            const duration = parseInt(document.getElementById('edit-booking-duration').value);
            const equipmentNotes = document.getElementById('edit-booking-equipment').value;
            const isConfidential = document.getElementById('edit-booking-confidential').checked;

            console.log('ðŸ’¾ [saveEditedBooking] Saving changes for booking:', bookingId);
            console.log('   Room:', roomName);
            console.log('   Status:', status);
            console.log('   Date:', bookingDate);
            console.log('   Time:', startTime);
            console.log('   Duration:', duration);

            try {
                const { error } = await supabaseClient
                    .from('bookings')
                    .update({
                        room_name: roomName,
                        status: status,
                        booking_date: bookingDate,
                        start_time: startTime,
                        duration: duration,
                        equipment_notes: equipmentNotes,
                        is_confidential: isConfidential
                    })
                    .eq('id', bookingId);

                if (error) throw error;

                console.log('âœ… [saveEditedBooking] Booking updated successfully');
                showNotification('Booking updated successfully!', 'success');

                // Close modal
                document.getElementById('edit-booking-modal').classList.add('hidden');

                // Refresh booking lists
                console.log('ðŸ”„ [saveEditedBooking] Refreshing booking lists...');
                await loadAdminBookingsData();
                await loadMyBookingsData();

            } catch (error) {
                console.error('âŒ [saveEditedBooking] Error:', error);
                showNotification('Failed to update booking: ' + error.message, 'error');
            }
        }

        // ===== ADMIN DELETE BOOKING (PERMANENT) =====
        window.adminDeleteBooking = async function(bookingId) {
            try {
                console.log('ðŸ—‘ï¸ [adminDeleteBooking] Starting permanent deletion for booking:', bookingId);

                if (currentUser?.role !== 'admin') {
                    console.error('âŒ [adminDeleteBooking] User is not admin');
                    return alert('Only admins can delete bookings.');
                }

                // Strong confirmation
                const confirmText = prompt(
                    'âš ï¸ PERMANENT DELETION WARNING âš ï¸\n\n' +
                    'This will PERMANENTLY DELETE this booking from the database.\n' +
                    'This action CANNOT be undone!\n\n' +
                    'Type "DELETE" (in capital letters) to confirm:'
                );

                if (confirmText !== 'DELETE') {
                    console.log('âš ï¸ [adminDeleteBooking] Deletion cancelled - confirmation failed');
                    showNotification('Deletion cancelled', 'info');
                    return;
                }

                console.log('ðŸ”„ [adminDeleteBooking] Permanently deleting booking from database...');
                console.log('ðŸ”„ [adminDeleteBooking] Booking ID:', bookingId);

                const { data, error } = await supabaseClient
                    .from('bookings')
                    .delete()
                    .eq('id', bookingId)
                    .select();

                if (error) {
                    console.error('âŒ [adminDeleteBooking] Database error:', error);
                    throw error;
                }

                if (!data || data.length === 0) {
                    console.warn('âš ï¸ [adminDeleteBooking] No rows deleted - booking may not exist');
                    showNotification('Deletion failed - booking not found', 'error');
                    return;
                }

                console.log('âœ… [adminDeleteBooking] Booking permanently deleted:', data);
                showNotification('Booking permanently deleted', 'success');

                console.log('ðŸ”„ [adminDeleteBooking] Reloading booking lists...');
                await loadAdminBookingsData();
                await loadMyBookingsData();

                console.log('âœ… [adminDeleteBooking] Complete!');
            } catch (e) {
                console.error('âŒ [adminDeleteBooking] Exception:', e);
                showNotification('Failed to delete booking: ' + e.message, 'error');
            }
        };

        // ===== ADMIN SEARCH AND FILTER =====
        let allAdminBookings = [];
        let allStartupMap = {};

        // Modified loadAdminBookingsData to store all bookings
        const originalLoadAdminBookingsData = loadAdminBookingsData;
        loadAdminBookingsData = async function() {
            try {
                if (currentUser?.role !== 'admin') return;
                const list = document.getElementById('admin-bookings-list');
                if (!list) return;
                list.innerHTML = '<div class="text-center text-gray-500 py-8">Loading all bookings...</div>';

                let { data: bookings, error } = await supabaseClient
                    .from('bookings')
                    .select('id, room_name, booking_date, start_time, duration, status, is_confidential, startup_id, equipment_notes')
                    .order('booking_date', { ascending: false })
                    .order('start_time', { ascending: false });

                if (error) throw error;

                const { data: startups } = await supabaseClient.from('startups').select('id, name, contact_person');
                const startupMap = {};
                (startups || []).forEach(s => { startupMap[s.id] = s; });

                // Store for filtering
                allAdminBookings = bookings || [];
                allStartupMap = startupMap;

                renderAdminBookingsList(allAdminBookings, allStartupMap);
            } catch (e) {
                console.error('loadAdminBookingsData error', e);
                const list = document.getElementById('admin-bookings-list');
                if (list) list.innerHTML = `<div class="text-center text-red-600 py-8">Failed to load bookings: ${e.message}</div>`;
            }
        };

        function filterAdminBookings() {
            const searchText = document.getElementById('admin-search-startup')?.value.toLowerCase() || '';
            const filterRoom = document.getElementById('admin-filter-room')?.value || '';
            const filterStatus = document.getElementById('admin-filter-status')?.value || '';

            console.log('ðŸ” [filterAdminBookings] Filtering with:', { searchText, filterRoom, filterStatus });

            const filtered = allAdminBookings.filter(b => {
                const startup = allStartupMap[b.startup_id];
                const startupName = startup?.name?.toLowerCase() || '';
                const contactPerson = startup?.contact_person?.toLowerCase() || '';

                const matchesSearch = !searchText || startupName.includes(searchText) || contactPerson.includes(searchText);
                const matchesRoom = !filterRoom || b.room_name === filterRoom;
                const matchesStatus = !filterStatus || b.status === filterStatus;

                return matchesSearch && matchesRoom && matchesStatus;
            });

            console.log(`âœ… [filterAdminBookings] Showing ${filtered.length} of ${allAdminBookings.length} bookings`);
            renderAdminBookingsList(filtered, allStartupMap);
        }

        // Add event listeners for search and filter
        document.getElementById('admin-search-startup')?.addEventListener('input', filterAdminBookings);
        document.getElementById('admin-filter-room')?.addEventListener('change', filterAdminBookings);
        document.getElementById('admin-filter-status')?.addEventListener('change', filterAdminBookings);
        document.getElementById('refresh-admin-bookings')?.addEventListener('click', () => loadAdminBookingsData());

        // Add event listeners for edit booking modal
        document.getElementById('edit-booking-modal-close')?.addEventListener('click', () => {
            console.log('ðŸ”§ [Edit Booking Modal] Closing modal (X button)');
            document.getElementById('edit-booking-modal').classList.add('hidden');
        });

        document.getElementById('edit-booking-cancel-btn')?.addEventListener('click', () => {
            console.log('ðŸ”§ [Edit Booking Modal] Closing modal (Cancel button)');
            document.getElementById('edit-booking-modal').classList.add('hidden');
        });

        document.getElementById('edit-booking-form')?.addEventListener('submit', saveEditedBooking);

        // Cancel Booking Modal Event Listeners
        document.getElementById('cancel-booking-modal-close')?.addEventListener('click', () => {
            console.log('ðŸ”§ [Cancel Booking Modal] Closing modal (X button)');
            document.getElementById('cancel-booking-modal').classList.add('hidden');
        });

        document.getElementById('cancel-booking-cancel-btn')?.addEventListener('click', () => {
            console.log('ðŸ”§ [Cancel Booking Modal] Closing modal (Keep Booking button)');
            document.getElementById('cancel-booking-modal').classList.add('hidden');
        });

        document.getElementById('cancel-booking-form')?.addEventListener('submit', handleCancelBooking);

        // ===== SETTINGS EVENT HANDLERS =====
        // Settings page event handlers
        document.addEventListener('DOMContentLoaded', () => {
            // Force reload button
            const forceReloadBtn = document.getElementById('force-reload-btn');
            forceReloadBtn?.addEventListener('click', () => {
                if (confirm('This will clear all cached data and reload the application. Continue?')) {
                    forceReloadApp();
                }
            });

            // Toggle debug information button
            const toggleDebugBtn = document.getElementById('toggle-debug-btn');
            const debugSection = document.getElementById('profile-debug-section');

            toggleDebugBtn?.addEventListener('click', () => {
                if (debugSection.classList.contains('hidden')) {
                    debugSection.classList.remove('hidden');
                    toggleDebugBtn.textContent = 'Hide Debug Information';
                } else {
                    debugSection.classList.add('hidden');
                    toggleDebugBtn.textContent = 'Show Debug Information';
                }
            });

            // Refresh profiles button
            const refreshBtn = document.getElementById('refresh-profiles-btn');
            refreshBtn?.addEventListener('click', async () => {
                console.log('ðŸ”„ Refreshing profile data...');
                if (currentUser) {
                    await bootstrapData({
                        id: currentUser.id,
                        email: currentUser.email,
                        user_metadata: {
                            name: currentUser.name,
                            phone: currentUser.phone,
                            role: currentUser.role
                        }
                    });
                    updateProfileDebugInfo();
                    await loadStartupProfileSettings();
                }
            });

            // Create startup profile button
            const createStartupBtn = document.getElementById('create-startup-profile-btn');
            createStartupBtn?.addEventListener('click', async () => {
                if (!currentUser) {
                    alert('No user profile found. Please refresh the page and try again.');
                    return;
                }

                const startupName = prompt('Enter your startup name:');
                if (!startupName || !startupName.trim()) {
                    alert('Startup name is required.');
                    return;
                }

                const statusEl = document.getElementById('profile-actions-status');
                if (statusEl) {
                    statusEl.innerHTML = '<span class="text-blue-600">ðŸ”„ Creating startup profile...</span>';
                }

                try {
                    console.log('ðŸ”§ Creating startup profile manually...');
                    console.log('ðŸ”§ User ID:', currentUser.id);
                    console.log('ðŸ”§ Startup Name:', startupName.trim());

                    // Use the simplified approach with proper error handling
                    const { data, error } = await supabaseClient
                        .from('startups')
                        .insert({
                            user_id: currentUser.id,
                            name: startupName.trim(),
                            contact_person: currentUser.name || currentUser.email.split('@')[0],
                            phone: currentUser.phone || '',
                            email: currentUser.email,
                            status: 'active'
                        })
                        .select()
                        .single();

                    if (error) {
                        console.error('âŒ Failed to create startup profile:', error);
                        console.error('âŒ Error code:', error.code);
                        console.error('âŒ Error details:', error.details);
                        console.error('âŒ Error hint:', error.hint);

                        let errorMessage = `Failed to create startup profile: ${error.message}`;

                        if (error.code === '42501') {
                            errorMessage += '\n\nThis is an RLS policy issue. Please run the comprehensive-rls-fix.sql script in Supabase SQL Editor.';
                        } else if (error.code === '23505') {
                            errorMessage += '\n\nA startup profile already exists for this user.';
                        }

                        if (statusEl) {
                            statusEl.innerHTML = '<span class="text-red-600">âŒ Failed to create startup profile</span>';
                        }

                        alert(errorMessage);
                    } else {
                        console.log('âœ… Startup profile created successfully:', data);
                        currentStartup = data;

                        // Update UI immediately
                        updateProfileDebugInfo();
                        await loadStartupProfileSettings();

                        if (statusEl) {
                            statusEl.innerHTML = '<span class="text-green-600">âœ… Startup profile created successfully! You can now book rooms.</span>';
                        }

                        alert('âœ… Startup profile created successfully! You can now book rooms.');
                    }
                } catch (err) {
                    console.error('âŒ Exception creating startup profile:', err);

                    if (statusEl) {
                        statusEl.innerHTML = '<span class="text-red-600">âŒ Error creating startup profile</span>';
                    }

                    let errorMessage = `Unexpected error: ${err.message}`;
                    if (err.message.includes('JWT')) {
                        errorMessage += '\n\nAuthentication issue. Please refresh the page and try again.';
                    }

                    alert(errorMessage);
                }
            });

            // Reload profile data button
            const reloadBtn = document.getElementById('reload-profile-data-btn');
            reloadBtn?.addEventListener('click', async () => {
                console.log('ðŸ”„ Reloading all profile data...');
                if (currentUser) {
                    await bootstrapData({
                        id: currentUser.id,
                        email: currentUser.email,
                        user_metadata: {
                            name: currentUser.name,
                            phone: currentUser.phone,
                            role: currentUser.role
                        }
                    });
                    await loadSettingsData();

                    const statusEl = document.getElementById('profile-actions-status');
                    if (statusEl) {
                        statusEl.innerHTML = '<span class="text-blue-600">ðŸ”„ Profile data reloaded</span>';
                    }
                }
            });

            // User profile form
            const userForm = document.getElementById('user-profile-form');
            userForm?.addEventListener('submit', async (e) => {
                e.preventDefault();

                const name = document.getElementById('settings-name').value;
                const phone = document.getElementById('settings-phone').value;

                try {
                    const { error } = await supabaseClient
                        .from('users')
                        .update({ name, phone })
                        .eq('id', currentUser.id);

                    if (error) throw error;

                    // Update current user
                    currentUser.name = name;
                    currentUser.phone = phone;

                    alert('User profile updated successfully!');
                    updateProfileDebugInfo();
                } catch (err) {
                    console.error('Error updating user profile:', err);
                    alert(`Failed to update profile: ${err.message}`);
                }
            });

            // Password change form
            const passwordForm = document.getElementById('password-form');
            passwordForm?.addEventListener('submit', async (e) => {
                e.preventDefault();

                const currentPassword = document.getElementById('current-password').value;
                const newPassword = document.getElementById('new-password').value;
                const confirmPassword = document.getElementById('confirm-password').value;
                const messageEl = document.getElementById('password-message');

                // Clear previous messages
                if (messageEl) {
                    messageEl.classList.add('hidden');
                    messageEl.innerHTML = '';
                }

                // Validation
                if (newPassword.length < 6) {
                    if (messageEl) {
                        messageEl.innerHTML = '<div class="p-4 rounded-lg bg-red-100 text-red-700">New password must be at least 6 characters long.</div>';
                        messageEl.classList.remove('hidden');
                    }
                    return;
                }

                if (newPassword !== confirmPassword) {
                    if (messageEl) {
                        messageEl.innerHTML = '<div class="p-4 rounded-lg bg-red-100 text-red-700">New password and confirm password do not match.</div>';
                        messageEl.classList.remove('hidden');
                    }
                    return;
                }

                try {
                    // Verify current password by attempting to sign in
                    const { error: signInError } = await supabaseClient.auth.signInWithPassword({
                        email: currentUser.email,
                        password: currentPassword
                    });

                    if (signInError) {
                        if (messageEl) {
                            messageEl.innerHTML = '<div class="p-4 rounded-lg bg-red-100 text-red-700">Current password is incorrect.</div>';
                            messageEl.classList.remove('hidden');
                        }
                        return;
                    }

                    // Update password using Supabase Auth
                    const { error: updateError } = await supabaseClient.auth.updateUser({
                        password: newPassword
                    });

                    if (updateError) throw updateError;

                    // Success
                    if (messageEl) {
                        messageEl.innerHTML = '<div class="p-4 rounded-lg bg-green-100 text-green-700">âœ… Password updated successfully!</div>';
                        messageEl.classList.remove('hidden');
                    }

                    // Clear form fields
                    document.getElementById('current-password').value = '';
                    document.getElementById('new-password').value = '';
                    document.getElementById('confirm-password').value = '';

                    // Hide success message after 5 seconds
                    setTimeout(() => {
                        if (messageEl) {
                            messageEl.classList.add('hidden');
                        }
                    }, 5000);

                } catch (err) {
                    console.error('Error updating password:', err);
                    if (messageEl) {
                        messageEl.innerHTML = `<div class="p-4 rounded-lg bg-red-100 text-red-700">Failed to update password: ${err.message}</div>`;
                        messageEl.classList.remove('hidden');
                    }
                }
            });
        });

        async function handleStartupProfileUpdate(e) {
            e.preventDefault();

            const name = document.getElementById('startup-name').value;
            const contactPerson = document.getElementById('startup-contact-person').value;
            const phone = document.getElementById('startup-phone').value;
            const email = document.getElementById('startup-email').value;
            const status = document.getElementById('startup-status').value;

            try {
                const { error } = await supabaseClient
                    .from('startups')
                    .update({
                        name,
                        contact_person: contactPerson,
                        phone,
                        email,
                        status
                    })
                    .eq('id', currentStartup.id);

                if (error) throw error;

                // Update current startup
                currentStartup.name = name;
                currentStartup.contact_person = contactPerson;
                currentStartup.phone = phone;
                currentStartup.email = email;
                currentStartup.status = status;

                alert('Startup profile updated successfully!');
                updateProfileDebugInfo();
            } catch (err) {
                console.error('Error updating startup profile:', err);
                alert(`Failed to update startup profile: ${err.message}`);
            }
        }

        // ===== EVENT LISTENERS =====
        // Navigation
        window.addEventListener('hashchange', () => showPage(window.location.hash));

        // Sidebar toggle (mobile)
        const sidebarToggle = document.getElementById('sidebar-toggle');
        const sidebarEl = document.getElementById('sidebar');
        let sidebarOverlay = null;

        sidebarToggle?.addEventListener('click', () => {
            if (window.innerWidth <= 768) {
                sidebarEl?.classList.toggle('mobile-open');

                if (sidebarEl?.classList.contains('mobile-open')) {
                    // Create overlay
                    sidebarOverlay = document.createElement('div');
                    sidebarOverlay.className = 'sidebar-overlay';
                    sidebarOverlay.addEventListener('click', closeMobileSidebar);
                    document.body.appendChild(sidebarOverlay);
                } else {
                    closeMobileSidebar();
                }
            }
        });

        function closeMobileSidebar() {
            sidebarEl?.classList.remove('mobile-open');
            if (sidebarOverlay) {
                sidebarOverlay.remove();
                sidebarOverlay = null;
            }
        }

        // Create admin button
        const createAdminBtn = document.getElementById('create-admin-btn');
        createAdminBtn?.addEventListener('click', createAdminAccount);

        // Booking tabs
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('booking-tab-btn')) {
                const tab = e.target.dataset.tab;

                // Update tab buttons
                document.querySelectorAll('.booking-tab-btn').forEach(btn => {
                    btn.classList.remove('border-green-500', 'text-green-600');
                    btn.classList.add('border-transparent', 'text-gray-500');
                });
                e.target.classList.remove('border-transparent', 'text-gray-500');
                e.target.classList.add('border-green-500', 'text-green-600');

                // Update tab content
                document.querySelectorAll('.booking-tab-content').forEach(content => {
                    content.classList.add('hidden');
                });
                document.getElementById(`${tab}-bookings`)?.classList.remove('hidden');
            }
        });

        // ===== UTILITY FUNCTIONS =====
        function setSignupLoading(isLoading) {
            const btn = document.getElementById('signup-submit-btn');
            const t1 = document.getElementById('signup-btn-text');
            const t2 = document.getElementById('signup-btn-loading');
            if (!btn || !t1 || !t2) return;
            btn.disabled = isLoading;
            t1.classList.toggle('hidden', isLoading);
            t2.classList.toggle('hidden', !isLoading);
        }

        function showSignupError(msg) {
            if (!signupErrorEl) return;
            signupErrorEl.textContent = msg;
            signupErrorEl.classList.remove('hidden');
        }

        function showSignupSuccess(msg) {
            if (!signupSuccessEl) return;
            signupSuccessEl.textContent = msg;
            signupSuccessEl.classList.remove('hidden');
        }

        function showBookingBanner(message, color) {
            const bookingMessage = document.getElementById('booking-message');
            if (!bookingMessage) return;
            const colorClasses = {
                red: 'bg-red-100 text-red-700 border-red-400',
                green: 'bg-green-100 text-green-700 border-green-400'
            };
            bookingMessage.innerHTML = `<div class="p-4 rounded-md border-l-4 ${colorClasses[color]||''} font-medium">${message}</div>`;
            bookingMessage.classList.remove('hidden');
            setTimeout(() => {
                bookingMessage.innerHTML = '';
                bookingMessage.classList.add('hidden');
            }, 4000);
        }

        function showMessage(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${
                type === 'success' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'
            }`;
            alertDiv.innerHTML = `
                <div class="flex items-center">
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-current hover:opacity-70">Ã—</button>
                </div>
            `;
            document.body.appendChild(alertDiv);
            setTimeout(() => alertDiv.remove(), 5000);
        }

        // ISSUE 1 FIX: Create showNotification alias for showMessage
        // This fixes the "showNotification is not defined" error
        const showNotification = showMessage;
        console.log('âœ… [showNotification] Function alias created successfully');

        // ===== INTERACTIVE CALENDAR SYSTEM =====
        let currentCalendarDate = new Date();
        let selectedDate = null;

        async function loadScheduleData() {
            console.log('Loading interactive schedule data...');
            initializeCalendar();
            setupCalendarEventListeners();
        }

        function initializeCalendar() {
            renderCalendar(currentCalendarDate);
            // Select today by default
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            selectDate(`${year}-${month}-${day}`);
        }

        function renderCalendar(date) {
            const monthYearEl = document.getElementById('month-year');
            const calendarGrid = document.getElementById('calendar-grid');

            if (!monthYearEl || !calendarGrid) return;

            // Set month/year header
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'];
            monthYearEl.textContent = `${monthNames[date.getMonth()]} ${date.getFullYear()}`;

            // Clear calendar grid
            calendarGrid.innerHTML = '';

            // Get first day of month and number of days
            const firstDay = new Date(date.getFullYear(), date.getMonth(), 1);
            const lastDay = new Date(date.getFullYear(), date.getMonth() + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());

            // Generate calendar days (6 weeks = 42 days)
            for (let i = 0; i < 42; i++) {
                const currentDate = new Date(startDate);
                currentDate.setDate(startDate.getDate() + i);

                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day relative p-4 text-center cursor-pointer transition-all duration-200 border-r border-b border-gray-200 hover:bg-gray-50';
                dayElement.textContent = currentDate.getDate();
                // Use local date components to avoid timezone issues
                const year = currentDate.getFullYear();
                const month = String(currentDate.getMonth() + 1).padStart(2, '0');
                const day = String(currentDate.getDate()).padStart(2, '0');
                dayElement.dataset.date = `${year}-${month}-${day}`;

                // Remove right border for last column
                if ((i + 1) % 7 === 0) {
                    dayElement.classList.remove('border-r');
                }

                // Remove bottom border for last row
                if (i >= 35) {
                    dayElement.classList.remove('border-b');
                }

                // Style current month vs other months
                if (currentDate.getMonth() !== date.getMonth()) {
                    dayElement.className += ' text-gray-300 bg-gray-50';
                } else {
                    dayElement.className += ' text-gray-900 font-medium';
                }

                // Highlight today with green background
                const today = new Date();
                const todayYear = today.getFullYear();
                const todayMonth = String(today.getMonth() + 1).padStart(2, '0');
                const todayDay = String(today.getDate()).padStart(2, '0');
                const todayDateString = `${todayYear}-${todayMonth}-${todayDay}`;

                if (dayElement.dataset.date === todayDateString) {
                    dayElement.className = 'calendar-day relative p-4 text-center cursor-pointer transition-all duration-200 border-r border-b border-gray-200 bg-green-600 text-white font-bold hover:bg-green-700';
                    // Remove right border for last column
                    if ((i + 1) % 7 === 0) {
                        dayElement.classList.remove('border-r');
                    }
                    // Remove bottom border for last row
                    if (i >= 35) {
                        dayElement.classList.remove('border-b');
                    }
                }

                // Highlight selected date with ring
                if (selectedDate && dayElement.dataset.date === selectedDate) {
                    if (dayElement.dataset.date !== todayDateString) {
                        dayElement.className += ' ring-2 ring-inset ring-green-500 bg-green-50';
                    }
                }

                calendarGrid.appendChild(dayElement);
            }
        }

        function setupCalendarEventListeners() {
            const prevMonthBtn = document.getElementById('prev-month');
            const nextMonthBtn = document.getElementById('next-month');
            const calendarGrid = document.getElementById('calendar-grid');

            if (prevMonthBtn) {
                prevMonthBtn.addEventListener('click', () => {
                    currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
                    renderCalendar(currentCalendarDate);
                });
            }

            if (nextMonthBtn) {
                nextMonthBtn.addEventListener('click', () => {
                    currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
                    renderCalendar(currentCalendarDate);
                });
            }

            if (calendarGrid) {
                calendarGrid.addEventListener('click', (e) => {
                    if (e.target.classList.contains('calendar-day') && e.target.dataset.date) {
                        selectDate(e.target.dataset.date);
                        renderCalendar(currentCalendarDate); // Re-render to update selection
                    }
                });
            }
        }

        async function selectDate(dateString) {
            selectedDate = dateString;
            console.log('Selected date:', dateString);
            await loadScheduleForDate(dateString);
        }

        async function loadScheduleForDate(dateString) {
            const scheduleDetails = document.getElementById('schedule-details');
            if (!scheduleDetails) return;

            try {
                // Show loading state
                scheduleDetails.innerHTML = `
                    <h4 class="text-lg font-semibold text-gray-900 mb-4">Bookings for ${formatDate(dateString)}</h4>
                    <div class="text-center py-4">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-green-500 mx-auto"></div>
                        <p class="text-gray-500 mt-2">Loading bookings...</p>
                    </div>
                `;

                // Load bookings for the selected date
                const { data: bookings, error } = await supabaseClient
                    .from('bookings')
                    .select(`
                        *,
                        startups (name, contact_person)
                    `)
                    .eq('booking_date', dateString)
                    .order('start_time');

                if (error) {
                    console.error('Error loading bookings:', error);
                    scheduleDetails.innerHTML = `
                        <h4 class="text-lg font-semibold text-gray-900 mb-4">Bookings for ${formatDate(dateString)}</h4>
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                            <p class="text-red-600">Error loading bookings: ${error.message}</p>
                        </div>
                    `;
                    return;
                }

                // Display bookings
                if (!bookings || bookings.length === 0) {
                    scheduleDetails.innerHTML = `
                        <h4 class="text-lg font-semibold text-gray-900 mb-4">Bookings for ${formatDate(dateString)}</h4>
                        <div class="text-center py-12">
                            <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <h3 class="text-lg font-medium text-gray-900 mb-2">No bookings for this date</h3>
                            <p class="text-gray-600">All rooms are available for booking.</p>
                        </div>
                    `;
                    return;
                }

                // Create booking cards display
                let scheduleHTML = `
                    <h4 class="text-lg font-semibold text-gray-900 mb-6">Bookings for ${formatDate(dateString)}</h4>
                    <div class="space-y-4">
                `;

                bookings.forEach(booking => {
                    const startupName = booking.startups?.name || 'Unknown Startup';
                    const endTime = addHours(booking.start_time, booking.duration);
                    const status = booking.status || 'Confirmed';

                    // Status color coding
                    let statusColor, statusBg, statusBorder;
                    if (status === 'Confirmed') {
                        statusColor = 'text-green-700';
                        statusBg = 'bg-green-50';
                        statusBorder = 'border-green-200';
                    } else if (status === 'Pending') {
                        statusColor = 'text-yellow-700';
                        statusBg = 'bg-yellow-50';
                        statusBorder = 'border-yellow-200';
                    } else if (status === 'Cancelled') {
                        statusColor = 'text-red-700';
                        statusBg = 'bg-red-50';
                        statusBorder = 'border-red-200';
                    } else {
                        statusColor = 'text-gray-700';
                        statusBg = 'bg-gray-50';
                        statusBorder = 'border-gray-200';
                    }

                    scheduleHTML += `
                        <div class="border-2 rounded-xl p-6 hover:shadow-md transition-all duration-200 ${statusBg} ${statusBorder}">
                            <!-- Header with Room and Status -->
                            <div class="flex justify-between items-start mb-4">
                                <div class="flex items-center space-x-3">
                                    <div class="w-12 h-12 bg-white rounded-lg flex items-center justify-center shadow-sm">
                                        <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                                        </svg>
                                    </div>
                                    <div>
                                        <h3 class="text-lg font-bold text-gray-900">${booking.room_name}</h3>
                                        <p class="text-sm text-gray-600">${startupName}</p>
                                    </div>
                                </div>
                                <span class="px-3 py-1 ${statusBg} ${statusColor} text-sm font-semibold rounded-full border ${statusBorder}">
                                    ${status}
                                </span>
                            </div>

                            <!-- Booking Details Grid -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <!-- Time -->
                                <div class="flex items-center space-x-3">
                                    <div class="w-10 h-10 bg-white rounded-lg flex items-center justify-center shadow-sm">
                                        <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                    </div>
                                    <div>
                                        <p class="text-xs text-gray-500 font-medium">Time</p>
                                        <p class="text-sm font-semibold text-gray-900">${formatTime(booking.start_time)} - ${formatTime(endTime)}</p>
                                    </div>
                                </div>

                                <!-- Duration -->
                                <div class="flex items-center space-x-3">
                                    <div class="w-10 h-10 bg-white rounded-lg flex items-center justify-center shadow-sm">
                                        <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                        </svg>
                                    </div>
                                    <div>
                                        <p class="text-xs text-gray-500 font-medium">Duration</p>
                                        <p class="text-sm font-semibold text-gray-900">${booking.duration} hour${booking.duration > 1 ? 's' : ''}</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Equipment Notes (if any) -->
                            ${booking.equipment_notes ? `
                                <div class="bg-white rounded-lg p-3 mb-4 border border-gray-200">
                                    <p class="text-xs text-gray-500 font-medium mb-1">Equipment Notes</p>
                                    <p class="text-sm text-gray-700">${booking.equipment_notes}</p>
                                </div>
                            ` : ''}

                            <!-- Confidential Badge -->
                            ${booking.is_confidential ? `
                                <div class="flex items-center space-x-2 mb-4">
                                    <svg class="w-5 h-5 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                                    </svg>
                                    <span class="text-sm font-medium text-orange-600">Confidential Meeting</span>
                                </div>
                            ` : ''}

                            <!-- Admin Action Buttons -->
                            ${currentUser && currentUser.role === 'admin' ? `
                                <div class="pt-4 border-t border-gray-200">
                                    <div class="flex flex-col md:flex-row gap-3">
                                        ${status !== 'Cancelled' ? `
                                            <button onclick='showCancelBookingModal("${booking.id}")' class="flex-1 px-6 py-2.5 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 transition-all duration-200 font-medium shadow-sm hover:shadow-md flex items-center justify-center space-x-2">
                                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                                </svg>
                                                <span>Cancel Booking</span>
                                            </button>
                                        ` : ''}
                                        <button onclick='showDeleteBookingModal("${booking.id}", "${booking.room_name}", "${startupName.replace(/'/g, "\\'")}")' class="flex-1 px-6 py-2.5 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-all duration-200 font-medium shadow-sm hover:shadow-md flex items-center justify-center space-x-2">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                            </svg>
                                            <span>Delete Booking</span>
                                        </button>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                });

                scheduleHTML += '</div>';
                scheduleDetails.innerHTML = scheduleHTML;

            } catch (error) {
                console.error('Error loading schedule:', error);
                scheduleDetails.innerHTML = `
                    <h4 class="text-lg font-semibold text-gray-900 mb-4">Schedule for ${formatDate(dateString)}</h4>
                    <p class="text-red-600">Error loading schedule data.</p>
                `;
            }
        }

        // Show cancel booking modal
        async function showCancelBookingModal(bookingId) {
            console.log('ðŸ“… [Schedule] Opening cancel booking modal for:', bookingId);

            try {
                // Fetch booking details
                const { data: booking, error } = await supabaseClient
                    .from('bookings')
                    .select(`
                        *,
                        startups (name, contact_person)
                    `)
                    .eq('id', bookingId)
                    .single();

                if (error) {
                    console.error('Error fetching booking:', error);
                    showNotification('Error loading booking details', 'error');
                    return;
                }

                // Populate modal
                document.getElementById('cancel-booking-id').value = bookingId;
                document.getElementById('cancel-booking-reason').value = '';

                const detailsDiv = document.getElementById('cancel-booking-details');
                detailsDiv.innerHTML = `
                    <div class="space-y-2">
                        <div class="flex justify-between">
                            <span class="text-sm font-medium text-gray-600">Room:</span>
                            <span class="text-sm font-semibold text-gray-900">${booking.room_name}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm font-medium text-gray-600">Startup:</span>
                            <span class="text-sm font-semibold text-gray-900">${booking.startups?.name || 'Unknown'}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm font-medium text-gray-600">Date:</span>
                            <span class="text-sm font-semibold text-gray-900">${formatDate(booking.booking_date)}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm font-medium text-gray-600">Time:</span>
                            <span class="text-sm font-semibold text-gray-900">${formatTime(booking.start_time)}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm font-medium text-gray-600">Duration:</span>
                            <span class="text-sm font-semibold text-gray-900">${booking.duration} hour${booking.duration > 1 ? 's' : ''}</span>
                        </div>
                    </div>
                `;

                // Show modal
                document.getElementById('cancel-booking-modal').classList.remove('hidden');
            } catch (err) {
                console.error('Error showing cancel modal:', err);
                showNotification('Error loading booking details', 'error');
            }
        }

        // Handle cancel booking form submission
        async function handleCancelBooking(e) {
            e.preventDefault();

            const bookingId = document.getElementById('cancel-booking-id').value;
            const reason = document.getElementById('cancel-booking-reason').value.trim();

            if (!reason) {
                showNotification('Please provide a cancellation reason', 'error');
                return;
            }

            console.log('ðŸ“… [Schedule] Cancelling booking:', bookingId, 'Reason:', reason);

            try {
                // Update booking status to Cancelled
                const { error } = await supabaseClient
                    .from('bookings')
                    .update({
                        status: 'Cancelled',
                        equipment_notes: (await supabaseClient
                            .from('bookings')
                            .select('equipment_notes')
                            .eq('id', bookingId)
                            .single()).data?.equipment_notes
                            ? (await supabaseClient
                                .from('bookings')
                                .select('equipment_notes')
                                .eq('id', bookingId)
                                .single()).data.equipment_notes + `\n\nCancellation Reason: ${reason}`
                            : `Cancellation Reason: ${reason}`,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', bookingId);

                if (error) {
                    console.error('Error cancelling booking:', error);
                    showNotification('Error cancelling booking: ' + error.message, 'error');
                    return;
                }

                console.log('âœ… [Schedule] Booking cancelled successfully');
                showNotification('Booking cancelled successfully', 'success');

                // Close modal
                document.getElementById('cancel-booking-modal').classList.add('hidden');

                // Refresh the schedule for the selected date
                if (selectedDate) {
                    await loadScheduleForDate(selectedDate);
                }
            } catch (err) {
                console.error('Error cancelling booking:', err);
                showNotification('Error cancelling booking', 'error');
            }
        }

        // ===== DELETE BOOKING FUNCTIONS =====
        let bookingToDelete = null;

        function showDeleteBookingModal(bookingId, roomName, startupName) {
            if (currentUser?.role !== 'admin') {
                alert('Only administrators can delete bookings.');
                return;
            }

            bookingToDelete = { id: bookingId, room: roomName, startup: startupName };

            // Update modal content
            document.getElementById('delete-booking-room').textContent = roomName;
            document.getElementById('delete-booking-startup').textContent = startupName;

            // Show modal
            const modal = document.getElementById('delete-booking-modal');
            if (modal) {
                modal.classList.remove('hidden');
            }
        }

        async function handleDeleteBooking() {
            if (!bookingToDelete || currentUser?.role !== 'admin') {
                return;
            }

            try {
                console.log('ðŸ—‘ï¸ Deleting booking:', bookingToDelete);

                // Delete the booking record permanently
                const { error } = await supabaseClient
                    .from('bookings')
                    .delete()
                    .eq('id', bookingToDelete.id);

                if (error) throw error;
                console.log('âœ… Booking deleted successfully');

                showMessage(`Booking for "${bookingToDelete.room}" has been deleted permanently!`, 'success');

                // Close modal and refresh data
                closeDeleteBookingModal();

                // Refresh the schedule for the selected date
                if (selectedDate) {
                    await loadScheduleForDate(selectedDate);
                }

            } catch (error) {
                console.error('Error deleting booking:', error);
                showMessage(`Failed to delete booking: ${error.message}`, 'error');
            }
        }

        function closeDeleteBookingModal() {
            const modal = document.getElementById('delete-booking-modal');
            if (modal) {
                modal.classList.add('hidden');
            }
            bookingToDelete = null;
        }

        // Setup delete booking modal event listeners
        document.addEventListener('DOMContentLoaded', () => {
            const deleteBookingModal = document.getElementById('delete-booking-modal');
            const closeBtn = document.getElementById('delete-booking-modal-close');
            const cancelBtn = document.getElementById('delete-booking-cancel');
            const confirmBtn = document.getElementById('delete-booking-confirm');

            if (closeBtn) {
                closeBtn.addEventListener('click', closeDeleteBookingModal);
            }

            if (cancelBtn) {
                cancelBtn.addEventListener('click', closeDeleteBookingModal);
            }

            if (confirmBtn) {
                confirmBtn.addEventListener('click', handleDeleteBooking);
            }

            // Close modal when clicking outside
            if (deleteBookingModal) {
                deleteBookingModal.addEventListener('click', (e) => {
                    if (e.target === deleteBookingModal) {
                        closeDeleteBookingModal();
                    }
                });
            }
        });

        // Utility functions for calendar
        function formatDate(dateString) {
            // Parse date string as local date to avoid timezone issues
            const [year, month, day] = dateString.split('-').map(Number);
            const date = new Date(year, month - 1, day);
            return date.toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        function formatTime(timeString) {
            const [hours, minutes] = timeString.split(':');
            const hour = parseInt(hours);
            const ampm = hour >= 12 ? 'PM' : 'AM';
            const displayHour = hour % 12 || 12;
            return `${displayHour}:${minutes} ${ampm}`;
        }

        function addHours(timeString, hours) {
            const [hour, minute] = timeString.split(':').map(Number);
            const newHour = hour + hours;
            return `${newHour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
        }

        function showBookingDetails(bookingId) {
            // This could be enhanced to show a modal with full booking details
            console.log('Show booking details for:', bookingId);
            // For now, just show an alert - could be enhanced with a modal
            alert('Booking details feature - could show full booking information in a modal');
        }

        // ===== REAL-TIME ROOM DISPLAYS SYSTEM =====
        let roomDisplaysInterval = null;

        async function loadRoomDisplaysData() {
            console.log('Loading real-time room displays...');
            await renderRoomStatusDashboard();
            setupRoomDisplaysRefresh();
        }

        async function renderRoomStatusDashboard() {
            const roomCardsContainer = document.getElementById('room-cards-container');
            if (!roomCardsContainer) return;

            try {
                console.log('ðŸ”„ [renderRoomStatusDashboard] Starting to render room status dashboard...');

                // Show loading state
                roomCardsContainer.innerHTML = `
                    <div class="col-span-full text-center py-8">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-green-500 mx-auto mb-4"></div>
                        <p class="text-gray-500">Loading real-time room status...</p>
                    </div>
                `;

                // Get current date and time
                const now = new Date();
                const currentDate = now.toISOString().split('T')[0];
                const currentTime = now.toTimeString().split(' ')[0].substring(0, 5);

                console.log(`ðŸ“… [renderRoomStatusDashboard] Current date: ${currentDate}, time: ${currentTime}`);
                console.log(`ðŸ“Š [renderRoomStatusDashboard] Total rooms in availableRooms array: ${availableRooms.length}`);

                // Log all rooms
                availableRooms.forEach((room, index) => {
                    console.log(`   ${index + 1}. ${room.name} (capacity: ${room.capacity}, type: ${room.type})`);
                });

                // Load today's bookings with enhanced error handling
                let todaysBookings = [];
                try {
                    const { data, error } = await supabaseClient
                        .from('bookings')
                        .select(`
                            *,
                            startups (name, contact_person)
                        `)
                        .eq('booking_date', currentDate)
                        .order('start_time');

                    if (error) {
                        console.error('Error loading room status:', error);

                        // Check if it's a schema error
                        if (error.message.includes('relation "public.bookings" does not exist') ||
                            error.message.includes('Could not find the') ||
                            error.message.includes('schema cache')) {
                            roomCardsContainer.innerHTML = `
                                <div class="col-span-full">
                                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6">
                                        <div class="flex items-center mb-3">
                                            <svg class="w-6 h-6 text-yellow-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                                            </svg>
                                            <h3 class="text-lg font-medium text-yellow-800">Database Setup Required</h3>
                                        </div>
                                        <p class="text-yellow-700 mb-4">The bookings table is not properly configured. Room status will show as available until the database is set up.</p>
                                        <p class="text-sm text-yellow-600">Please run the database-setup.sql script in your Supabase SQL Editor.</p>
                                    </div>
                                </div>
                            `;
                            // Continue with empty bookings to show rooms as available
                            todaysBookings = [];
                        } else {
                            roomCardsContainer.innerHTML = `
                                <div class="col-span-full text-center py-8">
                                    <p class="text-red-600">Error loading room status data: ${error.message}</p>
                                </div>
                            `;
                            return;
                        }
                    } else {
                        todaysBookings = data || [];
                    }
                } catch (networkError) {
                    console.error('Network error loading room status:', networkError);
                    // Continue with empty bookings array to show rooms as available
                    todaysBookings = [];
                }

                // Generate room status cards
                let roomCardsHTML = '';

                availableRooms.forEach(room => {
                    const roomBookings = todaysBookings.filter(booking => booking.room_name === room.name);
                    const status = getRoomStatus(roomBookings, currentTime);

                    roomCardsHTML += `
                        <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 ${status.borderColor}">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-xl font-bold text-gray-900">${room.name}</h3>
                                <div class="flex items-center space-x-2">
                                    <div class="w-3 h-3 rounded-full ${status.indicatorColor}"></div>
                                    <span class="text-sm font-medium ${status.textColor}">${status.text}</span>
                                </div>
                            </div>

                            <div class="space-y-2 text-sm text-gray-600">
                                <div class="flex justify-between">
                                    <span>Capacity:</span>
                                    <span class="font-medium">${room.capacity} people</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Type:</span>
                                    <span class="font-medium">${room.type === 'focus' ? 'Focus Room' : 'Special Room'}</span>
                                </div>
                            </div>

                            <div class="mt-4 pt-4 border-t border-gray-200">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm font-medium text-gray-700">Current Status:</span>
                                    <span class="text-xs text-gray-500">${formatTime(currentTime)}</span>
                                </div>

                                ${status.currentBooking ? `
                                    <div class="bg-red-50 border border-red-200 rounded-lg p-3">
                                        <div class="flex items-center space-x-2 mb-1">
                                            <svg class="w-4 h-4 text-red-500" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                                            </svg>
                                            <span class="text-sm font-medium text-red-800">Occupied</span>
                                        </div>
                                        <div class="text-xs text-red-700">
                                            ${status.currentBooking.startups?.name || 'Unknown'}<br>
                                            Until ${formatTime(addHours(status.currentBooking.start_time, status.currentBooking.duration))}
                                        </div>
                                    </div>
                                ` : `
                                    <div class="bg-green-50 border border-green-200 rounded-lg p-3">
                                        <div class="flex items-center space-x-2 mb-1">
                                            <svg class="w-4 h-4 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                            </svg>
                                            <span class="text-sm font-medium text-green-800">Available</span>
                                        </div>
                                        ${status.nextBooking ? `
                                            <div class="text-xs text-green-700">
                                                Next: ${formatTime(status.nextBooking.start_time)} - ${status.nextBooking.startups?.name || 'Unknown'}
                                            </div>
                                        ` : `
                                            <div class="text-xs text-green-700">No upcoming bookings today</div>
                                        `}
                                    </div>
                                `}
                            </div>

                            <div class="mt-4">
                                <div class="flex flex-wrap gap-1">
                                    ${room.equipment.slice(0, 3).map(eq =>
                                        `<span class="inline-block bg-gray-100 text-gray-700 px-2 py-1 rounded text-xs">${eq}</span>`
                                    ).join('')}
                                    ${room.equipment.length > 3 ? `<span class="text-xs text-gray-500">+${room.equipment.length - 3} more</span>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                });

                roomCardsContainer.innerHTML = roomCardsHTML;

            } catch (error) {
                console.error('Error rendering room status:', error);
                roomCardsContainer.innerHTML = `
                    <div class="col-span-full text-center py-8">
                        <p class="text-red-600">Error loading room status.</p>
                    </div>
                `;
            }
        }

        function getRoomStatus(roomBookings, currentTime) {
            const now = currentTime;

            // Find current booking (if any)
            const currentBooking = roomBookings.find(booking => {
                const startTime = booking.start_time;
                const endTime = addHours(startTime, booking.duration);
                return now >= startTime && now < endTime;
            });

            // Find next booking
            const nextBooking = roomBookings
                .filter(booking => booking.start_time > now)
                .sort((a, b) => a.start_time.localeCompare(b.start_time))[0];

            if (currentBooking) {
                return {
                    text: 'Occupied',
                    indicatorColor: 'bg-red-500',
                    borderColor: 'border-red-500',
                    textColor: 'text-red-600',
                    currentBooking,
                    nextBooking
                };
            } else if (nextBooking) {
                const timeUntilNext = getTimeUntilBooking(nextBooking.start_time, now);
                if (timeUntilNext <= 30) { // 30 minutes or less
                    return {
                        text: 'Available (Soon Occupied)',
                        indicatorColor: 'bg-yellow-500',
                        borderColor: 'border-yellow-500',
                        textColor: 'text-yellow-600',
                        currentBooking: null,
                        nextBooking
                    };
                } else {
                    return {
                        text: 'Available',
                        indicatorColor: 'bg-green-500',
                        borderColor: 'border-green-500',
                        textColor: 'text-green-600',
                        currentBooking: null,
                        nextBooking
                    };
                }
            } else {
                return {
                    text: 'Available',
                    indicatorColor: 'bg-green-500',
                    borderColor: 'border-green-500',
                    textColor: 'text-green-600',
                    currentBooking: null,
                    nextBooking: null
                };
            }
        }

        function getTimeUntilBooking(bookingTime, currentTime) {
            const [bookingHour, bookingMinute] = bookingTime.split(':').map(Number);
            const [currentHour, currentMinute] = currentTime.split(':').map(Number);

            const bookingMinutes = bookingHour * 60 + bookingMinute;
            const currentMinutes = currentHour * 60 + currentMinute;

            return bookingMinutes - currentMinutes;
        }

        function setupRoomDisplaysRefresh() {
            // Clear existing interval
            if (roomDisplaysInterval) {
                clearInterval(roomDisplaysInterval);
            }

            console.log('ðŸ”„ [setupRoomDisplaysRefresh] Setting up auto-refresh for Room Displays tab');
            console.log('â° [setupRoomDisplaysRefresh] Refresh interval: 30 seconds');

            // Refresh every 30 seconds
            roomDisplaysInterval = setInterval(async () => {
                const currentPage = window.location.hash;
                if (currentPage === '#room-displays') {
                    console.log('ðŸ”„ [Auto-Refresh] Refreshing Room Displays tab...');
                    await renderRoomStatusDashboard();
                    console.log('âœ… [Auto-Refresh] Room Displays tab refreshed');
                }
            }, 30000);

            console.log('âœ… [setupRoomDisplaysRefresh] Auto-refresh scheduled successfully');
        }

        // ===== REPORTS FUNCTIONALITY =====
        let currentReportData = null;
        let roomUsageChart = null;
        let bookingTrendsChart = null;

        async function loadReportsData() {
            console.log('Loading reports data...');

            // Initialize report filters
            initializeReportFilters();

            // Load startups for startup-specific reports
            await loadStartupsForReports();

            // Set default dates
            setDefaultReportDates();
        }

        function initializeReportFilters() {
            const reportPeriod = document.getElementById('report-period');
            const reportType = document.getElementById('report-type');
            const generateBtn = document.getElementById('generate-report-btn');
            const exportCsvBtn = document.getElementById('export-csv-btn');
            const exportPdfBtn = document.getElementById('export-pdf-btn');

            // Handle period change
            reportPeriod?.addEventListener('change', handlePeriodChange);

            // Handle report type change
            reportType?.addEventListener('change', handleReportTypeChange);

            // Handle generate report
            generateBtn?.addEventListener('click', generateReport);

            // Handle exports
            exportCsvBtn?.addEventListener('click', exportToCSV);
            exportPdfBtn?.addEventListener('click', exportToPDF);
        }

        function handlePeriodChange() {
            const period = document.getElementById('report-period')?.value;
            const customDateRange = document.getElementById('custom-date-range');
            const customDateRangeEnd = document.getElementById('custom-date-range-end');
            const specificDateFilter = document.getElementById('specific-date-filter');

            // Hide all date inputs first
            customDateRange?.classList.add('hidden');
            customDateRangeEnd?.classList.add('hidden');
            specificDateFilter?.classList.add('hidden');

            if (period === 'custom') {
                customDateRange?.classList.remove('hidden');
                customDateRangeEnd?.classList.remove('hidden');
            } else if (period === 'daily') {
                specificDateFilter?.classList.remove('hidden');
            }
        }

        function handleReportTypeChange() {
            const reportType = document.getElementById('report-type')?.value;
            const startupFilter = document.getElementById('startup-filter');

            if (reportType === 'startup-specific') {
                startupFilter?.classList.remove('hidden');
            } else {
                startupFilter?.classList.add('hidden');
            }
        }

        async function loadStartupsForReports() {
            try {
                const { data: startups, error } = await supabaseClient
                    .from('startups')
                    .select('id, name')
                    .eq('status', 'active')
                    .order('name');

                if (error) throw error;

                const startupSelect = document.getElementById('report-startup');
                if (startupSelect) {
                    startupSelect.innerHTML = '<option value="">Select a startup</option>' +
                        (startups || []).map(startup =>
                            `<option value="${startup.id}">${startup.name}</option>`
                        ).join('');
                }
            } catch (error) {
                console.error('Error loading startups for reports:', error);
            }
        }

        function setDefaultReportDates() {
            const today = new Date();
            const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);

            // Set default specific date to today
            const specificDateInput = document.getElementById('report-specific-date');
            if (specificDateInput) {
                specificDateInput.value = today.toISOString().split('T')[0];
            }

            // Set default custom range to last week
            const startDateInput = document.getElementById('report-start-date');
            const endDateInput = document.getElementById('report-end-date');
            if (startDateInput) startDateInput.value = weekAgo.toISOString().split('T')[0];
            if (endDateInput) endDateInput.value = today.toISOString().split('T')[0];
        }

        async function generateReport() {
            const reportLoading = document.getElementById('report-loading');
            const reportResults = document.getElementById('report-results');
            const exportCsvBtn = document.getElementById('export-csv-btn');
            const exportPdfBtn = document.getElementById('export-pdf-btn');

            try {
                // Show loading state
                reportLoading?.classList.remove('hidden');
                reportResults?.classList.add('hidden');

                // Get filter values
                const period = document.getElementById('report-period')?.value;
                const reportType = document.getElementById('report-type')?.value;
                const startupId = document.getElementById('report-startup')?.value;

                // Calculate date range
                const dateRange = calculateDateRange(period);
                if (!dateRange) {
                    throw new Error('Invalid date range');
                }

                // Fetch booking data
                const bookingData = await fetchBookingData(dateRange, reportType, startupId);

                // Process and display report
                currentReportData = processReportData(bookingData, dateRange);
                displayReport(currentReportData, reportType);

                // Enable export buttons
                exportCsvBtn?.removeAttribute('disabled');
                exportPdfBtn?.removeAttribute('disabled');

                // Hide loading, show results
                reportLoading?.classList.add('hidden');
                reportResults?.classList.remove('hidden');

            } catch (error) {
                console.error('Error generating report:', error);
                reportLoading?.classList.add('hidden');
                alert('Failed to generate report: ' + error.message);
            }
        }

        function calculateDateRange(period) {
            const today = new Date();
            let startDate, endDate;

            switch (period) {
                case 'daily':
                    const specificDate = document.getElementById('report-specific-date')?.value;
                    if (!specificDate) return null;
                    startDate = new Date(specificDate);
                    endDate = new Date(specificDate);
                    break;
                case 'weekly':
                    startDate = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
                    endDate = today;
                    break;
                case '15days':
                    startDate = new Date(today.getTime() - 15 * 24 * 60 * 60 * 1000);
                    endDate = today;
                    break;
                case 'monthly':
                    startDate = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
                    endDate = today;
                    break;
                case 'custom':
                    const customStart = document.getElementById('report-start-date')?.value;
                    const customEnd = document.getElementById('report-end-date')?.value;
                    if (!customStart || !customEnd) return null;
                    startDate = new Date(customStart);
                    endDate = new Date(customEnd);
                    break;
                default:
                    return null;
            }

            return {
                start: startDate.toISOString().split('T')[0],
                end: endDate.toISOString().split('T')[0]
            };
        }

        async function fetchBookingData(dateRange, reportType, startupId) {
            let query = supabaseClient
                .from('bookings')
                .select(`
                    *,
                    startups (
                        id,
                        name,
                        contact_person
                    )
                `)
                .gte('booking_date', dateRange.start)
                .lte('booking_date', dateRange.end)
                .order('booking_date', { ascending: false });

            // Add startup filter for startup-specific reports
            if (reportType === 'startup-specific' && startupId) {
                query = query.eq('startup_id', startupId);
            }

            const { data, error } = await query;
            if (error) throw error;

            return data || [];
        }

        function processReportData(bookings, dateRange) {
            const totalBookings = bookings.length;
            const totalHours = bookings.reduce((sum, booking) => sum + (booking.duration || 0), 0);
            const uniqueStartups = new Set(bookings.map(b => b.startup_id)).size;

            // Calculate utilization rate (assuming 8 hours per day per room)
            const daysDiff = Math.ceil((new Date(dateRange.end) - new Date(dateRange.start)) / (1000 * 60 * 60 * 24)) + 1;
            const totalAvailableHours = daysDiff * availableRooms.length * 8; // 8 hours per room per day
            const utilizationRate = totalAvailableHours > 0 ? ((totalHours / totalAvailableHours) * 100).toFixed(1) : 0;

            // Room usage statistics
            const roomUsage = {};
            bookings.forEach(booking => {
                if (!roomUsage[booking.room_name]) {
                    roomUsage[booking.room_name] = { count: 0, hours: 0 };
                }
                roomUsage[booking.room_name].count++;
                roomUsage[booking.room_name].hours += booking.duration || 0;
            });

            // Peak usage times
            const hourlyUsage = {};
            bookings.forEach(booking => {
                const hour = booking.start_time ? booking.start_time.split(':')[0] : '00';
                hourlyUsage[hour] = (hourlyUsage[hour] || 0) + 1;
            });

            // Booking status breakdown
            const statusBreakdown = {};
            bookings.forEach(booking => {
                statusBreakdown[booking.status] = (statusBreakdown[booking.status] || 0) + 1;
            });

            // Daily booking trends
            const dailyTrends = {};
            bookings.forEach(booking => {
                const date = booking.booking_date;
                if (!dailyTrends[date]) {
                    dailyTrends[date] = { count: 0, hours: 0 };
                }
                dailyTrends[date].count++;
                dailyTrends[date].hours += booking.duration || 0;
            });

            return {
                summary: {
                    totalBookings,
                    totalHours,
                    uniqueStartups,
                    utilizationRate
                },
                roomUsage,
                hourlyUsage,
                statusBreakdown,
                dailyTrends,
                bookings,
                dateRange
            };
        }

        function displayReport(reportData, reportType) {
            // Update summary statistics
            document.getElementById('total-bookings-stat').textContent = reportData.summary.totalBookings;
            document.getElementById('total-hours-stat').textContent = reportData.summary.totalHours;
            document.getElementById('unique-startups-stat').textContent = reportData.summary.uniqueStartups;
            document.getElementById('utilization-rate-stat').textContent = reportData.summary.utilizationRate + '%';

            // Render charts
            renderRoomUsageChart(reportData.roomUsage);
            renderBookingTrendsChart(reportData.dailyTrends);

            // Display tables
            displayPopularRoomsTable(reportData.roomUsage);
            displayPeakTimesTable(reportData.hourlyUsage);
            displayDetailedBookingsTable(reportData.bookings);
        }

        function renderRoomUsageChart(roomUsage) {
            const ctx = document.getElementById('room-chart-canvas');
            if (!ctx) return;

            // Destroy existing chart
            if (roomUsageChart) {
                roomUsageChart.destroy();
            }

            const rooms = Object.keys(roomUsage);
            const bookingCounts = rooms.map(room => roomUsage[room].count);
            const colors = [
                '#10B981', '#3B82F6', '#8B5CF6', '#F59E0B', '#EF4444',
                '#06B6D4', '#84CC16', '#F97316', '#EC4899', '#6366F1'
            ];

            roomUsageChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: rooms,
                    datasets: [{
                        data: bookingCounts,
                        backgroundColor: colors.slice(0, rooms.length),
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        }
                    }
                }
            });
        }

        function renderBookingTrendsChart(dailyTrends) {
            const ctx = document.getElementById('trends-chart-canvas');
            if (!ctx) return;

            // Destroy existing chart
            if (bookingTrendsChart) {
                bookingTrendsChart.destroy();
            }

            const dates = Object.keys(dailyTrends).sort();
            const bookingCounts = dates.map(date => dailyTrends[date].count);
            const totalHours = dates.map(date => dailyTrends[date].hours);

            bookingTrendsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates.map(date => new Date(date).toLocaleDateString()),
                    datasets: [
                        {
                            label: 'Number of Bookings',
                            data: bookingCounts,
                            borderColor: '#10B981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.4,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Total Hours',
                            data: totalHours,
                            borderColor: '#3B82F6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Number of Bookings'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Total Hours'
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    }
                }
            });
        }

        function displayPopularRoomsTable(roomUsage) {
            const container = document.getElementById('popular-rooms-table');
            if (!container) return;

            const sortedRooms = Object.entries(roomUsage)
                .sort(([,a], [,b]) => b.count - a.count)
                .slice(0, 10); // Top 10 rooms

            if (sortedRooms.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">No data available</p>';
                return;
            }

            container.innerHTML = `
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Room</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Bookings</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Hours</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        ${sortedRooms.map(([room, data], index) => `
                            <tr class="${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}">
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${room}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${data.count}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${data.hours}h</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function displayPeakTimesTable(hourlyUsage) {
            const container = document.getElementById('peak-times-table');
            if (!container) return;

            const sortedHours = Object.entries(hourlyUsage)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 10); // Top 10 hours

            if (sortedHours.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">No data available</p>';
                return;
            }

            container.innerHTML = `
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Time</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Bookings</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        ${sortedHours.map(([hour, count], index) => {
                            const displayHour = hour === '00' ? '12:00 AM' :
                                              parseInt(hour) < 12 ? `${parseInt(hour)}:00 AM` :
                                              hour === '12' ? '12:00 PM' :
                                              `${parseInt(hour) - 12}:00 PM`;
                            return `
                                <tr class="${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}">
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${displayHour}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${count}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }

        function displayDetailedBookingsTable(bookings) {
            const container = document.getElementById('detailed-bookings-table');
            if (!container) return;

            if (bookings.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">No bookings found for the selected period</p>';
                return;
            }

            container.innerHTML = `
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Room</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Time</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Duration</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Startup</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        ${bookings.map((booking, index) => `
                            <tr class="${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}">
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                    ${new Date(booking.booking_date).toLocaleDateString()}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                    ${booking.room_name}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                    ${booking.start_time}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                    ${booking.duration}h
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                    ${booking.startups?.name || 'Unknown'}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${
                                        booking.status === 'confirmed' ? 'bg-green-100 text-green-800' :
                                        booking.status === 'cancelled' ? 'bg-red-100 text-red-800' :
                                        'bg-yellow-100 text-yellow-800'
                                    }">
                                        ${booking.status}
                                    </span>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function exportToCSV() {
            if (!currentReportData) {
                alert('Please generate a report first');
                return;
            }

            const bookings = currentReportData.bookings;
            const csvContent = [
                ['Date', 'Room', 'Start Time', 'Duration (hours)', 'Startup', 'Contact Person', 'Status'],
                ...bookings.map(booking => [
                    booking.booking_date,
                    booking.room_name,
                    booking.start_time,
                    booking.duration,
                    booking.startups?.name || 'Unknown',
                    booking.startups?.contact_person || '',
                    booking.status
                ])
            ].map(row => row.map(field => `"${field}"`).join(',')).join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `booking-report-${currentReportData.dateRange.start}-to-${currentReportData.dateRange.end}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function exportToPDF() {
            if (!currentReportData) {
                alert('Please generate a report first');
                return;
            }

            // Create a new window with the report content for printing
            const printWindow = window.open('', '_blank');
            const reportContent = generatePDFContent(currentReportData);

            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>NIC Booking Report</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .header { text-align: center; margin-bottom: 30px; }
                        .summary { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 30px; }
                        .summary-item { border: 1px solid #ddd; padding: 15px; border-radius: 5px; }
                        .table { width: 100%; border-collapse: collapse; margin-bottom: 30px; }
                        .table th, .table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        .table th { background-color: #f5f5f5; }
                        @media print { body { margin: 0; } }
                    </style>
                </head>
                <body>
                    ${reportContent}
                </body>
                </html>
            `);

            printWindow.document.close();
            printWindow.focus();

            // Wait for content to load then print
            setTimeout(() => {
                printWindow.print();
                printWindow.close();
            }, 250);
        }

        function generatePDFContent(reportData) {
            const { summary, bookings, dateRange } = reportData;

            return `
                <div class="header">
                    <h1>NIC Booking Management Report</h1>
                    <p>Report Period: ${dateRange.start} to ${dateRange.end}</p>
                    <p>Generated on: ${new Date().toLocaleDateString()}</p>
                </div>

                <div class="summary">
                    <div class="summary-item">
                        <h3>Total Bookings</h3>
                        <p style="font-size: 24px; font-weight: bold;">${summary.totalBookings}</p>
                    </div>
                    <div class="summary-item">
                        <h3>Total Hours</h3>
                        <p style="font-size: 24px; font-weight: bold;">${summary.totalHours}</p>
                    </div>
                    <div class="summary-item">
                        <h3>Active Startups</h3>
                        <p style="font-size: 24px; font-weight: bold;">${summary.uniqueStartups}</p>
                    </div>
                    <div class="summary-item">
                        <h3>Utilization Rate</h3>
                        <p style="font-size: 24px; font-weight: bold;">${summary.utilizationRate}%</p>
                    </div>
                </div>

                <h2>Detailed Booking List</h2>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Room</th>
                            <th>Time</th>
                            <th>Duration</th>
                            <th>Startup</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${bookings.map(booking => `
                            <tr>
                                <td>${new Date(booking.booking_date).toLocaleDateString()}</td>
                                <td>${booking.room_name}</td>
                                <td>${booking.start_time}</td>
                                <td>${booking.duration}h</td>
                                <td>${booking.startups?.name || 'Unknown'}</td>
                                <td>${booking.status}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // ===== ADMIN CREATION SYSTEM =====
        function showCreateAdminForm() {
            const listEl = document.getElementById('admin-contacts-list');
            if (!listEl) return;

            const formHTML = `
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 mb-6">
                    <h4 class="text-lg font-semibold text-blue-900 mb-4">Create New Admin Contact</h4>
                    <form id="create-admin-form" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="admin-name" class="block text-sm font-medium text-gray-700 mb-2">Full Name *</label>
                                <input type="text" id="admin-name" required
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                            <div>
                                <label for="admin-email" class="block text-sm font-medium text-gray-700 mb-2">Email Address *</label>
                                <input type="email" id="admin-email" required
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="admin-phone" class="block text-sm font-medium text-gray-700 mb-2">Phone Number</label>
                                <input type="tel" id="admin-phone"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                            <div>
                                <label for="admin-password" class="block text-sm font-medium text-gray-700 mb-2">Password *</label>
                                <input type="password" id="admin-password" required minlength="6"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                        </div>
                        <div id="admin-form-error" class="hidden text-red-600 text-sm bg-red-50 p-3 rounded-lg"></div>
                        <div id="admin-form-success" class="hidden text-green-600 text-sm bg-green-50 p-3 rounded-lg"></div>
                        <div class="flex space-x-3">
                            <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-700 transition duration-200">
                                Create Admin
                            </button>
                            <button type="button" onclick="hideCreateAdminForm()" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg font-medium hover:bg-gray-400 transition duration-200">
                                Cancel
                            </button>
                        </div>
                    </form>
                </div>
            `;

            listEl.insertAdjacentHTML('afterbegin', formHTML);

            // Add form event listener
            const form = document.getElementById('create-admin-form');
            if (form) {
                form.addEventListener('submit', handleCreateAdmin);
            }
        }

        function hideCreateAdminForm() {
            const form = document.querySelector('#create-admin-form').closest('.bg-blue-50');
            if (form) {
                form.remove();
            }
        }

        async function handleCreateAdmin(e) {
            e.preventDefault();

            const errorEl = document.getElementById('admin-form-error');
            const successEl = document.getElementById('admin-form-success');

            errorEl?.classList.add('hidden');
            successEl?.classList.add('hidden');

            const name = document.getElementById('admin-name')?.value?.trim();
            const email = document.getElementById('admin-email')?.value?.trim();
            const phone = document.getElementById('admin-phone')?.value?.trim();
            const password = document.getElementById('admin-password')?.value;

            if (!name || !email || !password || password.length < 6) {
                errorEl.textContent = 'Please fill all required fields. Password must be at least 6 characters.';
                errorEl?.classList.remove('hidden');
                return;
            }

            try {
                console.log('ðŸ”„ [handleCreateAdmin] Creating new admin account...');
                console.log('ðŸ“ [handleCreateAdmin] Email:', email);
                console.log('ðŸ“ [handleCreateAdmin] Name:', name);

                // ISSUE 1 FIX: Use regular signup instead of admin API
                // First, sign up the new user
                const { data: authData, error: authError } = await supabaseClient.auth.signUp({
                    email,
                    password,
                    options: {
                        data: {
                            name,
                            phone,
                            role: 'admin'
                        }
                    }
                });

                if (authError) {
                    console.error('âŒ [handleCreateAdmin] Auth error:', authError);
                    throw authError;
                }

                console.log('âœ… [handleCreateAdmin] Auth user created:', authData.user?.id);

                // Create user profile in users table
                const { data: userData, error: userError } = await supabaseClient
                    .from('users')
                    .insert({
                        id: authData.user.id,
                        email,
                        name,
                        phone,
                        role: 'admin'
                    })
                    .select();

                if (userError) {
                    console.error('âŒ [handleCreateAdmin] User profile error:', userError);
                    console.error('âŒ [handleCreateAdmin] Error details:', {
                        message: userError.message,
                        details: userError.details,
                        hint: userError.hint,
                        code: userError.code
                    });
                    throw new Error('Failed to create user profile: ' + userError.message);
                }

                console.log('âœ… [handleCreateAdmin] User profile created:', userData);

                successEl.textContent = 'Admin contact created successfully! They will receive a confirmation email.';
                successEl?.classList.remove('hidden');

                // Reset form
                document.getElementById('create-admin-form')?.reset();

                // Reload contacts after a delay
                setTimeout(() => {
                    hideCreateAdminForm();
                    loadContactData();
                }, 2000);

            } catch (error) {
                console.error('âŒ [handleCreateAdmin] Error:', error);
                errorEl.textContent = error.message || 'Failed to create admin contact.';
                errorEl?.classList.remove('hidden');
            }
        }

        // ===== SETTINGS DATA LOADING =====
        async function loadSettingsData() {
            console.log('ðŸ”§ Loading Settings Data...');
            try {
                // Update debug information
                updateProfileDebugInfo();

                // Load user profile form
                if (currentUser) {
                    document.getElementById('settings-name').value = currentUser.name || '';
                    document.getElementById('settings-email').value = currentUser.email || '';
                    document.getElementById('settings-phone').value = currentUser.phone || '';
                    document.getElementById('settings-role').value = currentUser.role || '';
                }

                // Update version display
                updateVersionDisplay();

                // Load startup profile content
                await loadStartupProfileSettings();

            } catch (error) {
                console.error('Error loading settings data:', error);
            }
        }

        // Update version display in settings
        function updateVersionDisplay() {
            const versionEl = document.getElementById('current-version-display');
            const timestampEl = document.getElementById('build-timestamp-display');

            if (versionEl) {
                const metaVersion = document.querySelector('meta[name="app-version"]');
                versionEl.textContent = metaVersion ? metaVersion.content : '2.0.0';
            }

            if (timestampEl) {
                const metaTimestamp = document.querySelector('meta[name="build-timestamp"]');
                if (metaTimestamp && metaTimestamp.content !== 'BUILD_TIMESTAMP_PLACEHOLDER') {
                    const timestamp = new Date(metaTimestamp.content);
                    timestampEl.textContent = timestamp.toLocaleString();
                } else {
                    timestampEl.textContent = 'Development Build';
                }
            }
        }

        // Force reload with cache clearing
        window.forceReloadApp = function() {
            console.log('ðŸ”„ [Force Reload] Clearing all caches and reloading...');

            // Clear localStorage
            localStorage.clear();
            console.log('âœ… [Force Reload] localStorage cleared');

            // Clear sessionStorage
            sessionStorage.clear();
            console.log('âœ… [Force Reload] sessionStorage cleared');

            // Clear service workers and caches
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistrations().then(registrations => {
                    registrations.forEach(registration => {
                        registration.unregister();
                        console.log('âœ… [Force Reload] Service worker unregistered');
                    });
                });
            }

            if ('caches' in window) {
                caches.keys().then(cacheNames => {
                    cacheNames.forEach(cacheName => {
                        caches.delete(cacheName);
                        console.log('âœ… [Force Reload] Cache deleted:', cacheName);
                    });
                });
            }

            // Force hard reload (bypass cache)
            setTimeout(() => {
                console.log('ðŸ”„ [Force Reload] Reloading page...');
                window.location.reload(true);
            }, 500);
        };

        function updateProfileDebugInfo() {
            const userDebugEl = document.getElementById('debug-user-profile');
            const startupDebugEl = document.getElementById('debug-startup-profile');

            if (userDebugEl) {
                userDebugEl.innerHTML = currentUser ?
                    `<pre>${JSON.stringify(currentUser, null, 2)}</pre>` :
                    '<span class="text-red-600">No user profile loaded</span>';
            }

            if (startupDebugEl) {
                startupDebugEl.innerHTML = currentStartup ?
                    `<pre>${JSON.stringify(currentStartup, null, 2)}</pre>` :
                    '<span class="text-red-600">No startup profile found</span>';
            }

            // Show/hide create startup button
            const createBtn = document.getElementById('create-startup-profile-btn');
            if (createBtn) {
                if (!currentStartup && currentUser?.role === 'startup') {
                    createBtn.classList.remove('hidden');
                } else {
                    createBtn.classList.add('hidden');
                }
            }
        }

        async function loadStartupProfileSettings() {
            const contentEl = document.getElementById('startup-profile-content');
            if (!contentEl) return;

            if (!currentStartup) {
                contentEl.innerHTML = `
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                        <div class="flex items-center">
                            <svg class="w-5 h-5 text-yellow-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                            </svg>
                            <span class="text-yellow-800 font-medium">No startup profile found</span>
                        </div>
                        <p class="text-yellow-700 mt-2">This is why you're getting "No startup profile found" errors when booking rooms.</p>
                        <p class="text-yellow-700 mt-1">Use the "Create Missing Startup Profile" button below to fix this issue.</p>
                    </div>
                `;
                return;
            }

            contentEl.innerHTML = `
                <form id="startup-profile-form" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="startup-name" class="block text-sm font-medium text-gray-700 mb-2">Startup Name</label>
                            <input type="text" id="startup-name" value="${currentStartup.name || ''}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        </div>
                        <div>
                            <label for="startup-contact-person" class="block text-sm font-medium text-gray-700 mb-2">Contact Person</label>
                            <input type="text" id="startup-contact-person" value="${currentStartup.contact_person || ''}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        </div>
                        <div>
                            <label for="startup-phone" class="block text-sm font-medium text-gray-700 mb-2">Phone</label>
                            <input type="tel" id="startup-phone" value="${currentStartup.phone || ''}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        </div>
                        <div>
                            <label for="startup-email" class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                            <input type="email" id="startup-email" value="${currentStartup.email || ''}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        </div>
                        <div>
                            <label for="startup-status" class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                            <select id="startup-status" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                <option value="active" ${currentStartup.status === 'active' ? 'selected' : ''}>Active</option>
                                <option value="inactive" ${currentStartup.status === 'inactive' ? 'selected' : ''}>Inactive</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Created</label>
                            <input type="text" value="${new Date(currentStartup.created_at).toLocaleDateString()}" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50" readonly>
                        </div>
                    </div>
                    <button type="submit" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700">
                        Update Startup Profile
                    </button>
                </form>
            `;

            // Add form submission handler
            const startupForm = document.getElementById('startup-profile-form');
            startupForm?.addEventListener('submit', handleStartupProfileUpdate);
        }

        async function loadContactData() {
            // Contact Us tab now uses static content (Jawad Ahmad and Ashraf Khan)
            // No dynamic loading needed
            console.log('âœ… Contact Us tab loaded (static content)');
            return;
        }

        // FIX 3: Admin User Management Functions

        // Edit Startup User
        async function editStartupUser(startupId) {
            try {
                console.log(`ðŸ”„ [editStartupUser] Loading startup ${startupId}...`);

                // Fetch startup data
                const { data: startup, error } = await supabaseClient
                    .from('startups')
                    .select('*')
                    .eq('id', startupId)
                    .single();

                if (error) {
                    console.error('âŒ [editStartupUser] Error fetching startup:', error);
                    showMessage('Failed to load startup data: ' + error.message, 'error');
                    return;
                }

                console.log('âœ… [editStartupUser] Startup loaded:', startup);

                // Populate modal fields
                document.getElementById('edit-startup-id').value = startup.id;
                document.getElementById('edit-startup-name').value = startup.name || '';
                document.getElementById('edit-startup-contact').value = startup.contact_person || '';
                document.getElementById('edit-startup-email').value = startup.email || '';
                document.getElementById('edit-startup-phone').value = startup.phone || '';

                // Show modal
                document.getElementById('edit-startup-modal').classList.remove('hidden');

            } catch (err) {
                console.error('âŒ [editStartupUser] Exception:', err);
                showMessage('Failed to load startup data: ' + err.message, 'error');
            }
        }

        // Save Startup User Changes
        async function saveStartupUserChanges(e) {
            e.preventDefault();

            try {
                const startupId = document.getElementById('edit-startup-id').value;
                const name = document.getElementById('edit-startup-name').value;
                const contactPerson = document.getElementById('edit-startup-contact').value;
                const email = document.getElementById('edit-startup-email').value;
                const phone = document.getElementById('edit-startup-phone').value;

                console.log(`ðŸ”„ [saveStartupUserChanges] Updating startup ${startupId}...`);
                console.log(`ðŸ“ [saveStartupUserChanges] Data to update:`, {
                    name,
                    contact_person: contactPerson,
                    email,
                    phone
                });

                // ISSUE 2 FIX: Add .select() to get updated data and verify update
                const { data, error } = await supabaseClient
                    .from('startups')
                    .update({
                        name: name,
                        contact_person: contactPerson,
                        email: email,
                        phone: phone,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', startupId)
                    .select();

                if (error) {
                    console.error('âŒ [saveStartupUserChanges] Database error:', error);
                    console.error('âŒ [saveStartupUserChanges] Error details:', {
                        message: error.message,
                        details: error.details,
                        hint: error.hint,
                        code: error.code
                    });
                    showMessage('Failed to update startup: ' + error.message, 'error');
                    return;
                }

                console.log('âœ… [saveStartupUserChanges] Database response:', data);
                console.log('âœ… [saveStartupUserChanges] Startup updated successfully');
                showMessage('Startup profile updated successfully', 'success');

                // Close modal
                document.getElementById('edit-startup-modal').classList.add('hidden');

                // Reload contact data
                console.log('ðŸ”„ [saveStartupUserChanges] Reloading contact data...');
                await loadContactData();

            } catch (err) {
                console.error('âŒ [saveStartupUserChanges] Exception:', err);
                showMessage('Failed to update startup: ' + err.message, 'error');
            }
        }

        // Delete Startup User
        async function deleteStartupUser(startupId, startupName) {
            try {
                console.log(`ðŸ”„ [deleteStartupUser] Deleting startup ${startupId}...`);

                // Show confirmation dialog
                const confirmed = confirm(
                    `Are you sure you want to delete "${startupName}"?\n\n` +
                    `This will:\n` +
                    `- Delete the startup profile\n` +
                    `- Remove all associated bookings\n` +
                    `- This action cannot be undone\n\n` +
                    `Type the startup name to confirm deletion.`
                );

                if (!confirmed) {
                    console.log('âš ï¸ [deleteStartupUser] User cancelled deletion');
                    return;
                }

                // Additional confirmation - ask user to type startup name
                const typedName = prompt(`Please type "${startupName}" to confirm deletion:`);

                if (typedName !== startupName) {
                    showMessage('Deletion cancelled - name did not match', 'error');
                    console.log('âš ï¸ [deleteStartupUser] Name confirmation failed');
                    return;
                }

                console.log('ðŸ”„ [deleteStartupUser] Deleting from database...');
                console.log('ðŸ”„ [deleteStartupUser] Startup ID:', startupId);

                // ISSUE 2 FIX: Add .select() to verify deletion
                const { data, error } = await supabaseClient
                    .from('startups')
                    .delete()
                    .eq('id', startupId)
                    .select();

                if (error) {
                    console.error('âŒ [deleteStartupUser] Database error:', error);
                    console.error('âŒ [deleteStartupUser] Error details:', {
                        message: error.message,
                        details: error.details,
                        hint: error.hint,
                        code: error.code
                    });
                    showMessage('Failed to delete startup: ' + error.message, 'error');
                    return;
                }

                console.log('âœ… [deleteStartupUser] Database response:', data);
                console.log('âœ… [deleteStartupUser] Startup deleted successfully');
                showMessage(`Startup "${startupName}" deleted successfully`, 'success');

                // Reload contact data
                console.log('ðŸ”„ [deleteStartupUser] Reloading contact data...');
                await loadContactData();

            } catch (err) {
                console.error('âŒ [deleteStartupUser] Exception:', err);
                showMessage('Failed to delete startup: ' + err.message, 'error');
            }
        }

        // Make functions globally accessible
        window.editStartupUser = editStartupUser;
        window.deleteStartupUser = deleteStartupUser;
        console.log('âœ… Startup user management functions loaded');

        // Setup modal event listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Edit Startup Modal
            const editStartupForm = document.getElementById('edit-startup-form');
            const editStartupModalClose = document.getElementById('edit-startup-modal-close');
            const editStartupCancel = document.getElementById('edit-startup-cancel');

            if (editStartupForm) {
                editStartupForm.addEventListener('submit', saveStartupUserChanges);
            }

            if (editStartupModalClose) {
                editStartupModalClose.addEventListener('click', () => {
                    document.getElementById('edit-startup-modal').classList.add('hidden');
                });
            }

            if (editStartupCancel) {
                editStartupCancel.addEventListener('click', () => {
                    document.getElementById('edit-startup-modal').classList.add('hidden');
                });
            }
        });

        // ===== ENHANCED ROOM MANAGEMENT SYSTEM =====

        // Room data from reference file with enhanced features
        // UPDATED: Added Hub room and updated capacities to match database
        const availableRooms = [
            { name: 'Hub', maxDuration: 2, requiresEquipment: false, type: 'focus', capacity: 6, equipment: ['Desk Setup'] },
            { name: 'Hingol', maxDuration: 2, requiresEquipment: false, type: 'focus', capacity: 6, equipment: ['Desk Setup'] },
            { name: 'Telenor Velocity', maxDuration: 2, requiresEquipment: false, type: 'focus', capacity: 4, equipment: ['Video Conference'] },
            { name: 'Sutlej', maxDuration: 2, requiresEquipment: false, type: 'focus', capacity: 6, equipment: ['Desk Setup'] },
            { name: 'Chenab', maxDuration: 2, requiresEquipment: false, type: 'focus', capacity: 6, equipment: ['Desk Setup'] },
            { name: 'Jhelum', maxDuration: 2, requiresEquipment: false, type: 'focus', capacity: 6, equipment: ['Desk Setup'] },
            { name: 'Indus Board', maxDuration: 8, requiresEquipment: false, type: 'board', capacity: 25, equipment: ['Large Screen', 'Video Conference', 'Projector', 'Presentation Setup'] },
            { name: 'Nexus Session Hall', maxDuration: 8, requiresEquipment: false, type: 'session', capacity: 50, equipment: ['Audio System', 'Projector', 'Stage Setup', 'Microphones'] },
            { name: 'Podcast Room', maxDuration: 8, requiresEquipment: true, type: 'podcast', capacity: 4, equipment: ['Recording Equipment', 'Soundproofing', 'Microphones', 'Audio Interface'] }
        ];

        // Enhanced booking limits system
        const checkBookingLimits = (startupId, roomName) => {
            const room = availableRooms.find(r => r.name === roomName);
            if (!room) return { allowed: false, message: 'Invalid room selected.' };

            // For now, we'll implement basic limits - can be enhanced with Supabase data later
            return { allowed: true };
        };

        async function initializeDatabase() {
            try {
                console.log('Initializing database with enhanced room data...');

                // Check if rooms table exists and has data
                const { data: existingRooms, error: roomsError } = await supabaseClient
                    .from('rooms')
                    .select('id')
                    .limit(1);

                // If no rooms exist or table doesn't exist, create sample rooms
                if (roomsError || !existingRooms || existingRooms.length === 0) {
                    console.log('Creating enhanced room data...');

                    // Convert availableRooms to Supabase format
                    const supabaseRooms = availableRooms.map(room => ({
                        name: room.name,
                        capacity: room.capacity,
                        equipment: room.equipment,
                        is_active: true,
                        room_type: room.type,
                        max_duration: room.maxDuration,
                        requires_equipment: room.requiresEquipment
                    }));

                    const { error: insertError } = await supabaseClient
                        .from('rooms')
                        .insert(supabaseRooms);

                    if (insertError) {
                        console.error('Error creating enhanced rooms:', insertError);
                        // If table doesn't exist, we'll use local data
                        console.log('Using local room data as fallback');
                    } else {
                        console.log('Enhanced rooms created successfully');
                    }
                }
            } catch (error) {
                console.error('Error initializing database:', error);
                console.log('Using local room data as fallback');
            }
        }

        // ===== ROOM DISPLAYS & TABLET VIEW =====
        async function loadRoomDisplaysData() {
            try {
                const { data: rooms, error } = await supabaseClient
                    .from('rooms')
                    .select('*')
                    .eq('is_active', true)
                    .order('name');

                if (error) throw error;

                const roomGrid = document.getElementById('room-grid');
                if (!roomGrid) return;

                roomGrid.innerHTML = rooms.map(room => `
                    <div class="stat-card bg-white p-6 rounded-xl shadow-lg hover:shadow-2xl transition-shadow duration-300 flex flex-col items-center justify-center">
                        <h3 class="text-2xl font-bold text-gray-800 mb-4 text-center">${room.name}</h3>
                        <button data-room-id="${room.id}" data-room-name="${room.name}" class="view-display-btn w-full py-2 px-4 rounded-lg font-semibold btn-primary">
                            View Display
                        </button>
                    </div>
                `).join('');

                // Add event listeners for view display buttons
                roomGrid.addEventListener('click', (e) => {
                    if (e.target.classList.contains('view-display-btn')) {
                        const roomName = e.target.dataset.roomName;
                        openTabletView(roomName);
                    }
                });

            } catch (err) {
                console.error('loadRoomDisplaysData error', err);
            }
        }

        const openTabletView = (roomName) => {
            const tabletViewContainer = document.getElementById('tablet-view-container');
            tabletViewContainer.innerHTML = '';
            tabletViewContainer.classList.remove('hidden');
            tabletViewContainer.classList.add('flex');

            const now = new Date();
            const todayStr = getTodayDateString();
            const currentTimeInMinutes = now.getHours() * 60 + now.getMinutes();

            // Find current booking for this room
            const currentBooking = allBookings.find(b => {
                if (b.room_name !== roomName || b.date !== todayStr) return false;
                const startTime = new Date(`${b.date}T${b.start_time}`);
                const endTime = new Date(`${b.date}T${b.end_time}`);
                return now >= startTime && now < endTime;
            });

            let statusClass, statusIcon, statusText, detailsHtml;

            if (currentBooking) {
                statusClass = 'bg-red-600';
                statusIcon = '<svg class="w-24 h-24 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>';
                statusText = 'OCCUPIED';
                detailsHtml = `
                    <p class="text-4xl mt-4 text-white/90">Currently booked by:</p>
                    <p class="text-5xl font-bold text-white mt-2">${currentBooking.startup_name || 'Unknown'}</p>
                    <p class="text-3xl mt-4 text-white/70">Until ${currentBooking.end_time}</p>
                `;
            } else {
                statusClass = 'bg-green-600';
                statusIcon = '<svg class="w-24 h-24 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>';
                statusText = 'AVAILABLE';

                // Find next booking
                const nextBooking = allBookings
                    .filter(b => b.room_name === roomName && b.date === todayStr)
                    .find(b => {
                        const startTime = new Date(`${b.date}T${b.start_time}`);
                        return startTime > now;
                    });

                detailsHtml = nextBooking
                    ? `<p class="text-3xl mt-4 text-white/70">Next booking: ${nextBooking.start_time} - ${nextBooking.startup_name}</p>`
                    : '<p class="text-3xl mt-2 text-white/70">No further bookings today</p>';
            }

            tabletViewContainer.innerHTML = `
                <div class="content-wrapper relative w-full h-full flex flex-col justify-center items-center p-8 text-center ${statusClass} rounded-2xl shadow-2xl">
                    <div class="absolute top-8 left-8 text-left">
                        <h1 class="text-6xl font-bold text-white" style="text-shadow: 2px 2px 8px rgba(0,0,0,0.3);">${roomName}</h1>
                    </div>

                    <div class="flex items-center justify-center gap-x-6 mb-4">
                        ${statusIcon}
                        <h2 class="text-9xl font-extrabold text-white" style="text-shadow: 3px 3px 10px rgba(0,0,0,0.3);">${statusText}</h2>
                    </div>
                    ${detailsHtml}

                    <div id="tablet-clock" class="absolute bottom-8 right-8 text-6xl font-bold text-white" style="text-shadow: 2px 2px 8px rgba(0,0,0,0.3);"></div>
                    <button id="exit-kiosk-btn" class="absolute bottom-8 left-8 bg-black/20 hover:bg-black/40 text-white font-semibold py-2 px-4 rounded-full text-sm transition-colors">
                        Exit Display
                    </button>
                </div>
            `;

            // Update clock
            const clockInterval = setInterval(() => {
                const clockEl = document.getElementById('tablet-clock');
                if (clockEl) {
                    clockEl.textContent = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
                } else {
                    clearInterval(clockInterval);
                }
            }, 1000);

            // Exit button handler
            document.getElementById('exit-kiosk-btn').addEventListener('click', () => {
                tabletViewContainer.classList.add('hidden');
                tabletViewContainer.classList.remove('flex');
                tabletViewContainer.innerHTML = '';
                clearInterval(clockInterval);
            });
        };


        // ===== INITIALIZE APPLICATION =====
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('DOM loaded, initializing app...');

            // Initialize database with sample data if needed
            await initializeDatabase();

            // SECURITY: Uncomment the next line to force fresh login every time (clears all sessions)
            // await supabaseClient.auth.signOut();

            // Check if sidebar exists
            const sidebar = document.getElementById('sidebar');
            console.log('Sidebar element:', sidebar);

            // Set up navigation
            showPage(window.location.hash || '#dashboard');

            // Initialize authentication
            handleAuthState();
        });

        // ===== ROOM DISPLAYS MANAGEMENT =====

        // Room Displays Tab Management
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('room-display-tab-btn')) {
                const tab = e.target.dataset.tab;

                // Update tab buttons
                document.querySelectorAll('.room-display-tab-btn').forEach(btn => {
                    btn.classList.remove('border-green-500', 'text-green-600');
                    btn.classList.add('border-transparent', 'text-gray-500');
                });

                e.target.classList.remove('border-transparent', 'text-gray-500');
                e.target.classList.add('border-green-500', 'text-green-600');

                // Show/hide tab content
                document.querySelectorAll('.room-display-tab-content').forEach(content => {
                    content.classList.add('hidden');
                });

                const tabContent = document.getElementById(`${tab}-tab`);
                if (tabContent) {
                    tabContent.classList.remove('hidden');
                }

                // Load tab-specific content
                if (tab === 'room-status') {
                    loadRoomStatusDisplays();
                } else if (tab === 'content-library') {
                    loadContentLibrary();
                } else if (tab === 'display-settings') {
                    loadDisplaySettings();
                } else if (tab === 'content-schedule') {
                    loadContentSchedule();
                }
            }
        });

        // Upload Content Modal
        const uploadContentBtn = document.getElementById('upload-content-btn');
        const uploadContentModal = document.getElementById('upload-content-modal');
        const uploadModalClose = document.getElementById('upload-modal-close');
        const uploadCancelBtn = document.getElementById('upload-cancel-btn');
        const uploadContentForm = document.getElementById('upload-content-form');
        const uploadContentType = document.getElementById('upload-content-type');
        const fileUploadSection = document.getElementById('file-upload-section');
        const textContentSection = document.getElementById('text-content-section');
        const uploadDropZone = document.getElementById('upload-drop-zone');
        const uploadFileInput = document.getElementById('upload-file-input');

        uploadContentBtn?.addEventListener('click', () => {
            uploadContentModal.classList.remove('hidden');
        });

        [uploadModalClose, uploadCancelBtn].forEach(btn => {
            btn?.addEventListener('click', () => {
                uploadContentModal.classList.add('hidden');
                uploadContentForm.reset();
                hideUploadSections();
            });
        });

        uploadContentType?.addEventListener('change', (e) => {
            const type = e.target.value;
            hideUploadSections();

            if (type === 'image' || type === 'video') {
                fileUploadSection.classList.remove('hidden');
                updateFileInputAccept(type);
            } else if (type === 'text' || type === 'announcement') {
                textContentSection.classList.remove('hidden');
            }
        });

        function hideUploadSections() {
            fileUploadSection.classList.add('hidden');
            textContentSection.classList.add('hidden');
            document.getElementById('upload-preview').classList.add('hidden');
        }

        function updateFileInputAccept(type) {
            if (type === 'image') {
                uploadFileInput.accept = 'image/*';
            } else if (type === 'video') {
                uploadFileInput.accept = 'video/*';
            }
        }

        // File upload handling
        uploadDropZone?.addEventListener('click', () => {
            uploadFileInput.click();
        });

        uploadDropZone?.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadDropZone.classList.add('border-blue-400', 'bg-blue-50');
        });

        uploadDropZone?.addEventListener('dragleave', () => {
            uploadDropZone.classList.remove('border-blue-400', 'bg-blue-50');
        });

        uploadDropZone?.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadDropZone.classList.remove('border-blue-400', 'bg-blue-50');

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileSelection(files[0]);
            }
        });

        uploadFileInput?.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFileSelection(e.target.files[0]);
            }
        });

        function handleFileSelection(file) {
            const preview = document.getElementById('upload-preview');
            const fileName = document.getElementById('upload-file-name');

            fileName.textContent = file.name;
            preview.classList.remove('hidden');

            // Store file for upload
            uploadFileInput.files = createFileList(file);
        }

        function createFileList(file) {
            const dt = new DataTransfer();
            dt.items.add(file);
            return dt.files;
        }

        document.getElementById('upload-remove-file')?.addEventListener('click', () => {
            document.getElementById('upload-preview').classList.add('hidden');
            uploadFileInput.value = '';
        });

        // Upload form submission
        uploadContentForm?.addEventListener('submit', async (e) => {
            e.preventDefault();
            await handleContentUpload();
        });

        async function handleContentUpload() {
            const submitBtn = document.getElementById('upload-submit-btn');
            const btnText = document.getElementById('upload-btn-text');
            const spinner = document.getElementById('upload-spinner');

            try {
                // Show loading state
                submitBtn.disabled = true;
                btnText.textContent = 'Uploading...';
                spinner.classList.remove('hidden');

                const formData = new FormData(uploadContentForm);
                const contentType = document.getElementById('upload-content-type').value;
                const contentName = document.getElementById('upload-content-name').value;
                const description = document.getElementById('upload-content-description').value;

                let fileUrl = null;
                let textContent = null;

                if (contentType === 'image' || contentType === 'video') {
                    const file = uploadFileInput.files[0];
                    if (file) {
                        fileUrl = await uploadFileToSupabase(file, contentType);
                    }
                } else if (contentType === 'text' || contentType === 'announcement') {
                    textContent = document.getElementById('upload-text-content').value;
                }

                // Save content to database
                const { error } = await supabaseClient.from('display_content').insert({
                    name: contentName,
                    description: description,
                    content_type: contentType,
                    file_url: fileUrl,
                    text_content: textContent,
                    file_size: uploadFileInput.files[0]?.size || null,
                    mime_type: uploadFileInput.files[0]?.type || null,
                    created_by: (await supabaseClient.auth.getUser()).data.user?.id
                });

                if (error) throw error;

                showNotification('Content uploaded successfully!', 'success');
                uploadContentModal.classList.add('hidden');
                uploadContentForm.reset();
                hideUploadSections();

                // Refresh content library if visible
                if (!document.getElementById('content-library-tab').classList.contains('hidden')) {
                    loadContentLibrary();
                }

            } catch (error) {
                console.error('Upload error:', error);
                showNotification('Failed to upload content: ' + error.message, 'error');
            } finally {
                // Reset loading state
                submitBtn.disabled = false;
                btnText.textContent = 'Upload Content';
                spinner.classList.add('hidden');
            }
        }

        async function uploadFileToSupabase(file, contentType) {
            console.log('ðŸ“¤ [uploadFileToSupabase] Starting upload...');
            console.log('   File name:', file.name);
            console.log('   File size:', (file.size / 1024 / 1024).toFixed(2), 'MB');
            console.log('   File type:', file.type);
            console.log('   Content type:', contentType);

            const fileExt = file.name.split('.').pop();
            const fileName = `${Date.now()}-${Math.random().toString(36).substring(2)}.${fileExt}`;
            const filePath = `${contentType}s/${fileName}`;

            console.log('ðŸ“¤ [uploadFileToSupabase] Bucket: room-displays');
            console.log('ðŸ“¤ [uploadFileToSupabase] Path:', filePath);

            const { data, error } = await supabaseClient.storage
                .from('room-displays')
                .upload(filePath, file, {
                    cacheControl: '3600',
                    upsert: false
                });

            if (error) {
                console.error('âŒ [uploadFileToSupabase] Upload failed:', error);
                throw error;
            }

            console.log('âœ… [uploadFileToSupabase] Upload successful:', data);

            const { data: urlData } = supabaseClient.storage
                .from('room-displays')
                .getPublicUrl(filePath);

            console.log('âœ… [uploadFileToSupabase] Public URL:', urlData.publicUrl);

            return urlData.publicUrl;
        }

        // Load Room Status Displays
        async function loadRoomStatusDisplays() {
            const grid = document.getElementById('room-status-grid');

            try {
                console.log('ðŸ”„ [loadRoomStatusDisplays] Loading room displays from database...');
                grid.innerHTML = '<div class="text-center text-gray-500 py-8 col-span-full">Loading room displays...</div>';

                // ENHANCED LOGGING: Fetch all rooms from database to verify Hub room exists
                console.log('ðŸ” [loadRoomStatusDisplays] Fetching all active rooms from database...');
                const { data: allRooms, error: allRoomsError } = await supabaseClient
                    .from('rooms')
                    .select('id, name, capacity, room_type, status, is_active')
                    .eq('is_active', true)
                    .order('name');

                if (!allRoomsError && allRooms) {
                    console.log(`ðŸ“Š [loadRoomStatusDisplays] Total active rooms in database: ${allRooms.length}`);
                    allRooms.forEach((room, index) => {
                        console.log(`   ${index + 1}. ${room.name} (capacity: ${room.capacity}, type: ${room.room_type}, status: ${room.status})`);
                    });
                } else {
                    console.error('âŒ [loadRoomStatusDisplays] Error fetching all rooms:', allRoomsError);
                }

                const { data: roomDisplays, error } = await supabaseClient
                    .from('room_displays')
                    .select(`
                        *,
                        rooms (
                            id,
                            name,
                            capacity,
                            room_type,
                            requires_equipment,
                            status
                        )
                    `)
                    .eq('is_enabled', true)
                    .order('rooms(name)');

                if (error) {
                    console.error('âŒ [loadRoomStatusDisplays] Database error:', error);
                    throw error;
                }

                console.log(`âœ… [loadRoomStatusDisplays] Fetched ${roomDisplays.length} room displays from room_displays table`);

                // Log each room display
                roomDisplays.forEach((display, index) => {
                    console.log(`   ${index + 1}. ${display.rooms.name}: capacity = ${display.rooms.capacity}, type = ${display.rooms.room_type}`);
                });

                if (roomDisplays.length === 0) {
                    console.warn('âš ï¸ [loadRoomStatusDisplays] No room displays found in room_displays table');
                    grid.innerHTML = '<div class="text-center text-gray-500 py-8 col-span-full">No room displays found. Please create room display entries.</div>';
                    return;
                }

                grid.innerHTML = roomDisplays.map(display => createRoomDisplayCard(display)).join('');
                console.log(`âœ… [loadRoomStatusDisplays] Rendered ${roomDisplays.length} room display cards in 3x3 grid layout`);

            } catch (error) {
                console.error('âŒ [loadRoomStatusDisplays] Error:', error);
                grid.innerHTML = '<div class="text-center text-red-500 py-8 col-span-full">Error loading room displays</div>';
            }
        }

        function createRoomDisplayCard(display) {
            const room = display.rooms;

            // ISSUE 1 FIX: Use capacity directly from database (NOT from availableRooms array)
            const displayCapacity = room.capacity;
            console.log(`ðŸ“Š [createRoomDisplayCard] ${room.name}: Using capacity ${displayCapacity} from database`);

            // Use room status from database (real-time status)
            const currentStatus = room.status || display.current_status || 'available';

            const statusColors = {
                available: 'bg-green-100 text-green-800 border-green-200',
                occupied: 'bg-red-100 text-red-800 border-red-200',
                maintenance: 'bg-yellow-100 text-yellow-800 border-yellow-200',
                reserved: 'bg-blue-100 text-blue-800 border-blue-200'
            };

            const statusColor = statusColors[currentStatus] || statusColors.available;

            return `
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 hover:shadow-md transition duration-200 cursor-pointer room-display-card"
                     onclick="openRoomPreview('${room.name}', '${display.id}')"
                     data-room-name="${room.name}"
                     data-room-id="${room.id}"
                     data-display-id="${display.id}">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900">${room.name}</h3>
                            <p class="text-sm text-gray-600">Capacity: ${displayCapacity} people</p>
                            <p class="text-sm text-gray-600">Type: ${room.room_type}</p>
                        </div>
                        <span class="px-3 py-1 rounded-full text-xs font-medium border ${statusColor}">
                            ${currentStatus.charAt(0).toUpperCase() + currentStatus.slice(1)}
                        </span>
                    </div>

                    ${currentUser?.role === 'admin' ? `
                        <div class="mb-4 p-3 bg-gray-50 rounded-lg" onclick="event.stopPropagation();">
                            <label class="block text-xs font-medium text-gray-700 mb-2">Change Room Status:</label>
                            <select
                                class="w-full text-sm border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500 focus:border-green-500"
                                onchange="updateRoomStatus('${room.id}', this.value)"
                                data-room-id="${room.id}">
                                <option value="available" ${currentStatus === 'available' ? 'selected' : ''}>Available</option>
                                <option value="occupied" ${currentStatus === 'occupied' ? 'selected' : ''}>Occupied</option>
                                <option value="maintenance" ${currentStatus === 'maintenance' ? 'selected' : ''}>Maintenance</option>
                                <option value="reserved" ${currentStatus === 'reserved' ? 'selected' : ''}>Reserved</option>
                            </select>
                        </div>
                    ` : ''}

                    ${display.status_message ? `
                        <div class="mb-4 p-3 bg-gray-50 rounded-lg">
                            <p class="text-sm text-gray-700">${display.status_message}</p>
                        </div>
                    ` : ''}

                    <div class="flex justify-between items-center text-sm text-gray-500">
                        <span>Last updated: ${new Date(display.last_updated).toLocaleString()}</span>
                        <div class="flex space-x-2">
                            <span class="text-blue-600 font-medium">Click to preview</span>
                            ${currentUser?.role === 'admin' ? `
                                <button onclick="event.stopPropagation(); openDisplaySettings('${display.id}')" class="text-green-600 hover:text-green-800 font-medium">
                                    Configure
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        // ISSUE 1 FIX: Configure Display Settings
        window.openDisplaySettings = async function(displayId) {
            console.log('ðŸ”§ [openDisplaySettings] Opening configuration for display:', displayId);

            try {
                // Fetch current display settings
                const { data: display, error } = await supabaseClient
                    .from('room_displays')
                    .select(`
                        *,
                        rooms (name)
                    `)
                    .eq('id', displayId)
                    .single();

                if (error) throw error;

                console.log('âœ… [openDisplaySettings] Loaded display data:', display);
                console.log('   Display Name:', display.display_name);
                console.log('   Room Name:', display.rooms.name);
                console.log('   Current Status:', display.current_status);
                console.log('   Is Enabled:', display.is_enabled);

                // Populate form
                document.getElementById('configure-display-id').value = displayId;
                document.getElementById('configure-display-name').value = display.display_name || '';
                document.getElementById('configure-status-message').value = display.status_message || '';
                document.getElementById('configure-current-status').value = display.current_status || 'available';
                document.getElementById('configure-is-enabled').checked = display.is_enabled;

                // Show modal
                document.getElementById('configure-display-modal').classList.remove('hidden');

            } catch (error) {
                console.error('âŒ [openDisplaySettings] Error:', error);
                showNotification('Failed to load display settings: ' + error.message, 'error');
            }
        };

        async function saveDisplaySettings(e) {
            e.preventDefault();

            const displayId = document.getElementById('configure-display-id').value;
            const displayName = document.getElementById('configure-display-name').value;
            const statusMessage = document.getElementById('configure-status-message').value;
            const currentStatus = document.getElementById('configure-current-status').value;
            const isEnabled = document.getElementById('configure-is-enabled').checked;

            console.log('ðŸ’¾ [saveDisplaySettings] Saving configuration for display:', displayId);
            console.log('   Display Name:', displayName);
            console.log('   Status Message:', statusMessage);
            console.log('   Current Status:', currentStatus);
            console.log('   Is Enabled:', isEnabled);

            try {
                const { error } = await supabaseClient
                    .from('room_displays')
                    .update({
                        display_name: displayName,
                        status_message: statusMessage,
                        current_status: currentStatus,
                        is_enabled: isEnabled,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', displayId);

                if (error) throw error;

                console.log('âœ… [saveDisplaySettings] Settings saved successfully');
                showNotification('Display settings updated successfully!', 'success');

                // Close modal
                document.getElementById('configure-display-modal').classList.add('hidden');

                // Refresh room displays
                console.log('ðŸ”„ [saveDisplaySettings] Refreshing room displays...');
                await loadRoomStatusDisplays();

            } catch (error) {
                console.error('âŒ [saveDisplaySettings] Error:', error);
                showNotification('Failed to save settings: ' + error.message, 'error');
            }
        }

        // Add event listeners for configure modal
        document.getElementById('configure-modal-close')?.addEventListener('click', () => {
            console.log('ðŸ”§ [Configure Modal] Closing modal (X button)');
            document.getElementById('configure-display-modal').classList.add('hidden');
        });

        document.getElementById('configure-cancel-btn')?.addEventListener('click', () => {
            console.log('ðŸ”§ [Configure Modal] Closing modal (Cancel button)');
            document.getElementById('configure-display-modal').classList.add('hidden');
        });

        document.getElementById('configure-display-form')?.addEventListener('submit', saveDisplaySettings);

        // Update Room Status (ISSUE 3 FIX: Room Status Management)
        async function updateRoomStatus(roomId, newStatus) {
            try {
                console.log(`ðŸ”„ [updateRoomStatus] Starting update for room ${roomId} to status: ${newStatus}`);
                console.log(`ðŸ”„ [updateRoomStatus] Room ID type: ${typeof roomId}, value: ${roomId}`);

                // ISSUE 3 FIX: Enhanced logging and error handling
                // Update room status in database
                const { data, error } = await supabaseClient
                    .from('rooms')
                    .update({
                        status: newStatus,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', roomId)
                    .select();

                if (error) {
                    console.error('âŒ [updateRoomStatus] Database error:', error);
                    console.error('âŒ [updateRoomStatus] Error details:', {
                        message: error.message,
                        details: error.details,
                        hint: error.hint,
                        code: error.code
                    });
                    showMessage(`Failed to update room status: ${error.message}`, 'error');
                    return false;
                }

                if (!data || data.length === 0) {
                    console.warn('âš ï¸ [updateRoomStatus] No rows updated - room may not exist or RLS policy blocking');
                    showMessage('Room status update failed - no rows affected', 'error');
                    return false;
                }

                console.log('âœ… [updateRoomStatus] Database updated successfully:', data);
                console.log('âœ… [updateRoomStatus] Updated room:', data[0]);
                showMessage(`Room status updated to ${newStatus}`, 'success');

                // Reload room displays to show updated status
                console.log('ðŸ”„ [updateRoomStatus] Reloading room displays...');
                await loadRoomStatusDisplays();

                console.log('âœ… [updateRoomStatus] Complete!');
                return true;

            } catch (err) {
                console.error('âŒ [updateRoomStatus] Exception:', err);
                showMessage('Failed to update room status: ' + err.message, 'error');
                return false;
            }
        }

        // Make updateRoomStatus globally accessible for inline onclick handlers
        window.updateRoomStatus = updateRoomStatus;
        console.log('âœ… window.updateRoomStatus is now available:', typeof window.updateRoomStatus);

        // ISSUE 2: Real-Time Room Status Sync with Bookings
        // ENHANCED: Now updates both rooms and room_displays tables
        async function syncRoomStatusWithBookings() {
            try {
                console.log('ðŸ”„ [syncRoomStatusWithBookings] ========== STARTING SYNC ==========');

                const now = new Date();
                const today = now.toISOString().split('T')[0];
                const currentTime = now.toTimeString().slice(0, 5); // HH:MM format
                const currentDateTime = now.toLocaleString();

                console.log(`ðŸ“… [syncRoomStatusWithBookings] Current date: ${today}`);
                console.log(`â° [syncRoomStatusWithBookings] Current time: ${currentTime} (${currentDateTime})`);

                // Get all rooms
                const { data: rooms, error: roomsError } = await supabaseClient
                    .from('rooms')
                    .select('id, name, status');

                if (roomsError) {
                    console.error('âŒ [syncRoomStatusWithBookings] Error fetching rooms:', roomsError);
                    return;
                }

                console.log(`ðŸ“Š [syncRoomStatusWithBookings] Found ${rooms.length} rooms to check`);

                // Get all bookings for today (confirmed only)
                const { data: bookings, error: bookingsError } = await supabaseClient
                    .from('bookings')
                    .select('*')
                    .eq('booking_date', today)
                    .eq('status', 'confirmed');

                if (bookingsError) {
                    console.error('âŒ [syncRoomStatusWithBookings] Error fetching bookings:', bookingsError);
                    return;
                }

                console.log(`ðŸ“Š [syncRoomStatusWithBookings] Found ${bookings?.length || 0} confirmed bookings for today`);

                // Log all bookings for debugging
                if (bookings && bookings.length > 0) {
                    console.log('ðŸ“‹ [syncRoomStatusWithBookings] Today\'s bookings:');
                    bookings.forEach((b, idx) => {
                        console.log(`   ${idx + 1}. ${b.room_name}: ${b.start_time} - ${b.end_time} (${b.duration}h)`);
                    });
                }

                let statusChanges = 0;

                // Process each room
                for (const room of rooms) {
                    console.log(`\nðŸ” [syncRoomStatusWithBookings] Checking room: ${room.name} (current status: ${room.status})`);

                    // Skip if room is manually set to maintenance (admin override)
                    if (room.status === 'maintenance') {
                        console.log(`   âš ï¸ Room is in MAINTENANCE - skipping auto-sync (admin override)`);
                        continue;
                    }

                    // Find bookings for this room
                    const roomBookings = bookings?.filter(b => b.room_name === room.name) || [];
                    console.log(`   ðŸ“‹ Found ${roomBookings.length} booking(s) for this room`);

                    let newStatus = 'available';
                    let hasActiveBooking = false;
                    let hasUpcomingBooking = false;
                    let activeBookingDetails = null;

                    for (const booking of roomBookings) {
                        const startTime = booking.start_time;
                        const endTime = booking.end_time;

                        console.log(`   â° Checking booking: ${startTime} - ${endTime}`);
                        console.log(`      Current time: ${currentTime}`);
                        console.log(`      Is active? ${currentTime >= startTime && currentTime < endTime}`);

                        // Check if booking is currently active
                        if (currentTime >= startTime && currentTime < endTime) {
                            newStatus = 'occupied';
                            hasActiveBooking = true;
                            activeBookingDetails = booking;
                            console.log(`   âœ… ACTIVE BOOKING FOUND! Room is OCCUPIED`);
                            console.log(`      Booking: ${startTime} - ${endTime} (${booking.duration}h)`);
                            console.log(`      Startup: ${booking.startup_id || 'N/A'}`);
                            break;
                        }
                        // Check if booking is upcoming (later today)
                        else if (currentTime < startTime) {
                            hasUpcomingBooking = true;
                            console.log(`   ðŸ“… Upcoming booking found: ${startTime}`);
                        }
                    }

                    // If no active booking but has upcoming booking, mark as reserved
                    if (!hasActiveBooking && hasUpcomingBooking) {
                        newStatus = 'reserved';
                        console.log(`   ðŸ“… Room is RESERVED (has upcoming booking)`);
                    } else if (!hasActiveBooking && !hasUpcomingBooking) {
                        console.log(`   âœ… Room is AVAILABLE (no bookings)`);
                    }

                    // Update room status if it changed
                    if (room.status !== newStatus) {
                        console.log(`   ðŸ”„ STATUS CHANGE DETECTED: ${room.status} â†’ ${newStatus}`);
                        statusChanges++;

                        // Update rooms table
                        const { error: updateError } = await supabaseClient
                            .from('rooms')
                            .update({
                                status: newStatus,
                                updated_at: new Date().toISOString()
                            })
                            .eq('id', room.id);

                        if (updateError) {
                            console.error(`   âŒ Error updating rooms table:`, updateError);
                        } else {
                            console.log(`   âœ… Rooms table updated successfully`);
                        }

                        // ENHANCEMENT: Also update room_displays table
                        const { error: displayUpdateError } = await supabaseClient
                            .from('room_displays')
                            .update({
                                current_status: newStatus,
                                last_updated: new Date().toISOString()
                            })
                            .eq('room_id', room.id);

                        if (displayUpdateError) {
                            console.error(`   âŒ Error updating room_displays table:`, displayUpdateError);
                        } else {
                            console.log(`   âœ… Room_displays table updated successfully`);
                        }
                    } else {
                        console.log(`   â„¹ï¸ No status change needed (already ${newStatus})`);
                    }
                }

                console.log(`\nâœ… [syncRoomStatusWithBookings] ========== SYNC COMPLETE ==========`);
                console.log(`ðŸ“Š Total status changes: ${statusChanges}`);
                console.log(`â° Next sync in 60 seconds\n`);

            } catch (err) {
                console.error('âŒ [syncRoomStatusWithBookings] ========== EXCEPTION ==========');
                console.error('âŒ Error:', err);
                console.error('âŒ Stack:', err.stack);
            }
        }

        // ENHANCEMENT: Run sync on page load and every minute
        console.log('ðŸš€ [INITIALIZATION] Setting up automatic room status synchronization...');
        console.log('â° [INITIALIZATION] Sync interval: 60 seconds (1 minute)');
        console.log('ðŸ“Š [INITIALIZATION] Will check booking times against current time');
        console.log('ðŸ”„ [INITIALIZATION] Will auto-update: Available â†” Occupied â†” Reserved');
        console.log('âš ï¸ [INITIALIZATION] Maintenance status is protected (admin override)');

        // Run initial sync immediately
        syncRoomStatusWithBookings();

        // Schedule recurring sync every 60 seconds
        const syncInterval = setInterval(syncRoomStatusWithBookings, 60000);
        console.log('âœ… [INITIALIZATION] Room status sync scheduled successfully!');
        console.log('âœ… [INITIALIZATION] Sync will run every 60 seconds automatically\n');

        // ISSUE 3 FIX: Admin Booking Management - Cancel Booking
        async function cancelCurrentBooking(roomName, bookingDate, startTime) {
            try {
                console.log(`ðŸ”„ [cancelCurrentBooking] Room: ${roomName}, Date: ${bookingDate}, Time: ${startTime}`);

                // Show confirmation dialog
                const confirmed = confirm(
                    `Are you sure you want to cancel this booking?\n\n` +
                    `Room: ${roomName}\n` +
                    `Date: ${bookingDate}\n` +
                    `Time: ${startTime}\n\n` +
                    `This action cannot be undone.`
                );

                if (!confirmed) {
                    console.log('âš ï¸ [cancelCurrentBooking] User cancelled the action');
                    return;
                }

                console.log('ðŸ”„ [cancelCurrentBooking] Deleting booking from database...');

                // ISSUE 3 FIX: Enhanced logging and error handling
                const { data, error } = await supabaseClient
                    .from('bookings')
                    .delete()
                    .eq('room_name', roomName)
                    .eq('booking_date', bookingDate)
                    .eq('start_time', startTime)
                    .select();

                if (error) {
                    console.error('âŒ [cancelCurrentBooking] Database error:', error);
                    console.error('âŒ [cancelCurrentBooking] Error details:', {
                        message: error.message,
                        details: error.details,
                        hint: error.hint,
                        code: error.code
                    });
                    showMessage(`Failed to cancel booking: ${error.message}`, 'error');
                    return;
                }

                if (!data || data.length === 0) {
                    console.warn('âš ï¸ [cancelCurrentBooking] No rows deleted - booking may not exist or RLS policy blocking');
                    showMessage('Booking cancellation failed - no rows affected', 'error');
                    return;
                }

                console.log('âœ… [cancelCurrentBooking] Booking deleted successfully:', data);
                showMessage('Booking cancelled successfully', 'success');

                // Sync room status (will set to available)
                console.log('ðŸ”„ [cancelCurrentBooking] Syncing room status...');
                await syncRoomStatusWithBookings();

                // Reload preview data
                console.log('ðŸ”„ [cancelCurrentBooking] Reloading preview...');
                await loadRoomPreviewData();

                // Reload room displays if visible
                if (!document.getElementById('room-status-tab').classList.contains('hidden')) {
                    await loadRoomStatusDisplays();
                }

                console.log('âœ… [cancelCurrentBooking] Complete!');

            } catch (err) {
                console.error('âŒ [cancelCurrentBooking] Exception:', err);
                showMessage('Failed to cancel booking: ' + err.message, 'error');
            }
        }

        // Make cancelCurrentBooking globally accessible
        window.cancelCurrentBooking = cancelCurrentBooking;
        console.log('âœ… window.cancelCurrentBooking is now available');

        // Load Content Library
        async function loadContentLibrary() {
            const grid = document.getElementById('content-library-grid');
            const filter = document.getElementById('content-type-filter').value;

            try {
                grid.innerHTML = '<div class="text-center text-gray-500 py-8 col-span-full">Loading content library...</div>';

                let query = supabaseClient
                    .from('display_content')
                    .select('*')
                    .eq('is_active', true)
                    .order('created_at', { ascending: false });

                if (filter) {
                    query = query.eq('content_type', filter);
                }

                const { data: content, error } = await query;

                if (error) throw error;

                if (content.length === 0) {
                    grid.innerHTML = '<div class="text-center text-gray-500 py-8 col-span-full">No content found</div>';
                    return;
                }

                grid.innerHTML = content.map(item => createContentCard(item)).join('');

            } catch (error) {
                console.error('Error loading content library:', error);
                grid.innerHTML = '<div class="text-center text-red-500 py-8 col-span-full">Error loading content library</div>';
            }
        }

        function createContentCard(content) {
            const typeIcons = {
                image: 'ðŸ–¼ï¸',
                video: 'ðŸŽ¥',
                text: 'ðŸ“',
                announcement: 'ðŸ“¢'
            };

            return `
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 hover:shadow-md transition duration-200">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center space-x-2">
                            <span class="text-2xl">${typeIcons[content.content_type] || 'ðŸ“„'}</span>
                            <div>
                                <h4 class="font-medium text-gray-900">${content.name}</h4>
                                <p class="text-xs text-gray-500">${content.content_type}</p>
                            </div>
                        </div>
                        <div class="flex space-x-1">
                            <button onclick="scheduleContent('${content.id}')" class="p-1 text-blue-600 hover:text-blue-800" title="Schedule">
                                <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                </svg>
                            </button>
                            <button onclick="deleteContent('${content.id}')" class="p-1 text-red-600 hover:text-red-800" title="Delete">
                                <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                </svg>
                            </button>
                        </div>
                    </div>

                    ${content.description ? `
                        <p class="text-sm text-gray-600 mb-3">${content.description}</p>
                    ` : ''}

                    ${content.file_url ? `
                        <div class="mb-3">
                            ${content.content_type === 'image' ? `
                                <img src="${content.file_url}" alt="${content.name}" class="w-full h-32 object-cover rounded">
                            ` : content.content_type === 'video' ? `
                                <video src="${content.file_url}" class="w-full h-32 object-cover rounded" controls></video>
                            ` : ''}
                        </div>
                    ` : ''}

                    ${content.text_content ? `
                        <div class="mb-3 p-2 bg-gray-50 rounded text-sm">
                            ${content.text_content.substring(0, 100)}${content.text_content.length > 100 ? '...' : ''}
                        </div>
                    ` : ''}

                    <div class="text-xs text-gray-500">
                        Created: ${new Date(content.created_at).toLocaleDateString()}
                        ${content.file_size ? ` â€¢ ${(content.file_size / 1024 / 1024).toFixed(1)} MB` : ''}
                    </div>
                </div>
            `;
        }

        // Load Display Settings
        async function loadDisplaySettings() {
            try {
                // Load rooms for selection
                const { data: rooms, error: roomsError } = await supabaseClient
                    .from('rooms')
                    .select('id, name')
                    .eq('is_active', true)
                    .order('name');

                if (roomsError) throw roomsError;

                const roomSelect = document.getElementById('room-select');
                roomSelect.innerHTML = '<option value="">Choose a room...</option>' +
                    rooms.map(room => `<option value="${room.id}">${room.name}</option>`).join('');

                // Load layouts for selection
                const { data: layouts, error: layoutsError } = await supabaseClient
                    .from('display_layouts')
                    .select('id, name, description')
                    .eq('is_active', true)
                    .order('name');

                if (layoutsError) throw layoutsError;

                const layoutSelect = document.getElementById('layout-select');
                layoutSelect.innerHTML = '<option value="">Choose a layout...</option>' +
                    layouts.map(layout => `<option value="${layout.id}">${layout.name}</option>`).join('');

            } catch (error) {
                console.error('Error loading display settings:', error);
                showNotification('Error loading display settings', 'error');
            }
        }

        // Additional Room Display Functions
        async function loadContentSchedule() {
            const list = document.getElementById('content-schedule-list');

            try {
                list.innerHTML = '<div class="text-center text-gray-500 py-8">Loading content schedules...</div>';

                const { data: schedules, error } = await supabaseClient
                    .from('display_content_schedule')
                    .select(`
                        *,
                        display_content (name, content_type),
                        room_displays (
                            rooms (name)
                        )
                    `)
                    .eq('is_active', true)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                if (schedules.length === 0) {
                    list.innerHTML = '<div class="text-center text-gray-500 py-8">No content schedules found</div>';
                    return;
                }

                list.innerHTML = schedules.map(schedule => createScheduleCard(schedule)).join('');

            } catch (error) {
                console.error('Error loading content schedules:', error);
                list.innerHTML = '<div class="text-center text-red-500 py-8">Error loading content schedules</div>';
            }
        }

        function createScheduleCard(schedule) {
            return `
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-medium text-gray-900">${schedule.display_content.name}</h4>
                            <p class="text-sm text-gray-600">Room: ${schedule.room_displays.rooms.name}</p>
                            <p class="text-sm text-gray-600">
                                ${schedule.start_time} - ${schedule.end_time}
                                (${schedule.duration_seconds}s display)
                            </p>
                            <p class="text-sm text-gray-600">
                                ${schedule.start_date} to ${schedule.end_date}
                            </p>
                            <p class="text-sm text-gray-600">
                                Days: ${schedule.days_of_week.join(', ')}
                            </p>
                        </div>
                        <button onclick="deleteSchedule('${schedule.id}')" class="text-red-600 hover:text-red-800">
                            <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                            </svg>
                        </button>
                    </div>
                </div>
            `;
        }

        // Event Handlers
        window.scheduleContent = function(contentId) {
            document.getElementById('schedule-content-select').value = contentId;
            document.getElementById('schedule-content-modal').classList.remove('hidden');
            loadRoomsForScheduling();
        };

        window.deleteContent = async function(contentId) {
            if (!confirm('Are you sure you want to delete this content?')) return;

            try {
                const { error } = await supabaseClient
                    .from('display_content')
                    .update({ is_active: false })
                    .eq('id', contentId);

                if (error) throw error;

                showNotification('Content deleted successfully', 'success');
                loadContentLibrary();

            } catch (error) {
                console.error('Error deleting content:', error);
                showNotification('Error deleting content', 'error');
            }
        };

        window.deleteSchedule = async function(scheduleId) {
            if (!confirm('Are you sure you want to delete this schedule?')) return;

            try {
                const { error } = await supabaseClient
                    .from('display_content_schedule')
                    .delete()
                    .eq('id', scheduleId);

                if (error) throw error;

                showNotification('Schedule deleted successfully', 'success');
                loadContentSchedule();

            } catch (error) {
                console.error('Error deleting schedule:', error);
                showNotification('Error deleting schedule', 'error');
            }
        };

        async function loadRoomsForScheduling() {
            try {
                const { data: rooms, error } = await supabaseClient
                    .from('rooms')
                    .select('id, name')
                    .eq('is_active', true)
                    .order('name');

                if (error) throw error;

                const container = document.getElementById('schedule-rooms-checkboxes');
                container.innerHTML = rooms.map(room => `
                    <label class="flex items-center">
                        <input type="checkbox" value="${room.id}" class="schedule-room-checkbox mr-2">
                        ${room.name}
                    </label>
                `).join('');

            } catch (error) {
                console.error('Error loading rooms for scheduling:', error);
            }
        }

        // Schedule Content Modal Event Handlers
        document.getElementById('add-schedule-btn')?.addEventListener('click', () => {
            document.getElementById('schedule-content-modal').classList.remove('hidden');
            loadContentForScheduling();
            loadRoomsForScheduling();

            // Set default dates
            const today = new Date().toISOString().split('T')[0];
            const nextMonth = new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
            document.getElementById('schedule-start-date').value = today;
            document.getElementById('schedule-end-date').value = nextMonth;

            // Check weekdays by default
            ['monday', 'tuesday', 'wednesday', 'thursday', 'friday'].forEach(day => {
                const checkbox = document.querySelector(`input[value="${day}"]`);
                if (checkbox) checkbox.checked = true;
            });
        });

        document.getElementById('schedule-modal-close')?.addEventListener('click', () => {
            document.getElementById('schedule-content-modal').classList.add('hidden');
        });

        document.getElementById('schedule-cancel-btn')?.addEventListener('click', () => {
            document.getElementById('schedule-content-modal').classList.add('hidden');
        });

        async function loadContentForScheduling() {
            try {
                const { data: content, error } = await supabaseClient
                    .from('display_content')
                    .select('id, name, content_type')
                    .eq('is_active', true)
                    .order('name');

                if (error) throw error;

                const select = document.getElementById('schedule-content-select');
                select.innerHTML = '<option value="">Choose content...</option>' +
                    content.map(item => `<option value="${item.id}">${item.name} (${item.content_type})</option>`).join('');

            } catch (error) {
                console.error('Error loading content for scheduling:', error);
            }
        }

        // Content Type Filter
        document.getElementById('content-type-filter')?.addEventListener('change', () => {
            loadContentLibrary();
        });

        document.getElementById('refresh-content-btn')?.addEventListener('click', () => {
            loadContentLibrary();
        });

        // Initialize Room Displays when page loads
        function initializeRoomDisplays() {
            if (window.location.hash === '#room-displays') {
                loadRoomStatusDisplays();
            }
        }

        // ===== ROOM DISPLAY PREVIEW SYSTEM =====

        let currentPreviewRoom = null;
        let currentPreviewDisplayId = null;
        let previewUpdateInterval = null;

        // Open Room Preview Modal
        window.openRoomPreview = async function(roomName, displayId) {
            currentPreviewRoom = roomName;
            currentPreviewDisplayId = displayId;

            // Update modal title
            document.getElementById('preview-room-title').textContent = `${roomName} Display Preview`;
            document.getElementById('preview-room-subtitle').textContent = `Live preview of ${roomName} room display`;

            // Show modal
            document.getElementById('room-preview-modal').classList.remove('hidden');

            // Load preview content
            await loadRoomPreviewData();

            // Start auto-refresh for live data
            startPreviewAutoRefresh();
        };

        // Close Room Preview Modal
        document.getElementById('preview-modal-close')?.addEventListener('click', () => {
            closeRoomPreview();
        });

        async function closeRoomPreview() {
            // Check if we're in fullscreen mode
            const isCurrentlyFullscreen = !!(
                document.fullscreenElement ||
                document.webkitFullscreenElement ||
                document.mozFullScreenElement ||
                document.msFullscreenElement
            );

            // If in fullscreen, require password verification first
            if (isCurrentlyFullscreen || isFullscreenLocked) {
                const passwordVerified = await verifyAdminPasswordForExit();

                if (!passwordVerified) {
                    return; // Don't close if password not verified
                }

                // Exit fullscreen first
                isFullscreenLocked = false;
                fullscreenElement = null;

                try {
                    if (document.exitFullscreen) {
                        await document.exitFullscreen();
                    } else if (document.webkitExitFullscreen) {
                        await document.webkitExitFullscreen();
                    } else if (document.mozCancelFullScreen) {
                        await document.mozCancelFullScreen();
                    } else if (document.msExitFullscreen) {
                        await document.msExitFullscreen();
                    }
                } catch (error) {
                    console.error('Error exiting fullscreen:', error);
                }
            } else if (currentUser?.role !== 'admin') {
                // Not in fullscreen, but still require password for non-admin users
                const password = prompt('This display is password protected. Please enter the admin password to exit:');

                if (!password) {
                    return; // User cancelled
                }

                // Verify password by attempting to sign in
                try {
                    const { error } = await supabaseClient.auth.signInWithPassword({
                        email: 'admin@nic.com', // Default admin email - can be customized
                        password: password
                    });

                    if (error) {
                        alert('Incorrect password. Access denied.');
                        return;
                    }
                } catch (err) {
                    alert('Password verification failed. Access denied.');
                    return;
                }
            }

            // Close the preview
            document.getElementById('room-preview-modal').classList.add('hidden');
            stopPreviewAutoRefresh();
            currentPreviewRoom = null;
            currentPreviewDisplayId = null;
        }

        // Load Room Preview Data
        async function loadRoomPreviewData() {
            if (!currentPreviewRoom) return;

            try {
                // Load current booking
                await loadCurrentBooking();

                // Load next booking
                await loadNextBooking();

                // Load room display status
                await loadRoomDisplayStatus();

                // Load available content for preview
                await loadPreviewContent();

                // Render the display preview
                renderDisplayPreview();

            } catch (error) {
                console.error('Error loading room preview data:', error);
                showNotification('Error loading room preview data', 'error');
            }
        }

        // Load Current Booking
        async function loadCurrentBooking() {
            try {
                const { data, error } = await supabaseClient.rpc('get_room_current_booking', {
                    room_name_param: currentPreviewRoom
                });

                if (error) throw error;

                const container = document.getElementById('current-booking-info');

                if (data.has_booking) {
                    const remainingHours = Math.floor(data.remaining_minutes / 60);
                    const remainingMins = Math.floor(data.remaining_minutes % 60);

                    container.innerHTML = `
                        <div class="space-y-3">
                            <div class="flex items-center justify-between">
                                <span class="text-sm font-medium text-gray-700">Status:</span>
                                <span class="px-2 py-1 bg-red-100 text-red-800 rounded-full text-xs font-medium">Occupied</span>
                            </div>
                            <div>
                                <span class="text-sm font-medium text-gray-700">Startup:</span>
                                <p class="text-sm text-gray-900">${data.startup_name}</p>
                            </div>
                            <div>
                                <span class="text-sm font-medium text-gray-700">Contact:</span>
                                <p class="text-sm text-gray-900">${data.contact_person}</p>
                            </div>
                            <div>
                                <span class="text-sm font-medium text-gray-700">Time:</span>
                                <p class="text-sm text-gray-900">${data.start_time} - ${data.end_time}</p>
                            </div>
                            <div>
                                <span class="text-sm font-medium text-gray-700">Remaining:</span>
                                <p class="text-sm text-red-600 font-medium">
                                    ${remainingHours}h ${remainingMins}m
                                </p>
                            </div>
                            ${data.equipment_notes ? `
                                <div>
                                    <span class="text-sm font-medium text-gray-700">Equipment:</span>
                                    <p class="text-sm text-gray-900">${data.equipment_notes}</p>
                                </div>
                            ` : ''}
                            ${currentUser?.role === 'admin' ? `
                                <div class="pt-3 border-t border-gray-200">
                                    <button
                                        onclick="cancelCurrentBooking('${currentPreviewRoom}', '${data.booking_date}', '${data.start_time}')"
                                        class="w-full bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-red-700 transition duration-200 flex items-center justify-center space-x-2">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                        </svg>
                                        <span>Cancel Booking</span>
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    `;
                } else {
                    container.innerHTML = `
                        <div class="text-center py-4">
                            <div class="flex items-center justify-center mb-2">
                                <span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-xs font-medium">Available</span>
                            </div>
                            <p class="text-sm text-gray-500">No current booking</p>
                        </div>
                    `;
                }

                // Store current booking data for display rendering
                window.currentBookingData = data;

            } catch (error) {
                console.error('Error loading current booking:', error);
                document.getElementById('current-booking-info').innerHTML = `
                    <div class="text-center text-red-500 py-4">Error loading booking info</div>
                `;
            }
        }

        // Load Next Booking
        async function loadNextBooking() {
            try {
                const { data, error } = await supabaseClient.rpc('get_room_next_booking', {
                    room_name_param: currentPreviewRoom
                });

                if (error) throw error;

                const container = document.getElementById('next-booking-info');

                if (data.has_next_booking) {
                    const hoursUntil = Math.floor(data.minutes_until_start / 60);
                    const minsUntil = Math.floor(data.minutes_until_start % 60);

                    container.innerHTML = `
                        <div class="space-y-3">
                            <div>
                                <span class="text-sm font-medium text-gray-700">Startup:</span>
                                <p class="text-sm text-gray-900">${data.startup_name}</p>
                            </div>
                            <div>
                                <span class="text-sm font-medium text-gray-700">Contact:</span>
                                <p class="text-sm text-gray-900">${data.contact_person}</p>
                            </div>
                            <div>
                                <span class="text-sm font-medium text-gray-700">Time:</span>
                                <p class="text-sm text-gray-900">${data.start_time} - ${data.end_time}</p>
                            </div>
                            <div>
                                <span class="text-sm font-medium text-gray-700">Starts in:</span>
                                <p class="text-sm text-blue-600 font-medium">
                                    ${hoursUntil}h ${minsUntil}m
                                </p>
                            </div>
                        </div>
                    `;
                } else {
                    container.innerHTML = `
                        <div class="text-center text-gray-500 py-4">
                            <p class="text-sm">No upcoming bookings today</p>
                        </div>
                    `;
                }

                // Store next booking data for display rendering
                window.nextBookingData = data;

            } catch (error) {
                console.error('Error loading next booking:', error);
                document.getElementById('next-booking-info').innerHTML = `
                    <div class="text-center text-red-500 py-4">Error loading next booking</div>
                `;
            }
        }

        // Helper function to get updated room capacity from availableRooms array
        function getUpdatedRoomCapacity(roomName) {
            // Find the room in availableRooms array to get the updated capacity
            const room = availableRooms.find(r => {
                // Match room name (handle variations like "HUB (Focus Room)" vs "HUB")
                const cleanRoomName = roomName.replace(/\s*\(.*?\)\s*/g, '').trim();
                const cleanAvailableName = r.name.replace(/\s*\(.*?\)\s*/g, '').trim();
                return cleanRoomName.toLowerCase() === cleanAvailableName.toLowerCase() ||
                       roomName.toLowerCase().includes(cleanAvailableName.toLowerCase()) ||
                       cleanAvailableName.toLowerCase().includes(cleanRoomName.toLowerCase());
            });

            return room ? room.capacity : null;
        }

        // Load Room Display Status
        async function loadRoomDisplayStatus() {
            try {
                console.log('ðŸ”„ [loadRoomDisplayStatus] Loading room display status...');
                console.log('ðŸ”„ [loadRoomDisplayStatus] Display ID:', currentPreviewDisplayId);

                // ISSUE 2 FIX: Fetch the status field from rooms table
                const { data: roomDisplay, error } = await supabaseClient
                    .from('room_displays')
                    .select(`
                        *,
                        rooms (name, capacity, room_type, requires_equipment, status)
                    `)
                    .eq('id', currentPreviewDisplayId)
                    .single();

                if (error) {
                    console.error('âŒ [loadRoomDisplayStatus] Error:', error);
                    throw error;
                }

                console.log('âœ… [loadRoomDisplayStatus] Room display data:', roomDisplay);
                console.log('ðŸ“Š [loadRoomDisplayStatus] Room status from database:', roomDisplay.rooms.status);
                console.log('ðŸ“Š [loadRoomDisplayStatus] Display current_status:', roomDisplay.current_status);

                // ISSUE 2 FIX: Use the status from rooms table (the source of truth)
                // Override current_status with the actual room status from rooms table
                if (roomDisplay.rooms.status) {
                    console.log('ðŸ”„ [loadRoomDisplayStatus] Overriding current_status with rooms.status');
                    console.log('ðŸ”„ [loadRoomDisplayStatus] Old current_status:', roomDisplay.current_status);
                    console.log('ðŸ”„ [loadRoomDisplayStatus] New current_status:', roomDisplay.rooms.status);
                    roomDisplay.current_status = roomDisplay.rooms.status;
                }

                // Update status controls
                document.getElementById('preview-status-select').value = roomDisplay.current_status;
                document.getElementById('preview-status-message').value = roomDisplay.status_message || '';

                console.log('âœ… [loadRoomDisplayStatus] Status controls updated');
                console.log('âœ… [loadRoomDisplayStatus] Dropdown value:', document.getElementById('preview-status-select').value);

                // Override capacity with updated value from availableRooms array
                const updatedCapacity = getUpdatedRoomCapacity(roomDisplay.rooms.name);
                if (updatedCapacity !== null) {
                    roomDisplay.rooms.capacity = updatedCapacity;
                }

                // Store room display data
                window.currentRoomDisplayData = roomDisplay;
                console.log('âœ… [loadRoomDisplayStatus] Room display data stored in window.currentRoomDisplayData');
                console.log('âœ… [loadRoomDisplayStatus] Final current_status:', window.currentRoomDisplayData.current_status);

            } catch (error) {
                console.error('âŒ [loadRoomDisplayStatus] Error loading room display status:', error);
            }
        }

        // Load Preview Content
        async function loadPreviewContent() {
            try {
                const { data: content, error } = await supabaseClient
                    .from('display_content')
                    .select('id, name, content_type')
                    .eq('is_active', true)
                    .order('name');

                if (error) throw error;

                const select = document.getElementById('preview-content-select');
                select.innerHTML = '<option value="">Default display</option>' +
                    content.map(item => `<option value="${item.id}">${item.name} (${item.content_type})</option>`).join('');

            } catch (error) {
                console.error('Error loading preview content:', error);
            }
        }

        // Render Display Preview
        function renderDisplayPreview() {
            console.log('ðŸŽ¨ [renderDisplayPreview] ========== RENDERING DISPLAY ==========');
            const previewContainer = document.getElementById('room-display-preview');
            const mode = document.querySelector('.preview-mode-btn.active')?.dataset.mode || 'live';
            console.log('ðŸŽ¨ [renderDisplayPreview] Display mode:', mode);

            if (mode === 'live') {
                renderLiveStatusDisplay(previewContainer);
            } else if (mode === 'text') {
                renderTextOnlyDisplay(previewContainer);
            } else if (mode === 'image') {
                renderImageModeDisplay(previewContainer);
            }
        }

        // Render Live Status Display (ISSUE 2: Increased font sizes for readability from distance)
        function renderLiveStatusDisplay(container) {
            console.log('ðŸŽ¨ [renderLiveStatusDisplay] Rendering live status display...');
            const roomData = window.currentRoomDisplayData;
            const currentBooking = window.currentBookingData;
            const nextBooking = window.nextBookingData;

            if (!roomData) {
                console.warn('âš ï¸ [renderLiveStatusDisplay] No room data available');
                return;
            }

            console.log('ðŸ“Š [renderLiveStatusDisplay] Room data:', roomData);
            console.log('ðŸ“Š [renderLiveStatusDisplay] Current status:', roomData.current_status);
            console.log('ðŸ“Š [renderLiveStatusDisplay] Room name:', roomData.rooms?.name);

            const statusColors = {
                available: { bg: 'bg-green-600', text: 'text-green-100', border: 'border-green-400' },
                occupied: { bg: 'bg-red-600', text: 'text-red-100', border: 'border-red-400' },
                maintenance: { bg: 'bg-yellow-600', text: 'text-yellow-100', border: 'border-yellow-400' },
                reserved: { bg: 'bg-blue-600', text: 'text-blue-100', border: 'border-blue-400' }
            };

            const statusColor = statusColors[roomData.current_status] || statusColors.available;
            console.log('ðŸŽ¨ [renderLiveStatusDisplay] Status color mapping:', {
                status: roomData.current_status,
                bg: statusColor.bg,
                text: statusColor.text,
                border: statusColor.border
            });

            const currentTime = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const currentDate = new Date().toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            container.innerHTML = `
                <div class="h-full flex flex-col ${statusColor.bg} text-white">
                    <!-- Header - FIXED RESPONSIVE LAYOUT -->
                    <div class="p-4 sm:p-6 md:p-8 border-b ${statusColor.border}">
                        <div class="flex flex-col lg:flex-row lg:justify-between lg:items-center gap-4">
                            <div class="flex-1">
                                <h1 class="text-3xl sm:text-4xl md:text-5xl lg:text-6xl font-bold mb-2 break-words">${roomData.rooms.name}</h1>
                                <p class="text-xl sm:text-2xl md:text-3xl opacity-90">Capacity: ${roomData.rooms.capacity} people</p>
                            </div>
                            <div class="text-left lg:text-right flex-shrink-0">
                                <div class="text-3xl sm:text-4xl md:text-5xl font-bold">${currentTime}</div>
                                <div class="text-lg sm:text-xl md:text-2xl opacity-90">${currentDate}</div>
                            </div>
                        </div>
                    </div>

                    <!-- Status Section - RESPONSIVE FONT SIZES -->
                    <div class="flex-1 flex flex-col justify-center p-4 sm:p-6 md:p-8">
                        <div class="text-center mb-8 md:mb-12">
                            <div class="text-5xl sm:text-6xl md:text-7xl lg:text-8xl xl:text-9xl font-bold mb-4 md:mb-6 py-4 sm:py-6 md:py-8 px-6 sm:px-8 md:px-12 bg-black bg-opacity-30 rounded-2xl md:rounded-3xl inline-block break-words">
                                ${roomData.current_status.toUpperCase()}
                            </div>
                            ${roomData.status_message ? `
                                <div class="text-2xl sm:text-3xl md:text-4xl opacity-90 mt-4 md:mt-6 px-4">${roomData.status_message}</div>
                            ` : ''}
                        </div>

                        <!-- Current Booking - RESPONSIVE LAYOUT -->
                        ${currentBooking?.has_booking ? `
                            <div class="bg-black bg-opacity-20 rounded-xl md:rounded-2xl p-4 sm:p-6 md:p-8 mb-4 md:mb-6">
                                <h3 class="text-2xl sm:text-3xl md:text-4xl font-semibold mb-4 md:mb-6">Current Meeting</h3>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 md:gap-6 text-lg sm:text-xl md:text-2xl">
                                    <div>
                                        <span class="opacity-75">Company:</span>
                                        <div class="font-medium text-xl sm:text-2xl md:text-3xl mt-1 md:mt-2 break-words">${currentBooking.startup_name}</div>
                                    </div>
                                    <div>
                                        <span class="opacity-75">Time:</span>
                                        <div class="font-medium text-xl sm:text-2xl md:text-3xl mt-1 md:mt-2">${currentBooking.start_time} - ${currentBooking.end_time}</div>
                                    </div>
                                    <div>
                                        <span class="opacity-75">Contact:</span>
                                        <div class="font-medium text-xl sm:text-2xl md:text-3xl mt-1 md:mt-2 break-words">${currentBooking.contact_person}</div>
                                    </div>
                                    <div>
                                        <span class="opacity-75">Remaining:</span>
                                        <div class="font-medium text-xl sm:text-2xl md:text-3xl text-yellow-300 mt-1 md:mt-2">
                                            ${Math.floor(currentBooking.remaining_minutes / 60)}h ${Math.floor(currentBooking.remaining_minutes % 60)}m
                                        </div>
                                    </div>
                                </div>
                            </div>
                        ` : ''}

                        <!-- Next Booking - RESPONSIVE LAYOUT -->
                        ${nextBooking?.has_next_booking ? `
                            <div class="bg-black bg-opacity-20 rounded-xl md:rounded-2xl p-4 sm:p-6 md:p-8">
                                <h3 class="text-xl sm:text-2xl md:text-3xl font-semibold mb-4 md:mb-6">Next Meeting</h3>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 md:gap-6 text-lg sm:text-xl md:text-2xl">
                                    <div>
                                        <span class="opacity-75">Company:</span>
                                        <div class="font-medium text-xl sm:text-2xl md:text-3xl mt-1 md:mt-2 break-words">${nextBooking.startup_name}</div>
                                    </div>
                                    <div>
                                        <span class="opacity-75">Time:</span>
                                        <div class="font-medium text-xl sm:text-2xl md:text-3xl mt-1 md:mt-2">${nextBooking.start_time} - ${nextBooking.end_time}</div>
                                    </div>
                                    <div class="sm:col-span-2">
                                        <span class="opacity-75">Starts in:</span>
                                        <div class="font-medium text-xl sm:text-2xl md:text-3xl text-blue-300 mt-1 md:mt-2">
                                            ${Math.floor(nextBooking.minutes_until_start / 60)}h ${Math.floor(nextBooking.minutes_until_start % 60)}m
                                        </div>
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                    </div>

                    <!-- Footer - RESPONSIVE FONT SIZE -->
                    <div class="p-4 sm:p-5 md:p-6 border-t ${statusColor.border} text-center">
                        <div class="text-base sm:text-lg md:text-xl lg:text-2xl opacity-75">
                            National Incubation Center â€¢ Room Display System
                        </div>
                    </div>
                </div>
            `;

            console.log('âœ… [renderLiveStatusDisplay] Display rendered successfully');
            console.log('âœ… [renderLiveStatusDisplay] Displayed status:', roomData.current_status.toUpperCase());
            console.log('âœ… [renderLiveStatusDisplay] Background color:', statusColor.bg);
        }

        // Render Text Only Display
        function renderTextOnlyDisplay(container) {
            const roomData = window.currentRoomDisplayData;
            if (!roomData) return;

            container.innerHTML = `
                <div class="h-full flex flex-col justify-center items-center bg-gray-800 text-white p-8">
                    <h1 class="text-4xl font-bold mb-4">${roomData.rooms.name}</h1>
                    <div class="text-2xl mb-8 text-center">
                        Status: <span class="font-bold text-green-400">${roomData.current_status.toUpperCase()}</span>
                    </div>
                    ${roomData.status_message ? `
                        <div class="text-lg text-center opacity-90">${roomData.status_message}</div>
                    ` : ''}
                    <div class="mt-8 text-sm opacity-75 text-center">
                        Capacity: ${roomData.rooms.capacity} people<br>
                        Type: ${roomData.rooms.room_type}
                    </div>
                </div>
            `;
        }

        // Render Image Mode Display
        function renderImageModeDisplay(container) {
            const roomData = window.currentRoomDisplayData;
            if (!roomData) return;

            container.innerHTML = `
                <div class="h-full flex flex-col bg-gradient-to-br from-blue-900 to-purple-900 text-white">
                    <div class="flex-1 flex items-center justify-center p-8">
                        <div class="text-center">
                            <div class="w-32 h-32 bg-white bg-opacity-20 rounded-full flex items-center justify-center mb-6 mx-auto">
                                <svg class="w-16 h-16" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                            <h1 class="text-3xl font-bold mb-4">${roomData.rooms.name}</h1>
                            <div class="text-xl opacity-90">Image content would display here</div>
                        </div>
                    </div>
                    <div class="p-4 bg-black bg-opacity-30 text-center">
                        <div class="text-sm opacity-75">Image Mode Preview</div>
                    </div>
                </div>
            `;
        }

        // Preview Mode Controls
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('preview-mode-btn')) {
                // Update active button
                document.querySelectorAll('.preview-mode-btn').forEach(btn => {
                    btn.classList.remove('active', 'bg-blue-600', 'text-white');
                    btn.classList.add('bg-gray-200', 'text-gray-700');
                });

                e.target.classList.remove('bg-gray-200', 'text-gray-700');
                e.target.classList.add('active', 'bg-blue-600', 'text-white');

                // Re-render display with new mode
                renderDisplayPreview();
            }
        });

        // ISSUE 2 FIX: Update Status Button in Preview Modal - Enhanced Logging
        document.getElementById('update-preview-status')?.addEventListener('click', async () => {
            console.log('ðŸŽ¯ [update-preview-status] ========== BUTTON CLICKED ==========');

            const newStatus = document.getElementById('preview-status-select').value;
            const statusMessage = document.getElementById('preview-status-message').value;

            try {
                console.log('ðŸ”„ [update-preview-status] Starting status update...');
                console.log('ðŸ”„ [update-preview-status] Current Preview Room:', currentPreviewRoom);
                console.log('ðŸ”„ [update-preview-status] Current Preview Display ID:', currentPreviewDisplayId);
                console.log('ðŸ”„ [update-preview-status] Selected Status:', newStatus);
                console.log('ðŸ”„ [update-preview-status] Status Message:', statusMessage || '(none)');

                // ISSUE 1 FIX: Update room status directly instead of using RPC function
                // First, get the room ID from the room name
                const { data: roomData, error: roomError } = await supabaseClient
                    .from('rooms')
                    .select('id')
                    .eq('name', currentPreviewRoom)
                    .single();

                if (roomError) {
                    console.error('âŒ [update-preview-status] Error fetching room:', roomError);
                    throw roomError;
                }

                console.log('âœ… [update-preview-status] Room ID:', roomData.id);

                // Update room status in rooms table
                const { data: updateData, error: updateError } = await supabaseClient
                    .from('rooms')
                    .update({
                        status: newStatus,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', roomData.id)
                    .select();

                if (updateError) {
                    console.error('âŒ [update-preview-status] Error updating room:', updateError);
                    console.error('âŒ [update-preview-status] Error details:', {
                        message: updateError.message,
                        details: updateError.details,
                        hint: updateError.hint,
                        code: updateError.code
                    });
                    throw updateError;
                }

                console.log('âœ… [update-preview-status] Room status updated:', updateData);

                // Update room_displays table if status message is provided
                if (statusMessage) {
                    const { error: displayError } = await supabaseClient
                        .from('room_displays')
                        .update({
                            status_message: statusMessage,
                            last_updated: new Date().toISOString()
                        })
                        .eq('id', currentPreviewDisplayId);

                    if (displayError) {
                        console.warn('âš ï¸ [update-preview-status] Error updating display message:', displayError);
                    } else {
                        console.log('âœ… [update-preview-status] Display message updated');
                    }
                }

                showNotification('Room status updated successfully', 'success');

                // Refresh preview data
                console.log('ðŸ”„ [update-preview-status] Refreshing preview data...');
                await loadRoomDisplayStatus();
                renderDisplayPreview();

                // Refresh main room displays if visible
                if (!document.getElementById('room-status-tab').classList.contains('hidden')) {
                    console.log('ðŸ”„ [update-preview-status] Refreshing main room displays...');
                    loadRoomStatusDisplays();
                }

            } catch (error) {
                console.error('âŒ [update-preview-status] ========== ERROR OCCURRED ==========');
                console.error('âŒ [update-preview-status] Error Type:', error.constructor.name);
                console.error('âŒ [update-preview-status] Error Message:', error.message);
                console.error('âŒ [update-preview-status] Full Error:', error);
                console.error('âŒ [update-preview-status] Stack Trace:', error.stack);
                showNotification('Error updating room status: ' + error.message, 'error');
            }
        });

        // Refresh Preview Button
        document.getElementById('refresh-preview-btn')?.addEventListener('click', async () => {
            await loadRoomPreviewData();
        });

        // Fullscreen state tracking
        let isFullscreenLocked = false;
        let fullscreenElement = null;

        // Fullscreen Preview Button
        document.getElementById('fullscreen-preview-btn')?.addEventListener('click', async () => {
            const previewContainer = document.getElementById('room-display-preview');
            fullscreenElement = previewContainer;

            try {
                if (previewContainer.requestFullscreen) {
                    await previewContainer.requestFullscreen();
                } else if (previewContainer.webkitRequestFullscreen) {
                    await previewContainer.webkitRequestFullscreen();
                } else if (previewContainer.msRequestFullscreen) {
                    await previewContainer.msRequestFullscreen();
                }

                // Lock the fullscreen after entering
                isFullscreenLocked = true;
                showMessage('Display is now in fullscreen mode. Password required to exit.', 'info');
            } catch (error) {
                console.error('Error entering fullscreen:', error);
                showMessage('Failed to enter fullscreen mode.', 'error');
            }
        });

        // Monitor fullscreen changes and enforce password lock
        document.addEventListener('fullscreenchange', handleFullscreenChange);
        document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
        document.addEventListener('mozfullscreenchange', handleFullscreenChange);
        document.addEventListener('MSFullscreenChange', handleFullscreenChange);

        async function handleFullscreenChange() {
            const isCurrentlyFullscreen = !!(
                document.fullscreenElement ||
                document.webkitFullscreenElement ||
                document.mozFullScreenElement ||
                document.msFullscreenElement
            );

            // If we were in locked fullscreen and user is trying to exit
            if (isFullscreenLocked && !isCurrentlyFullscreen) {
                console.log('ðŸ”’ FULLSCREEN EXIT DETECTED - Verifying password...');

                // IMMEDIATELY re-enter fullscreen BEFORE asking for password
                // This prevents the display from staying unlocked while password prompt is shown
                const reEnterFullscreen = async () => {
                    try {
                        if (fullscreenElement) {
                            console.log('âš¡ Re-entering fullscreen mode immediately...');

                            if (fullscreenElement.requestFullscreen) {
                                await fullscreenElement.requestFullscreen();
                            } else if (fullscreenElement.webkitRequestFullscreen) {
                                await fullscreenElement.webkitRequestFullscreen();
                            } else if (fullscreenElement.mozRequestFullscreen) {
                                await fullscreenElement.mozRequestFullscreen();
                            } else if (fullscreenElement.msRequestFullscreen) {
                                await fullscreenElement.msRequestFullscreen();
                            }

                            console.log('âœ… Fullscreen re-entered successfully');
                        }
                    } catch (error) {
                        console.error('âŒ Error re-entering fullscreen:', error);
                    }
                };

                // Re-enter fullscreen immediately (don't wait)
                await reEnterFullscreen();

                // Now ask for password
                const passwordVerified = await verifyAdminPasswordForExit();

                if (!passwordVerified) {
                    console.log('âŒ Password verification FAILED - Display remains locked');
                    showMessage('Incorrect password. Display remains locked.', 'error');

                    // Make sure we're still in fullscreen (re-enter again if needed)
                    setTimeout(async () => {
                        const stillFullscreen = !!(
                            document.fullscreenElement ||
                            document.webkitFullscreenElement ||
                            document.mozFullScreenElement ||
                            document.msFullscreenElement
                        );

                        if (!stillFullscreen && isFullscreenLocked) {
                            console.log('âš ï¸ Not in fullscreen - re-entering again...');
                            await reEnterFullscreen();
                        }
                    }, 100);
                } else {
                    console.log('âœ… Password verified - Allowing fullscreen exit');
                    // Password verified, allow exit
                    isFullscreenLocked = false;
                    fullscreenElement = null;

                    // Exit fullscreen
                    try {
                        if (document.exitFullscreen) {
                            await document.exitFullscreen();
                        } else if (document.webkitExitFullscreen) {
                            await document.webkitExitFullscreen();
                        } else if (document.mozCancelFullScreen) {
                            await document.mozCancelFullScreen();
                        } else if (document.msExitFullscreen) {
                            await document.msExitFullscreen();
                        }
                    } catch (error) {
                        console.error('Error exiting fullscreen:', error);
                    }
                }
            }
        }

        async function verifyAdminPasswordForExit() {
            // ALL users (including admins) must enter password to exit fullscreen
            // This prevents tampering with physical display screens even if admin session is left logged in

            const password = prompt(
                'ðŸ”’ DISPLAY LOCKED\n\n' +
                'This room display is password protected.\n' +
                'Enter the admin password to exit fullscreen mode:'
            );

            if (!password) {
                showMessage('Password required to exit fullscreen mode.', 'error');
                return false;
            }

            // Verify password using server-side function (does NOT sign in or change session)
            try {
                console.log('Verifying admin password...');

                const { data, error } = await supabaseClient.rpc('verify_admin_password', {
                    password_input: password
                });

                if (error) {
                    console.error('Password verification error:', error);
                    showMessage('Password verification failed. Access denied.', 'error');
                    return false;
                }

                // Check if password is correct
                if (data === true) {
                    console.log('Password verified successfully');
                    showMessage('Password verified. Exiting fullscreen mode.', 'success');
                    return true;
                } else {
                    console.log('Incorrect password entered');
                    showMessage('Incorrect password. Access denied.', 'error');
                    return false;
                }
            } catch (err) {
                console.error('Password verification error:', err);
                showMessage('Password verification failed. Access denied.', 'error');
                return false;
            }
        }

        // Prevent ESC key from exiting fullscreen when locked (ISSUE 1: Fixed password protection)
        document.addEventListener('keydown', async (e) => {
            if (isFullscreenLocked && e.key === 'Escape') {
                console.log('ðŸ”’ ESC key pressed - Display is locked');
                e.preventDefault();
                e.stopPropagation();
                e.stopImmediatePropagation();

                // Verify password
                const passwordVerified = await verifyAdminPasswordForExit();

                if (passwordVerified) {
                    console.log('âœ… Password correct - Exiting fullscreen');
                    isFullscreenLocked = false;
                    fullscreenElement = null;

                    // Exit fullscreen
                    try {
                        if (document.exitFullscreen) {
                            await document.exitFullscreen();
                        } else if (document.webkitExitFullscreen) {
                            await document.webkitExitFullscreen();
                        } else if (document.mozCancelFullScreen) {
                            await document.mozCancelFullScreen();
                        } else if (document.msExitFullscreen) {
                            await document.msExitFullscreen();
                        }
                    } catch (error) {
                        console.error('Error exiting fullscreen:', error);
                    }
                } else {
                    console.log('âŒ Password incorrect - Staying in fullscreen');

                    // Make absolutely sure we're still in fullscreen
                    const isCurrentlyFullscreen = !!(
                        document.fullscreenElement ||
                        document.webkitFullscreenElement ||
                        document.mozFullScreenElement ||
                        document.msFullscreenElement
                    );

                    if (!isCurrentlyFullscreen && fullscreenElement) {
                        console.log('âš ï¸ Not in fullscreen - Re-entering immediately...');
                        try {
                            if (fullscreenElement.requestFullscreen) {
                                await fullscreenElement.requestFullscreen();
                            } else if (fullscreenElement.webkitRequestFullscreen) {
                                await fullscreenElement.webkitRequestFullscreen();
                            } else if (fullscreenElement.mozRequestFullscreen) {
                                await fullscreenElement.mozRequestFullscreen();
                            } else if (fullscreenElement.msRequestFullscreen) {
                                await fullscreenElement.msRequestFullscreen();
                            }
                        } catch (error) {
                            console.error('Error re-entering fullscreen:', error);
                        }
                    }
                }
            }
        }, true);

        // Preview Content Button
        document.getElementById('preview-content-btn')?.addEventListener('click', async () => {
            const contentId = document.getElementById('preview-content-select').value;

            if (!contentId) {
                renderDisplayPreview();
                return;
            }

            try {
                const { data: content, error } = await supabaseClient
                    .from('display_content')
                    .select('*')
                    .eq('id', contentId)
                    .single();

                if (error) throw error;

                // Render content preview
                renderContentPreview(content);

            } catch (error) {
                console.error('Error loading content for preview:', error);
                showNotification('Error loading content preview', 'error');
            }
        });

        // Render Content Preview
        function renderContentPreview(content) {
            const container = document.getElementById('room-display-preview');

            if (content.content_type === 'image' && content.file_url) {
                container.innerHTML = `
                    <div class="h-full flex items-center justify-center bg-black">
                        <img src="${content.file_url}" alt="${content.name}" class="max-w-full max-h-full object-contain">
                    </div>
                `;
            } else if (content.content_type === 'video' && content.file_url) {
                container.innerHTML = `
                    <div class="h-full flex items-center justify-center bg-black">
                        <video src="${content.file_url}" class="max-w-full max-h-full object-contain" controls autoplay muted loop>
                            Your browser does not support the video tag.
                        </video>
                    </div>
                `;
            } else if (content.text_content) {
                container.innerHTML = `
                    <div class="h-full flex flex-col justify-center items-center bg-gradient-to-br from-gray-800 to-gray-900 text-white p-8">
                        <h2 class="text-3xl font-bold mb-6 text-center">${content.name}</h2>
                        <div class="text-lg text-center leading-relaxed max-w-2xl">
                            ${content.text_content.replace(/\n/g, '<br>')}
                        </div>
                        <div class="mt-8 text-sm opacity-75">
                            ${content.content_type === 'announcement' ? 'Announcement' : 'Information'}
                        </div>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div class="h-full flex items-center justify-center bg-gray-800 text-white">
                        <div class="text-center">
                            <div class="text-2xl mb-4">ðŸ“„</div>
                            <div class="text-lg">${content.name}</div>
                            <div class="text-sm opacity-75 mt-2">${content.content_type}</div>
                        </div>
                    </div>
                `;
            }
        }

        // Auto-refresh functions
        function startPreviewAutoRefresh() {
            // Refresh every 30 seconds
            previewUpdateInterval = setInterval(async () => {
                if (currentPreviewRoom) {
                    await loadCurrentBooking();
                    await loadNextBooking();

                    // Only re-render if in live mode
                    const activeMode = document.querySelector('.preview-mode-btn.active')?.dataset.mode;
                    if (activeMode === 'live') {
                        renderDisplayPreview();
                    }
                }
            }, 30000);
        }

        function stopPreviewAutoRefresh() {
            if (previewUpdateInterval) {
                clearInterval(previewUpdateInterval);
                previewUpdateInterval = null;
            }
        }

        // Close modal when clicking outside (with password protection)
        document.getElementById('room-preview-modal')?.addEventListener('click', async (e) => {
            if (e.target.id === 'room-preview-modal') {
                await closeRoomPreview();
            }
        });

        // ===== MOBILE RESPONSIVENESS =====

        // Mobile sidebar functionality
        function initializeMobileSidebar() {
            const sidebarToggle = document.getElementById('sidebar-toggle');
            const sidebar = document.getElementById('sidebar');
            let sidebarOverlay = null;

            if (sidebarToggle) {
                sidebarToggle.addEventListener('click', () => {
                    toggleMobileSidebar();
                });
            }
            const sidebarFab = document.getElementById('sidebar-fab');
            if (sidebarFab) {
                sidebarFab.addEventListener('click', () => toggleMobileSidebar());
            }

            function toggleMobileSidebar() {
                if (window.innerWidth <= 768) {
                    const isOpen = sidebar.classList.contains('mobile-open');

                    if (isOpen) {
                        closeMobileSidebar();
                    } else {
                        openMobileSidebar();
                    }
                }
            }

            function openMobileSidebar() {
                // Create overlay
                sidebarOverlay = document.createElement('div');
                sidebarOverlay.className = 'sidebar-overlay';
                sidebarOverlay.addEventListener('click', closeMobileSidebar);
                document.body.appendChild(sidebarOverlay);

                // Open sidebar
                sidebar.classList.add('mobile-open');
                document.body.style.overflow = 'hidden';
            }

            function closeMobileSidebar() {
                // Remove overlay
                if (sidebarOverlay) {
                    sidebarOverlay.remove();
                    sidebarOverlay = null;
                }

                // Close sidebar
                sidebar.classList.remove('mobile-open');
                document.body.style.overflow = '';
            }

            // Close sidebar when clicking nav links on mobile
            const navLinks = sidebar.querySelectorAll('a[href^="#"]');
            navLinks.forEach(link => {
                link.addEventListener('click', () => {
                    if (window.innerWidth <= 768) {
                        setTimeout(closeMobileSidebar, 100);
                    }
                });
            });

            // Handle window resize
            window.addEventListener('resize', () => {
                if (window.innerWidth > 768) {
                    closeMobileSidebar();
                }
            });
        }

        // Make modals mobile-friendly
        function makeMobileResponsive() {
            // Add mobile classes to existing modals
            const modals = document.querySelectorAll('.fixed.inset-0');
            modals.forEach(modal => {
                const modalContent = modal.querySelector('.bg-white');
                if (modalContent && !modalContent.classList.contains('modal-mobile')) {
                    modalContent.classList.add('modal-mobile');
                }
            });

            // Add mobile classes to form inputs
            const inputs = document.querySelectorAll('input[type="text"], input[type="email"], input[type="tel"], input[type="date"], input[type="time"], select, textarea');
            inputs.forEach(input => {
                if (!input.classList.contains('form-input-mobile')) {
                    input.classList.add('form-input-mobile');
                }
            });

            // Add mobile classes to buttons
            const buttons = document.querySelectorAll('button');
            buttons.forEach(button => {
                if (!button.classList.contains('btn-mobile')) {
                    button.classList.add('btn-mobile');
                }
            });

            // Add mobile classes to tables
            const tables = document.querySelectorAll('table');
            tables.forEach(table => {
                if (!table.classList.contains('table-mobile')) {
                    table.classList.add('table-mobile');
                }
            });

            // Add mobile classes to cards
            const cards = document.querySelectorAll('.bg-white.rounded-lg, .bg-white.rounded-xl');
            cards.forEach(card => {
                if (!card.classList.contains('card-mobile')) {
                    card.classList.add('card-mobile');
                }
            });
        }

        // ===== DEBUGGING UTILITY =====

        /**
         * Comprehensive system health check
         * Run this in the browser console: await checkSystemHealth()
         */
        window.checkSystemHealth = async function() {
            console.log('ðŸ¥ ===== SYSTEM HEALTH CHECK =====\n');

            const results = {
                session: false,
                realtimeSubscriptions: false,
                dashboardRefresh: false,
                healthChecks: false,
                dataAccess: { users: false, startups: false, bookings: false, rooms: false }
            };

            // 1. Check session
            console.log('1ï¸âƒ£ SESSION VALIDATION:');
            const session = await validateSession();
            if (session) {
                console.log('   âœ… Session valid - User:', session.user.email);
                results.session = true;
            } else {
                console.log('   âŒ Session invalid or expired');
            }

            // 2. Check real-time subscriptions
            console.log('\n2ï¸âƒ£ REAL-TIME SUBSCRIPTIONS:');
            const channels = [
                { name: 'users', channel: usersChannel },
                { name: 'startups', channel: startupsChannel },
                { name: 'bookings', channel: bookingsChannel },
                { name: 'rooms', channel: roomsChannel }
            ];

            let allSubscribed = true;
            for (const { name, channel } of channels) {
                if (channel && channel.state === 'joined') {
                    console.log(`   âœ… ${name}: SUBSCRIBED`);
                } else {
                    console.log(`   âŒ ${name}: ${channel ? channel.state : 'NULL'}`);
                    allSubscribed = false;
                }
            }
            results.realtimeSubscriptions = allSubscribed;

            // 3. Check periodic systems
            console.log('\n3ï¸âƒ£ PERIODIC SYSTEMS:');
            console.log(`   ${dashboardRefreshInterval ? 'âœ…' : 'âŒ'} Dashboard auto-refresh`);
            console.log(`   ${healthCheckInterval ? 'âœ…' : 'âŒ'} Health checks`);
            results.dashboardRefresh = !!dashboardRefreshInterval;
            results.healthChecks = !!healthCheckInterval;

            // 4. Test database access
            console.log('\n4ï¸âƒ£ DATABASE ACCESS:');
            for (const table of ['users', 'startups', 'bookings', 'rooms']) {
                try {
                    const { error } = await supabaseClient.from(table).select('id').limit(1);
                    if (!error) {
                        console.log(`   âœ… ${table} table: ACCESSIBLE`);
                        results.dataAccess[table] = true;
                    } else {
                        console.log(`   âŒ ${table} table:`, error.message);
                    }
                } catch (err) {
                    console.log(`   âŒ ${table} table:`, err.message);
                }
            }

            // Summary
            console.log('\nðŸ“Š SUMMARY:');
            const allHealthy = results.session && results.realtimeSubscriptions &&
                              results.dashboardRefresh && results.healthChecks &&
                              Object.values(results.dataAccess).every(v => v);

            console.log(allHealthy ? '   âœ… ALL SYSTEMS OPERATIONAL' : '   âš ï¸ SOME SYSTEMS NEED ATTENTION');

            if (!allHealthy) {
                console.log('\nðŸ”§ RECOMMENDATIONS:');
                if (!results.session) console.log('   - Refresh page or log in again');
                if (!results.realtimeSubscriptions) console.log('   - Run: setupRealtimeSubscriptions()');
                if (!results.dashboardRefresh) console.log('   - Run: startDashboardAutoRefresh()');
                if (!results.healthChecks) console.log('   - Run: startRealtimeHealthChecks()');
            }

            return results;
        };

        /**
         * Comprehensive debugging function to diagnose data loading issues
         * Run this in the browser console: await debugDataLoading()
         */
        window.debugDataLoading = async function() {
            console.log('ðŸ” ===== COMPREHENSIVE DATA LOADING DEBUG =====');

            // 1. Check authentication
            console.log('\nðŸ“‹ 1. AUTHENTICATION STATUS:');
            const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();
            console.log('   Session:', session);
            console.log('   Session Error:', sessionError);
            console.log('   User ID:', session?.user?.id);
            console.log('   User Email:', session?.user?.email);

            // 2. Check currentUser global variable
            console.log('\nðŸ“‹ 2. CURRENT USER GLOBAL VARIABLE:');
            console.log('   currentUser:', currentUser);
            console.log('   currentUser.role:', currentUser?.role);
            console.log('   currentUser.name:', currentUser?.name);
            console.log('   currentUser.email:', currentUser?.email);

            // 3. Test users table query
            console.log('\nðŸ“‹ 3. USERS TABLE QUERY TEST:');
            try {
                const { data: userData, error: userError } = await supabaseClient
                    .from('users')
                    .select('*')
                    .eq('id', session?.user?.id)
                    .maybeSingle();
                console.log('   Users Query Data:', userData);
                console.log('   Users Query Error:', userError);
            } catch (err) {
                console.error('   Users Query Exception:', err);
            }

            // 4. Test startups table query
            console.log('\nðŸ“‹ 4. STARTUPS TABLE QUERY TEST:');
            try {
                const { data: startupsData, error: startupsError } = await supabaseClient
                    .from('startups')
                    .select('id, name');
                console.log('   Startups Query Data:', startupsData);
                console.log('   Startups Query Error:', startupsError);
                console.log('   Startups Count:', startupsData?.length || 0);
            } catch (err) {
                console.error('   Startups Query Exception:', err);
            }

            // 5. Test bookings table query
            console.log('\nðŸ“‹ 5. BOOKINGS TABLE QUERY TEST:');
            try {
                const { data: bookingsData, error: bookingsError } = await supabaseClient
                    .from('bookings')
                    .select('*', { count: 'exact' });
                console.log('   Bookings Query Data:', bookingsData);
                console.log('   Bookings Query Error:', bookingsError);
                console.log('   Bookings Count:', bookingsData?.length || 0);
            } catch (err) {
                console.error('   Bookings Query Exception:', err);
            }

            // 6. Test rooms table query
            console.log('\nðŸ“‹ 6. ROOMS TABLE QUERY TEST:');
            try {
                const { data: roomsData, error: roomsError } = await supabaseClient
                    .from('rooms')
                    .select('*');
                console.log('   Rooms Query Data:', roomsData);
                console.log('   Rooms Query Error:', roomsError);
                console.log('   Rooms Count:', roomsData?.length || 0);
            } catch (err) {
                console.error('   Rooms Query Exception:', err);
            }

            // 7. Check UI elements
            console.log('\nðŸ“‹ 7. UI ELEMENTS CHECK:');
            console.log('   user-name element:', document.getElementById('user-name'));
            console.log('   header-user-name element:', document.getElementById('header-user-name'));
            console.log('   user-role element:', document.getElementById('user-role'));
            console.log('   today-schedule element:', document.getElementById('today-schedule'));
            console.log('   Admin-only elements count:', document.querySelectorAll('[data-admin-only]').length);

            // 8. Check real-time subscriptions
            console.log('\nðŸ“‹ 8. REAL-TIME SUBSCRIPTIONS:');
            console.log('   usersChannel:', usersChannel);
            console.log('   startupsChannel:', startupsChannel);
            console.log('   bookingsChannel:', bookingsChannel);
            console.log('   roomsChannel:', roomsChannel);

            console.log('\nâœ… ===== DEBUG COMPLETE =====');
            console.log('Please share this output with support for diagnosis.');
        };

        console.log('ðŸ’¡ TIP: Run "await debugDataLoading()" in the console to diagnose data loading issues');

        // ===== VERSION DETECTION & AUTO-RELOAD SYSTEM =====
        /**
         * Detects when a new version of the app is deployed and prompts user to reload.
         * Uses both the app version and the build timestamp to uniquely identify a build.
         */
        const APP_VERSION = '2.0.0';
        const VERSION_CHECK_INTERVAL = 5 * 60 * 1000; // Check every 5 minutes

        // Get current version from meta tag
        function getCurrentVersion() {
            const metaTag = document.querySelector('meta[name="app-version"]');
            return metaTag ? metaTag.content : APP_VERSION;
        }

        // Get a stable build identifier (version + build timestamp)
        function getCurrentBuildId() {
            const version = getCurrentVersion();
            const metaTimestamp = document.querySelector('meta[name="build-timestamp"]');
            const timestamp = metaTimestamp ? metaTimestamp.content : 'dev';
            return `${version}::${timestamp}`;
        }

        // Check if a new version is available
        async function checkForNewVersion() {
            try {
                // Fetch the HTML with cache-busting timestamp
                const response = await fetch(`/index.html?t=${Date.now()}`, {
                    method: 'GET',
                    cache: 'no-cache',
                    headers: {
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache'
                    }
                });

                if (!response.ok) {
                    console.warn('âš ï¸ [Version Check] Failed to fetch latest version');
                    return;
                }

                const html = await response.text();

                // Extract version and build timestamp from the fetched HTML
                const versionMatch = html.match(/<meta name="app-version" content="([^"]+)">/);
                const timestampMatch = html.match(/<meta name="build-timestamp" content="([^"]+)">/);

                const latestVersion = versionMatch ? versionMatch[1] : null;
                const latestTimestamp = timestampMatch ? timestampMatch[1] : null;
                const latestBuildId = latestVersion && latestTimestamp
                    ? `${latestVersion}::${latestTimestamp}`
                    : latestVersion;

                const currentBuildId = getCurrentBuildId();

                console.log('ðŸ” [Version Check] Current build ID:', currentBuildId, '| Latest build ID:', latestBuildId);

                if (latestBuildId && latestBuildId !== currentBuildId) {
                    console.log('ðŸ†• [Version Check] New version available!');
                    showNewVersionNotification(getCurrentVersion(), latestVersion || 'unknown');
                }
            } catch (error) {
                console.error('âŒ [Version Check] Error:', error);
            }
        }

        // Show notification when new version is available
        function showNewVersionNotification(currentVersion, newVersion) {
            // Create notification element
            const notification = document.createElement('div');
            notification.id = 'version-notification';
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 20px 24px;
                border-radius: 12px;
                box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
                z-index: 10000;
                max-width: 400px;
                animation: slideIn 0.3s ease-out;
            `;

            notification.innerHTML = `
                <div style="display: flex; align-items: start; gap: 12px;">
                    <div style="flex-shrink: 0; font-size: 24px;">ðŸš€</div>
                    <div style="flex: 1;">
                        <div style="font-weight: 700; font-size: 16px; margin-bottom: 8px;">
                            New Version Available!
                        </div>
                        <div style="font-size: 14px; opacity: 0.9; margin-bottom: 12px;">
                            Version ${newVersion} is now available. Please reload to get the latest features and fixes.
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button onclick="location.reload(true)" style="
                                background: white;
                                color: #667eea;
                                border: none;
                                padding: 8px 16px;
                                border-radius: 6px;
                                font-weight: 600;
                                cursor: pointer;
                                font-size: 14px;
                            ">
                                Reload Now
                            </button>
                            <button onclick="document.getElementById('version-notification').remove()" style="
                                background: rgba(255, 255, 255, 0.2);
                                color: white;
                                border: none;
                                padding: 8px 16px;
                                border-radius: 6px;
                                font-weight: 600;
                                cursor: pointer;
                                font-size: 14px;
                            ">
                                Later
                            </button>
                        </div>
                    </div>
                </div>
            `;

            // Add animation
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from {
                        transform: translateX(400px);
                        opacity: 0;
                    }
                    to {
                        transform: translateX(0);
                        opacity: 1;
                    }
                }
            `;
            document.head.appendChild(style);

            document.body.appendChild(notification);

            // Auto-reload after 30 seconds if user doesn't respond
            setTimeout(() => {
                if (document.getElementById('version-notification')) {
                    console.log('ðŸ”„ [Version Check] Auto-reloading to new version...');
                    location.reload(true);
                }
            }, 30000);
        }

        // Clear any service worker caches (if they exist)
        async function clearServiceWorkerCaches() {
            if ('serviceWorker' in navigator) {
                try {
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    for (const registration of registrations) {
                        await registration.unregister();
                        console.log('âœ… [Cache] Service worker unregistered');
                    }
                } catch (error) {
                    console.warn('âš ï¸ [Cache] Could not unregister service workers:', error);
                }
            }

            if ('caches' in window) {
                try {
                    const cacheNames = await caches.keys();
                    for (const cacheName of cacheNames) {
                        await caches.delete(cacheName);
                        console.log('âœ… [Cache] Deleted cache:', cacheName);
                    }
                } catch (error) {
                    console.warn('âš ï¸ [Cache] Could not clear caches:', error);
                }
            }
        }

        // Initialize version checking
        console.log('ðŸ” [Version Check] Current version:', getCurrentVersion());
        console.log('ðŸ” [Version Check] Starting periodic version checks...');

        // Clear service worker caches on load
        clearServiceWorkerCaches();

        // Check for new version immediately
        setTimeout(checkForNewVersion, 5000); // Wait 5 seconds after load

        // Check periodically
        setInterval(checkForNewVersion, VERSION_CHECK_INTERVAL);

        // Enhanced visibility change handler - refresh data and check for updates
        let hiddenTime = null;
        document.addEventListener('visibilitychange', async () => {
            if (document.hidden) {
                hiddenTime = Date.now();
                console.log('ðŸ‘ï¸ [Visibility] Page hidden at:', new Date(hiddenTime).toLocaleTimeString());
            } else {
                const timeHidden = hiddenTime ? Date.now() - hiddenTime : 0;
                console.log('ðŸ‘ï¸ [Visibility] Page visible again. Was hidden for:', Math.round(timeHidden / 1000), 'seconds');

                // If page was hidden for more than 2 minutes, refresh data
                if (hiddenTime && timeHidden > 2 * 60 * 1000) {
                    console.log('ðŸ”„ [Visibility] Page was hidden for >2 minutes, refreshing data...');

                    // Validate session
                    const session = await validateSession();
                    if (!session) {
                        console.warn('âš ï¸ [Visibility] Invalid session, redirecting to login');
                        showAuth('login');
                        return;
                    }

                    // Reconnect real-time subscriptions
                    console.log('ðŸ”„ [Visibility] Reconnecting real-time subscriptions...');
                    setupRealtimeSubscriptions();

                    // Refresh current page data
                    const currentPage = window.location.hash;
                    console.log('ðŸ”„ [Visibility] Refreshing current page:', currentPage);

                    if (currentPage === '#dashboard' || currentPage === '' || currentPage === '#') {
                        await loadDashboardData();
                    } else if (currentPage === '#bookings') {
                        await loadBookingsData();
                    } else if (currentPage === '#startups') {
                        await loadStartupsData();
                    } else if (currentPage === '#rooms') {
                        await loadRoomsData();
                    }

                    console.log('âœ… [Visibility] Data refreshed successfully');
                }

                // If page was hidden for more than 10 minutes, check for version updates
                if (hiddenTime && timeHidden > 10 * 60 * 1000) {
                    console.log('ðŸ”„ [Version Check] Page was hidden for >10 minutes, checking for updates...');
                    checkForNewVersion();
                }

                hiddenTime = null;
            }
        });

        // Initialize the application
        handleAuthState();

        // Initialize mobile functionality
        document.addEventListener('DOMContentLoaded', () => {
            initializeMobileSidebar();
            makeMobileResponsive();
        });

        // Add to existing page show function
        const originalShowPage = window.showPage;
        window.showPage = function(hash) {
            originalShowPage(hash);
            if (hash === '#room-displays') {
                setTimeout(initializeRoomDisplays, 100);
            }
            // Ensure mobile responsiveness after page changes
            setTimeout(makeMobileResponsive, 100);
        };
    </script>
</body>
</html>